define("themes.js",[],function(){(function(){var t=window,r=t.jQuery,n;if(!t.$theme){n=t.$theme=new Function,n.maxLinks=$Config.Themes.numberOfThemes,n.thumbnail=function(t){function e(){var e=r(t),f,c,n;e.bind("focus",u),e.bind("mouseover",u),e.bind("click",s),$menu.disableThumbs?o():(c=h(),c?(n=new Image,n.className="thumb",n.alt=t.title,n.src=c,f=r(n)):i[2]&&(f=r("<div><\/div>").css({backgroundColor:i[2],width:"100%",height:"100%"}).attr("title",t.title)),f.attr("thov","2"),f.appendTo(t))}function o(){t.style.backgroundColor=i[4]}function s(){n.previewTheme(i,!0,t)}function u(){n.canApplyPreview(f)&&(n.previewTheme(i),$css.add(t,"t_hov"))}function h(){return i[1]}var f=this,i=t.getAttribute("info").split("|");this.themeinfo=i,f.preview=u,e()},n.keys=[],n.previewActivationDelay=500,"undefined"==typeof n.previewTheme&&(n.previewTheme=function(u,f,e){function tt(t){for(var u=n.previewLinks,f=n.maxLinks,i=0;i<u.length-f;i++)r(u[i]).remove();for(n.previewLinks.length>f&&(n.previewLinks=u=n.previewLinks.splice(u.length-f,f)),i=u.length-1;i>=0;i--)u[i].disabled=u[i].id!==t}var h=document,b=t.$PF&&_ge($PF.fid),y,d,g,a,s,w,l,k;if(b)try{y=b.contentWindow,y.$PF&&(h=y.document)}catch(it){}if(d=n.keys.length==0,g=navigator.appVersion.indexOf("MSIE 6")>-1,u||(u=[n.current,,,n.version]),a=u[3]||"",s=u[0],f&&i&&(t.clearTimeout(i),i=null),n.preview==s&&(!f||n.current==s)){f&&$f.pn(e,"c_m")&&$menu.closeCurrent();return}n.previewLinks||(n.previewLinks=[]);var rt=!1,v=n.previewLinks,ut=[n.baseUrl,n.preview,"/",n.version].join(""),nt="{0}//{1}{2}{3}".format(h.location.protocol,h.location.host,n.genService.replace("{themeid}",s).replace("{version}",a),n.uniqueServiceParams?"&"+n.uniqueServiceParams:""),p=n.baseGenLinkId+s+"_"+a.replace(".","_"),o=h.getElementById(p),c=h.getElementById("themecss");if(o||(o=h.createElement("link"),o.id=p,o.href=nt,o.disabled=!0,o.type="text/css",o.rel="stylesheet",r(o).insertAfter(c),f||n.previewLinks.push(o)),f){for(w=c.parentNode,c.nodeName=="STYLE"?c.id="themecssold":w.removeChild(c),o.id="themecss",o.disabled=!1,l=0;l<v.length;l++)v[l].id!="themecss"&&w.removeChild(v[l]);n.previewLinks=v=[]}n.disableAllExceptTimeout&&(clearTimeout(n.disableAllExceptTimeout),n.disableAllExceptTimeout=0),n.disableAllExceptTimeout=window.setTimeout(function(){tt(p)},0),n.preview=s,f&&(n.showThemeSelection&&e&&($css.remove(n.currentEl,"sel"),$css.add(e,"sel")),e&&(n.currentEl=e),n.current=s,n.version=a,"undefined"!=typeof $themewritecallback&&$themewritecallback(s),e&&$f.pn(e,"c_m")&&$menu.closeCurrent(),(!n.saveTheme||n.saveTheme(s))&&n.serviceUrl&&(k=new Image,k.src=[n.serviceUrl,"&themeid=",s,"&",Math.random()].join("")))}),n.bind=function(i,u){var o,s,f,e;if(i&&u&&i.themebound!=!0&&(o=t._ge(u),s=r(o),o&&"undefined"!=typeof $Config.Themes)){function h(){n.canApplyPreview()&&(n.previewTheme(),$css.remove(i,"t_hov"))}if(s.mouseleave(h),s.blur(h),s.find("li").focusout(h),n.serviceUrl=o.getAttribute("serviceurl"),f=o.getElementsByTagName("A"),f.length>0){for(e=0;e<f.length;e++)f[e].getAttribute("info")&&("undefined"==typeof f[e].binding&&(f[e].binding=new n.thumbnail(f[e])),f[e].binding.themeinfo[0].toLowerCase()==n.current.toLowerCase()&&(n.showThemeSelection&&$css.add(f[e],"sel"),n.currentEl=f[e]));i.themebound=!0}}};var f=null,i=null,u=!1;n.canApplyPreview=function(r){return f=r,u||(r?i||(i=t.setTimeout(e,n.previewActivationDelay)):(t.clearTimeout(i),i=null)),u},n.lastTheme=null,n.invertTheme=function(){var t=["Color_inverted_grey",null,null,n.version],i=n.current,r;n.current===t[0]?(r=n.lastTheme!=null?n.lastTheme:n.defaultTheme,n.previewTheme([r,null,null,n.version],!0,null)):n.previewTheme(t,!0,null),n.lastTheme!=i&&(n.lastTheme=i)};function e(){u=!0,i=null;var n=f;f=null,n&&n.preview()}n.beforeMenuShow=function(){u=!1}}"undefined"!=typeof $Config.Themes&&(n=t.$theme,n.baseUrl=$Config.Themes.baseUrl,n.genService=$Config.Themes.genService,n.preview=n.current=$Config.Themes.current,n.version=$Config.Themes.version,n.baseGenLinkId="theme_gen_link_",n.uniqueServiceParams=$Config.Themes.uniqueServiceParams,n.defaultTheme=$Config.Themes.defaultTheme,n.showThemeSelection=!!$Config.Themes.showThemeSelection),window.$menu&&$menu.themeCallback&&$menu.themeCallback()})()}),define("ImageButton.js",["JBase.js","BaseControl.js"],function(){(function(){var n={url:""};defineSubClass("Shared.UI.ImageButton",JBase.UI.BaseControl,function(){this.buttonImage=this.createChild(JBase.UI.ImageTile)},{baseTag:"button",isDisabled:!1,altText:"",titleText:"",_isMouseDown:!1,_isMouseOver:!1,onDataContextChanged:function(t){var i=n;this.isDisabled=t.isDisabled,this.altText=t.alt||"",this.titleText=t.title||"",i=t.isDisabled&&t.disabledImage?t.disabledImage:this._isMouseDown&&this._isMouseOver&&t.pressedImage?t.pressedImage:this._isMouseOver&&t.hoverImage?t.hoverImage:t.image,this.buttonImage.setDataContext(i)},onActivate:function(){this.addElementListener(document,"mouseup",this._onMouseUp)},_onMouseDown:function(){return this._isMouseDown=!0,this.change(),raiseEvent(this,"mousedown",null,!0)},_onDragStart:function(){return!1},_onMouseUp:function(){return this._isMouseDown=!1,this._isMouseOver=!1,this.change(),raiseEvent(this,"mouseup",null,!0)},_onMouseOver:function(){this._isMouseOver=!0,this.change()},_onMouseOut:function(){this._isMouseOver=!1,this.change()},_onClick:function(n){return raiseEvent(this,"click",n,!0)}})})()}),define("ImageButton.html.js",["ImageButton.js"],function(){Shared.UI.ImageButton.prototype.onRenderHtml=function(){return"<"+this.baseTag+' id="'+htmlAttributeEncode(this.id+"_0")+'"'+(this.baseStyle?' style="'+this.baseStyle+'"':"")+' class="c-'+this.controlName+" "+this.baseClass+'"'+generateAttributesString("disabled",this.isDisabled,"title",this.titleText,"alt",this.altText)+">"+this.buttonImage.renderHtml()+"<\/"+this.baseTag+">"},processAnnotations(Shared.UI.ImageButton,[{id:0,attr:["disabled","isDisabled","title","titleText","alt","altText"],userActions:{mousedown:"_onMouseDown",mouseover:"_onMouseOver",mousemove:"_onMouseOver",mouseout:"_onMouseOut",click:"_onClick",dragstart:"_onDragStart"}}],[],{})}),define("FlashHelper.js",["JBase.js","BaseControl.js","ImageTile.js","ImageButton.html.js","DroppableNavLink.js","AleHelpers.js","ErrorManager.js","ErrorManager.js","ItemActionHelper.js"],function(){(function(){function r(r,u){function h(){var e;try{e=f.GetVariable("$version")}catch(c){}e?(n=i(e),u(t(r))):s>0?(s--,setTimeout(h,10)):(o.removeChild(f),n=[],u(!1))}var s=10,f,e,o;if(window.ActiveXObject)try{e=new ActiveXObject("ShockwaveFlash.ShockwaveFlash"),n=e?i(e.GetVariable("$version")):[]}catch(c){n=[]}finally{u(t(r))}else o=document.body,f=ce("OBJECT"),f.style.position="absolute",f.style.left="99999px",f.setAttribute("type","application/x-shockwave-flash"),o.appendChild(f),h()}function i(n){var i=(n||"").split(" "),t=i.length>1?i[1].split(","):"";return t.length>2?[parseInt(t[0],10),parseInt(t[1],10),parseInt(t[2],10)]:[]}function t(t){return t&&t.length===3&&n.length===3&&(n[0]>t[0]||n[0]==t[0]&&n[1]>t[1]||n[0]==t[0]&&n[1]==t[1]&&n[2]>=t[2])}var n=null;defineNamespace("SkyDrive.UI.FlashHelper",{checkFlashSupport:function(i,u){n===null?r(i,u):u(t(i))}})})()}),define("VideoDataContext.js",["FlashHelper.js"],function(){(function(){function ct(){var n=document.createElement("video"),t;if(n&&n.canPlayType)try{t=n.canPlayType('video/mp4; codecs="avc1.42E01E, mp4a.40.2"'),c=t!==""&&t.toLowerCase()!=="no",a=!!(c&&!h&&(window.MediaSource||window.WebKitMediaSource))}catch(i){}}var o=wLive.Core,s=o.AleHelpers.getString,k=o.ItemActionHelper,r="VideoDataContext",d=[10,0,0],g="/GetDownloadUrl/?{cidQueryString}{resIdQueryString}{authKeyQueryString}&canary={FilesConfig.canary:encodeURIComponent}",h=window.$B&&($B.SF_iPhone||$B.Mobile),nt=FilesConfig.isDashEnabled,c=!1,a=!1,t={unevaluated:0,evaluating:1,supported:2,unsupported:3},i=t.unevaluated,tt="HtmlVideoCanvas",it="HtmlDashVideoCanvas",rt="FlashVideoCanvas",v="FlashDashVideoCanvas",ut="video",ft="dash",et="videonocache",ot="testurl",u=null,f=null,y=!1,l=36e5,e="SkyDrive.VideoSettings",p=2,n={volume:1,isMuted:!1,defaultVideoQuality:2,defaultAudioQuality:1};mix(n,BrowserStorage.getLocalValue(e,{},!0));var w=!1,st=s("Video.UnsupportedFormat"),b=s("Video.BrowserUnsupportedFormat"),ht="H264";ct(),defineNamespace("SkyDrive.UI.VideoErrorCode",{resolveUrlError:"resolveUrlError",decodeError:"decodeError",networkError:"networkError",unsupportedFormatError:"unsupportedFormatError",loadTimeout:"loadTimeout",waitingTimeout:"waitingTimeout",unexpectedError:"unexpectedError"}),defineNamespace("SkyDrive.UI.VideoQuality",{quality240:0,quality360:1,quality480:2,quality720:3,quality1080:4}),defineSubClass("SkyDrive.UI.VideoDataContext",JBase.DataContext,function(){var t,i;u===null&&(t=window.$Config&&$Config.AjaxHistory&&$Config.AjaxHistory.state?$Config.AjaxHistory.state:null,t&&(u=t[ut],f=t[ft],y=t[et],w=t[ot])),mix(this,n),i=SkyDrive.UI.VideoDataContext,this.addObjectListener(i,"pauseAll",this._onPauseAll),this.addObjectListener(i,"setVolume",this._onSetVolume)},{item:null,isAutoPlayEnabled:!h,canPlay:!1,isPlaying:!1,isLoading:!1,isSeeking:!1,isExpanded:!1,isMuted:!1,isWaiting:!1,volume:1,duration:0,currentTime:0,bufferTime:0,autoAdjustQuality:!0,playingVideoQuality:0,bufferingVideoQuality:0,bufferingAudioQuality:0,maxVideoQuality:-1,maxAudioQuality:-1,userSeekTime:-1,hasUserPaused:!1,userVideoQuality:-1,hasError:!1,isErrorDismissable:!0,errorMessage:"",debugMessage:"",posterImage:null,videoUrl:"",videoCanvasType:null,disableStreaming:!1,useStreaming:!1,hasCanvasInitialized:null,hasCanvasLoaded:null,_currentItem:null,_isFetchingUrl:!1,reset:function(){var i=this._getMaxVideoQuality(),t=Math.min(i,n.defaultVideoQuality),r=Math.min(p,n.defaultAudioQuality);mix(this,{_currentItem:null,_isFetchingUrl:!1,item:null,canPlay:!1,isLoading:!1,isPlaying:!1,isSeeking:!1,isExpanded:!1,isWaiting:!1,duration:0,currentTime:0,bufferTime:0,userSeekTime:-1,hasUserPaused:!this.isAutoPlayEnabled,videoUrl:"",videoCanvasType:null,disableStreaming:!1,hasError:!1,isErrorDismissable:!0,errorMessage:"",debugMessage:"",posterImage:null,autoAdjustQuality:!0,playingVideoQuality:t,bufferingVideoQuality:t,maxVideoQuality:i,defaultVideoQuality:t,bufferingAudioQuality:r,defaultAudioQuality:r,hasCanvasInitialized:null,hasCanvasLoaded:null})},change:function(n){if(this._currentItem!=this.item){var t=this.item;this.reset(),this.item=this._currentItem=t}this.videoUrl||this._evaluateItemPlayability(),this.hasUserPaused&&(this.isWaiting=this.isLoading=!1),this.useStreaming&&!this.hasError&&((this.bufferingVideoQuality>this.defaultVideoQuality||this.bufferingVideoQuality<this.maxVideoQuality)&&this.setDefaultVideoQuality(this.bufferingVideoQuality),(this.bufferingAudioQuality>this.defaultAudioQuality||this.bufferingAudioQuality<p)&&this.setDefaultAudioQuality(this.bufferingAudioQuality)),change(this,n)},restoreVideo:function(n){this.isErrorDismissable&&(Trace.log("Restoring video playback (disableStreaming: "+!!n+")",r),this.setData({videoCanvasType:null}),mix(this,{hasError:!1,videoUrl:null,errorMessage:"",debugMessage:"",hasCanvasInitialized:null,hasCanvasLoaded:null,canPlay:!1,isPlaying:!1,isSeeking:!1,isLoading:!1,isWaiting:!1,userSeekTime:this.currentTime,hasUserPaused:!1,playingVideoQuality:this.defaultVideoQuality,bufferingVideoQuality:this.defaultVideoQuality,disableStreaming:!!n}),this._evaluateItemPlayability(),this.change())},isVideoUrlExpired:function(){var n=this.item;return n&&n.downloadUrlTimestamp&&+new Date-n.downloadUrlTimestamp>l},isAtEndOfVideo:function(){var n=this.isSeeking?this.userSeekTime:this.currentTime;return this.duration>0&&this.duration-n<.4},setDefaultVideoQuality:function(t){t!=n.defaultVideoQuality&&(Trace.log("Updating default video quality to: "+t,r),n.defaultVideoQuality=this.defaultVideoQuality=t,BrowserStorage.setLocalValue(e,n,!0))},setDefaultAudioQuality:function(t){t!=n.defaultAudioQuality&&(Trace.log("Updating default audio quality to: "+t,r),n.defaultAudioQuality=this.defaultAudioQuality=t,BrowserStorage.setLocalValue(e,n,!0))},resetQuality:function(){this.setDefaultVideoQuality(SkyDrive.UI.VideoQuality.quality480),this.setDefaultAudioQuality(1)},_getMaxVideoQuality:function(){var n=SkyDrive.UI.VideoQuality,t=n.quality240,i;return this.item&&this.item.video&&(i=Math.min(this.item.video.width,this.item.video.height),i>720?t=n.quality1080:i>480?t=n.quality720:i>360?t=n.quality480:i>240&&(t=n.quality360)),t},_evaluateItemPlayability:function(){var y=this,n=this.item,w=!!(n&&!n.did&&n.video),p=w&&n.video.fourCC==ht,e,s=null,o=this.errorMessage,l=this.isErrorDismissable;if(n&&!n._isLoadingItem&&!o)if(w){if(y.duration=n.video.duration/1e3,(!u&&c||u=="html")&&(e=f=="1"?!0:f=="0"?!1:!this.disableStreaming&&(nt||!p)&&a,(e||p)&&(s=e?it:tt)),!s)if(p&&!h)if(i==t.supported)e=f=="1",s=e?v:rt;else{if(i===t.unevaluated){i=t.evaluating,SkyDrive.UI.FlashHelper.checkFlashSupport(d,function(n){y._currentItem=null,i=n?t.supported:t.unsupported,y.change()});return}i==t.unsupported&&(o=b,l=!1)}else o=b,l=!1}else o=st,l=!1;this.videoCanvasType!=s&&Trace.log("Video canvas type: "+(s||"none"),r),this.errorMessage!=o&&Trace.log("Video failed to render: "+o),mix(this,{errorMessage:o,isErrorDismissable:l,hasError:!!o,videoCanvasType:s,useStreaming:e}),this.videoCanvasType&&(this.videoUrl=this._getVideoUrl(n),this.videoUrl||this._fetchDownloadUrl(n))},_getVideoUrl:function(n){var i=this,r=n.downloadUrlTimestamp?+new Date-n.downloadUrlTimestamp:l+1,t=r<=l?n.downloadUrl:"";return t&&($B.SF_Android&&t.toLowerCase().indexOf("https:")===0&&(t="http"+t.substr(5)),i.useStreaming&&(t+="&videoformat=dash&part=index",y&&(t+="&cacheDisable=1")),w?t="http://wamsclient.cloudapp.net/tears_of_steel/tears_of_steel_1080p.ism/manifest(format=mpd-time-csf)":i.videoCanvasType==v&&(t+="&.ism/manifest(format=mpd-time-csf)")),t},_fetchDownloadUrl:function(n){function u(i){t._isFetchingUrl=!1,t.item===n&&i.DownloadUrl&&(n.downloadUrl=i.DownloadUrl,n.downloadUrlTimestamp=+new Date,t.change())}function f(){t._isFetchingUrl=!1,t.setData({hasError:!0,errorMessage:s("Video.LoadError"),hasUserPaused:!0})}var t=this,r,i;n&&n.video&&!t._isFetchingUrl&&(r=k.itemStringFormat(g,n),i=new o.DataRequest(r,r,null,u,f),i.apiId="SkyDrive_Json_GetDownloadUrl",i.propertyId="SkyDrive",i.start(),t._isFetchingUrl=!0)},_onPauseAll:function(){this.hasUserPaused||(this.hasUserPaused=!0,this.change())},_onSetVolume:function(n){(this.volume!=n.volume||this.isMuted!=n.isMuted)&&(this.volume=n.volume,this.isMuted=n.isMuted,this.change())}},{pauseAll:function(){raiseEvent(SkyDrive.UI.VideoDataContext,"pauseAll")},setVolume:function(t,i){(t!=n.volume||i!=n.isMuted)&&(n.volume=t,n.isMuted=i,BrowserStorage.setLocalValue(e,n,!0),raiseEvent(SkyDrive.UI.VideoDataContext,"setVolume",{volume:t,isMuted:i}))}})})()}),define("BaseVideoCanvas.js",["VideoDataContext.js"],function(){(function(){var l=wLive.Core,r=l.AleHelpers.getString,n=Qos.responseType,t=SkyDrive.UI.VideoErrorCode,a=SkyDrive.UI.VideoDataContext,s=6e4,h=3e4,v=400,y=5e3,u=window.$B&&($B.SF_iPhone||$B.Mobile),p="SkyDrive",w="Load",c="Recovery",f="Playback",b="Seek",k="success",e="canceled",d=.9,i=5e3,o=500;defineSubClass("SkyDrive.UI.BaseVideoCanvas",JBase.UI.BaseControl,function(){},{traceCategory:"BaseVideoCanvas",videoFormatBase:"",_lastVolume:-1,_isMuted:null,_lastCurrentTimeSet:0,_loadingTimerId:0,_playbackTimerId:0,_waitingTimerId:0,_lastLoadTime:0,_lastWaitTime:0,_lastSeekTime:0,_lastSegmentTimeUpdates:0,_lastSegmentStartTime:0,_lastSegmentCurrentTime:0,_lastSegmentProgressTime:0,onDataContextChanged:function(n){if(this.isActive)if(n.videoUrl){var t=n.hasCanvasInitialized===null,i=n.hasCanvasLoaded===null&&!n.hasError;t?(n.hasCanvasInitialized=!1,n.isLoading=!0,this._resetState(),this._lastLoadTime=+new Date,this._loadingTimerId=this.setTimeout(this._onLoadTimeout,s),this._initialize()):n.hasCanvasInitialized&&(i&&(n.hasCanvasLoaded=!0,this._load(n.videoUrl)),this._updateVideoState(n))}else n.hasCanvasLoaded&&this._reset()},onDeactivate:function(){this._resetState()},_resetState:function(){this._stopPlaybackMonitor(),this._stopWaitingMonitor(!0),this._logLoadTimes(e),this.clearTimeout(this._loadingTimerId),mix(this,{_lastVolume:-1,_isMuted:null,_lastCurrentTimeSet:-1,_lastSegmentStartTime:0,_lastSegmentProgressTime:0})},_onInitialized:function(){var n=this;Trace.log("event: initialized",n.traceCategory),n.dataContext.setData({hasCanvasInitialized:!0})},_onLoadStart:function(){Trace.log("event: loadstart",this.traceCategory),this.dataContext.setData({isWaiting:!0,isLoading:!0}),this.dataContext.hasUserPaused||this._play()},_onCanPlay:function(){Trace.log("event: canplay",this.traceCategory),this.clearTimeout(this._loadingTimerId),this._loadingTimerId=0,this.dataContext.setData({canPlay:!0})},_onPlay:function(){Trace.log("event: play",this.traceCategory),this.dataContext.setData({isPlaying:!0,isWaiting:!1})},_onPause:function(){Trace.log("event: pause",this.traceCategory),this._stopPlaybackMonitor(),this.dataContext.setData({isPlaying:!1,hasUserPaused:this.dataContext.isAtEndOfVideo()?!0:this.dataContext.hasUserPaused})},_onVolumeChange:function(n,t){Trace.log("event: volumechange (volume: "+n+", muted: "+t+")",this.traceCategory),a.setVolume(n,t)},_onWaiting:function(){var n=this.dataContext;n.isWaiting||n.isUserSeeking||(n.isAtEndOfVideo()?(Trace.log("event: waiting - end of video",this.traceCategory),this._onEnded()):(Trace.log("event: waiting",this.traceCategory),n.setData({isWaiting:!0}),n.isLoading||n.hasUserPaused||this._startWaitingMonitor()))},_onPlaying:function(){this.dataContext.isWaiting&&(Trace.log("event: playing",this.traceCategory),this.dataContext.setData({isWaiting:!1,isSeeking:!1}))},_onEnded:function(){Trace.log("event: ended",this.traceCategory),this._stopPlaybackMonitor(),this.dataContext.setData({hasUserPaused:!0,currentTime:this.dataContext.duration}),raiseEvent(SkyDrive.UI.BaseVideoCanvas,"complete")},_onTimeUpdate:function(n,t){var r=+new Date,u=r-this._lastSegmentProgressTime,i={duration:t};n=Math.min(n,t),this._lastSegmentProgressTime=r,this._lastSegmentTimeUpdates++,!n||this.dataContext.hasUserPaused||this.dataContext.isSeeking||this.dataContext.userSeekTime!=this._lastCurrentTimeSet||(i.currentTime=n,u<o&&n>this.dataContext.currentTime&&(this._lastCurrentTimeSet=this.dataContext.userSeekTime=-1,this._startPlaybackMonitor(),i.isLoading=i.isWaiting=!1,i.isPlaying=!0)),this.dataContext.setData(i)},_onProgress:function(n){this.dataContext.setData({bufferTime:n})},_onError:function(n){var i=this.dataContext,f,r,u;i&&i.videoUrl&&!i.hasError&&(f="",r=!!this._lastLoadTime,Trace.log("event: error ("+n+")",this.traceCategory),this._logLoadTimes(n),u={errorMessage:this._getMessageForError(n),debugMessage:f||"",hasError:!0,isLoading:!1,isWaiting:!1,hasUserPaused:!0,hasCanvasLoaded:!1,disableStreaming:r?!0:i.disableStreaming,canPlay:!1,userSeekTime:i.currentTime},r&&(u.hasCanvasInitialized=!1),i.resetQuality(),i.setData(u),this._pause(),raiseEvent(SkyDrive.UI.BaseVideoCanvas,"error"))},_onLoadTimeout:function(n){n=n?" - "+n:"",this._loadingTimerId=0,this._onError(t.loadTimeout+n,"loadTimeout: "+s+"ms passed before load events were received.")},_onSeeking:function(){Trace.log("event: seeking",this.traceCategory),this.dataContext.setData({isSeeking:!0})},_onSeeked:function(){Trace.log("event: seeked (currentTime: "+this.dataContext.currentTime+")",this.traceCategory),this.dataContext.setData({isSeeking:!1})},_initialize:function(){Trace.log("action: initialize (videoUrl: "+this.dataContext.videoUrl+")",this.traceCategory),this._doInitialize?this._doInitialize():this._onInitialized()},_load:function(n){Trace.log("action: load (videoUrl: "+n+")",this.traceCategory),this._lastLoadTime=+new Date,this._doLoad&&this._doLoad(n)},_play:function(){u||(Trace.log("action: play (currentTime: "+this.dataContext.currentTime+")",this.traceCategory),this._doPlay&&this._doPlay())},_pause:function(){u||(Trace.log("action: pause (currentTime: "+this.dataContext.currentTime+")",this.traceCategory),this._stopPlaybackMonitor(),this._stopWaitingMonitor(!0),this.clearTimeout(this._loadingTimerId),this._lastSeekTime=this._lastLoadTime=this._loadingTimerId=0,this._doPause&&this._doPause())},_seek:function(n,t){Trace.log("action: seek ("+n+")",this.traceCategory),this._stopPlaybackMonitor(),this._stopWaitingMonitor(!0),n==this.dataContext.duration?(this._lastSeekTime=-1,this.dataContext.setData({userSeekTime:-1,currentTime:n,hasUserPaused:!0})):(t||(this._lastSeekTime=+new Date),this.dataContext.setData({userSeekTime:n,currentTime:n}),this._doSeek&&this._doSeek(n))},_reset:function(){Trace.log("action: reset",this.traceCategory),this._doReset&&this._doReset()},_setMute:function(n){this._isMuted!=n&&(Trace.log("action: setMuted ("+n+")",this.traceCategory),this._isMuted=n,this._doSetMute&&this._doSetMute(n))},_setVolume:function(n){this._lastVolume!=n&&(Trace.log("action: setVolume ("+n+")",this.traceCategory),this._lastVolume=n,this._doSetVolume&&this._doSetVolume(n))},_adjustQuality:function(n){n.useStreaming&&this._doAdjustQuality&&this._doAdjustQuality(n)},_updateVideoState:function(n){var t=this,i,r;t._setMute(n.isMuted),t._setVolume(n.volume),t._adjustQuality(n),!n.hasError&&n.duration>0&&n.canPlay&&(n.isPlaying&&n.hasUserPaused&&(n.setData({isPlaying:!1}),t._pause()),t._lastCurrentTimeSet==n.userSeekTime||n.isSeeking||(i=Math.abs(n.userSeekTime-t._lastCurrentTimeSet),i>.01&&t.throttle(t.id+"seek",v,y,function(){t.isActive&&n.userSeekTime!=-1&&(t._lastCurrentTimeSet=n.currentTime=n.userSeekTime,t._seek(t._lastCurrentTimeSet))},!0)),r=n.isAtEndOfVideo(),n.isPlaying||n.hasUserPaused||(r&&t._seek(0,!0),n.setData({isPlaying:!0}),t._play()))},_getMessageForError:function(n){var i;switch(n){case t.networkError:i=r("Video.LoadErrorNetwork");break;case t.decodeError:i=r("Video.LoadErrorDecode");break;default:i=r("Video.LoadError")}return i},_logAction:function(t,i,r,u,f){var o,e,c,a;if(r=r||"",u=u||n.success,f){var l=+new Date,s=i?(l-i)/1e3:0,h=[{start:0,end:1},{start:1,end:2},{start:2,end:4},{start:4,end:6},{start:6,end:9},{start:9,end:12},{start:12,end:15},{start:15,end:20}];for(o=0;o<h.length;o++){if(e=h[o],s>=e.start&&s<=e.end){r+=" ("+e.start+"s-"+e.end+"s)";break}o==h.length-1&&(u=n.unexpected,r+=" (beyond "+e.end+"s)")}}c=this.apiIdBase+"_"+t+"_"+this.videoFormatBase,a=i?", took "+s+"s":"",Trace.log("Reporting: "+c+a+", responseType: "+u+", responseCode: "+r,this.traceCategory),Qos.log(c,p,i,r,u,null,l)},_logLoadTimes:function(t){var i=!t||t==e?n.success:n.unexpected;t=t||k,this._lastLoadTime&&(this.clearTimeout(this._loadingTimerId),this._logAction(w,this._lastLoadTime,t,i,!0),this._lastLoadTime=this._loadingTimerId=0,this.dataContext.setData({isLoading:!1})),this._lastSeekTime&&(this._logAction(b,this._lastSeekTime,t,i,!0),this._lastSeekTime=0)},_startPlaybackMonitor:function(){!this._playbackTimerId&&this.dataContext.isPlaying&&(this._lastSegmentStartTime||this.dataContext.isWaiting||(this._logLoadTimes(),this._stopWaitingMonitor(!1),Trace.log("start: playback monitor",this.traceCategory),this._lastSegmentStartTime=+new Date,this._lastSegmentCurrentTime=this.dataContext.currentTime),this._playbackTimerId=this.setTimeout(this._checkPlaybackProgress,o))},_stopPlaybackMonitor:function(){this._playbackTimerId&&(Trace.log("stop: playback monitor",this.traceCategory),this.clearTimeout(this._playbackTimerId),this._playbackTimerId=0),this._lastSegmentStartTime=0,this._lastSegmentCurrentTime=0,this._lastSegmentTimeUpdates=0},_checkPlaybackProgress:function(){var e=+new Date,n=this.dataContext,s=n.currentTime,t=n.duration,a=this._lastSegmentProgressTime?e-this._lastSegmentProgressTime:0,v=this._lastSegmentStartTime?e-this._lastSegmentStartTime:0,h=!1;if(this._playbackTimerId=0,a>o&&this._onWaiting(),v>=i){var r=this._lastSegmentCurrentTime+i/1e3<t,c=d*Math.min(i/1e3,t-this._lastSegmentCurrentTime),l=s-this._lastSegmentCurrentTime,y=l>=c,u="timeUpdates: "+this._lastSegmentTimeUpdates+" ("+Math.round(this._lastSegmentTimeUpdates*1e3/i)+" events/sec), timePassed: "+l+"s, expected: "+c+"s";y?(Trace.log("Progress acceptable. "+u,this.traceCategory),r&&this._logAction(f)):(s>t-1?(Trace.log("Progress insufficient, ending video. "+u,this.traceCategory),r&&this._logAction(f,0,"insufficientUpdatesAtEnd"),this._onEnded()):(Trace.log("Progress insufficient, waiting. "+u,this.traceCategory),r&&this._logAction(f,0,"insufficientUpdates"),this._onWaiting()),h=!0),this._stopPlaybackMonitor()}n.hasUserPaused||h||this._startPlaybackMonitor()},_startWaitingMonitor:function(){u||this._waitingTimerId||this._loadingTimerId||(Trace.log("start: waiting monitor",this.traceCategory),this._lastWaitTime=+new Date,this._waitingTimerId=this.setTimeout(this._onWaitingTimeout,h))},_stopWaitingMonitor:function(t){this._waitingTimerId&&(Trace.log("stop: waiting monitor",this.traceCategory),this._logAction(c,this._lastWaitTime,t?e:null,t?n.success:null,!0),this.clearTimeout(this._waitingTimerId),this._waitingTimerId=0)},_onWaitingTimeout:function(){this._logAction(c,this._lastWaitTime,t.waitingTimeout),this._waitingTimerId=0,this._onError(t.waitingTimeout,"waitingTimeout: "+h+"ms passed before load events were received.")}})})()}),define("FlashVideoCanvas.js",["BaseVideoCanvas.js"],function(){(function(){var t=SkyDrive.UI.BaseVideoCanvas.prototype,n="FlashVideoCanvas",r="/Plugins/strobe-2.0.swf",u="/Plugins/osmf-1.0.6.swf",i={};defineSubClass("SkyDrive.UI.FlashVideoCanvas",SkyDrive.UI.BaseVideoCanvas,function(){},{apiIdBase:"SkyDriveWeb_Internal_Control_FlashVideoCanvas",videoFormatBase:"Mp4",traceCategory:n,canPlay:!1,_playerId:"",_playerElement:null,_applyingVolume:null,_applyingMuted:null,_bridgeCreated:!1,_loadStarted:!1,onInitialize:function(){this._playerId=this.id+"-flashPlayer"},onActivate:function(){this.change(),t.onActivate&&t.onActivate.apply(this,arguments)},onDeactivate:function(){this._removeFlashPlayer(),t.onDeactivate&&t.onDeactivate.apply(this,arguments)},_onLoadTimeout:function(){t._onLoadTimeout.call(this,"bridgeCreated: "+this._bridgeCreated+", loadStarted: "+this._loadStarted)},_doInitialize:function(){this._createFlashPlayer(this.dataContext)},_doLoad:function(){},_doReset:function(){this._removeFlashPlayer()},_doSeek:function(n){try{this._playerElement.seek(n)}catch(t){this._onError("exception: seek")}},_doSetMute:function(n){this._applyingMuted=n;try{this._playerElement.setMuted(n)}catch(t){this._onError("exception: setMuted")}},_doSetVolume:function(n){this._applyingVolume=n;try{this._playerElement.setVolume(n)}catch(t){this._onError("exception: setVolume")}},_doAdjustQuality:function(){},_doPlay:function(){try{this._playerElement.play2()}catch(n){this._onError("exception: play2")}},_doPause:function(){try{this._playerElement.pause()}catch(n){this._onError("exception: pause")}},_handlePlayerEvent:function(t,i){var u=this._playerElement,r;if(u)switch(t){case"onJavaScriptBridgeCreated":this._bridgeCreated=!0,this._onInitialized();break;case"loadstart":this._loadStarted=!0,this._onLoadStart();break;case"durationchange":break;case"emptied":Trace.log("event: emptied",n),this.dataContext.setData({canPlay:!0});break;case"play":this._onPlay();break;case"pause":this._onPause();break;case"waiting":this._onWaiting();break;case"loadedmetadata":this.canPlay=!0,this._updateBindings(),this._onCanPlay();break;case"seeking":this._onSeeking();break;case"seeked":this._onSeeked();break;case"timeupdate":this._onTimeUpdate(i.currentTime,this.dataContext.duration);break;case"progress":r=i.buffered&&i.buffered._end&&i.buffered._end[0]?i.buffered._end[0]:0,this._onProgress(r);break;case"volumechange":this._applyingVolume===null&&this._applyingMuted===null?this._onVolumeChange(i.volume,i.muted):(i.volume===this._applyingVolume&&(this._applyingVolume=null),i.muted===this._applyingMuted&&(this._applyingMuted=null));break;case"complete":this._onEnded();break;default:Trace.log("Unknown event: "+t,n)}},_removeFlashPlayer:function(){var t=this._playerElement,r=this;if(this.canPlay=!1,t){if($B.IE)t.style.display="none",function(){t.readyState==4?r._removeFlashPlayerIE(t):setTimeout(arguments.callee,10)}();else{Trace.log("Removing flash player",n);try{!t.parentNode||t.parentNode.removeChild(t)}catch(u){}}delete i[this._playerId],this._playerElement=null}this.element&&setHtml(this.element,"")},_removeFlashPlayerIE:function(t){if(t){for(var i in t)typeof t[i]=="function"&&(t[i]=null);Trace.log("Removing flash player",n),!t.parentNode||t.parentNode.removeChild(t)}},_createFlashPlayer:function(t){var i=this._playerId,e="javascriptCallbackFunction=SkyDrive.UI.FlashVideoCanvas.onJavaScriptBridgeCreated&autoPlay=true&loop=false&controlBarMode=none&enableStageVideo=true&controlBarAutoHide=false&playButtonOverlay=false&id="+i+"&useHTML5=false&bufferingOverlay=false&src="+encodeURIComponent(t.videoUrl),f;t.useStreaming&&(e+="&plugin_AdaptiveStreamingPlugin="+encodeURIComponent(u)),f=$B.IE&&$B.V<9?'<object id="'+i+'" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"><param name="movie" value="'+r+'" />':'<object id="'+i+'" name="'+i+'" type="application/x-shockwave-flash" data="'+r+'">',f+='<param name="allowfullscreen" value="false" /><param name="wmode" value="transparent" /><param name="bgcolor" value="000000"/><param name="allowscriptaccess" value="always"/><param name="flashvars" value="'+e+'" /><\/object>',this._removeFlashPlayer(),setHtml(this.element,f),this._playerElement=byId(i),Trace.log("Creating flash player",n)}},{onJavaScriptBridgeCreated:function(n,t,r){var u=i[n],f;u||(f=byId(n),f&&f.parentNode&&(i[n]=u=f.parentNode.control)),u&&u._handlePlayerEvent(t,r)}})})()}),define("FlashVideoCanvas.html.js",["FlashVideoCanvas.js"],function(){SkyDrive.UI.FlashVideoCanvas.prototype.onRenderHtml=function(){return"<"+this.baseTag+' id="'+htmlAttributeEncode(this.id+"_0")+'"'+(this.baseStyle?' style="'+this.baseStyle+'"':"")+' class="c-'+this.controlName+" "+this.baseClass+""+generateClassAttribute("isPlayable",this.canPlay)+'"><\/'+this.baseTag+">"},processAnnotations(SkyDrive.UI.FlashVideoCanvas,[{id:0,className:["isPlayable","canPlay"]}],[],{})}),define("FlashDashVideoCanvas.js",["FlashVideoCanvas.html.js"],function(){(function(){var n="FlashDashVideoCanvas";defineSubClass("SkyDrive.UI.FlashDashVideoCanvas",SkyDrive.UI.FlashVideoCanvas,function(){},{traceCategory:n,videoFormatBase:"Dash",_hasCalledLoad:!1,_doReset:function(){this._hasCalledLoad=!1},_onLoadStart:function(){if(!this._hasCalledLoad){var t=this.element;Trace.log("action: calling load() on flash player.",n),this._hasCalledLoad=!0,this._playerElement.load()}SkyDrive.UI.BaseVideoCanvas.prototype._onLoadStart.call(this,arguments)}}),defineNamespace("org.strobemediaplayback",{triggerHandler:function(t,i,r){Trace.log("event: triggerHandler ("+i+", code: "+(r&&r.error?r.error.code:"n/a")+")",n)}})})()}),define("HtmlVideoCanvas.js",["FlashDashVideoCanvas.js"],function(){(function(){var n=SkyDrive.UI.BaseVideoCanvas.prototype,t=SkyDrive.UI.VideoErrorCode,r="HtmlVideoCanvas",i=window.$B&&($B.SF_iPhone||$B.Mobile),u=!1,f=400;defineSubClass("SkyDrive.UI.HtmlVideoCanvas",SkyDrive.UI.BaseVideoCanvas,function(){this._onDashErrorCallback=bind(this,this._onDashError)},{apiIdBase:"SkyDriveWeb_Internal_Control_HtmlVideoCanvas",videoFormatBase:"Mp4",baseTag:"video",isPlayerReady:!0,traceCategory:r,posterUrl:null,_autoAdjustQuality:null,_videoQuality:null,_mediaPlayer:null,onDataContextChanged:function(t){this.posterUrl=i&&t.posterImage?t.posterImage.url:"",n.onDataContextChanged.apply(this,arguments)},onActivate:function(){var r=this.element,u=this,e={loadstart:"_onLoadStart",canplay:"_onCanPlay",error:"_onVideoElementError",progress:"_onProgress",ended:"_onEnded",volumechange:"_onVolumeChange",play:"_onPlay",pause:"_onPause",waiting:"_onWaiting",playing:"_onPlaying",timeupdate:"_onTimeUpdate",seeking:"_onSeeking",seeked:"_onSeeked"},f;r.autoplay=!1,r.loop=!1,r.controls=i?!0:!1;for(f in e)u.addElementListener(r,f,u[e[f]]);n.onActivate&&n.onActivate.apply(this,arguments),u.change()},onDeactivate:function(){this._reset(),n.onDeactivate&&n.onDeactivate.apply(this,arguments)},_disposeMediaPlayer:function(){this._mediaPlayer&&(this._mediaPlayer.attachSource(),this._mediaPlayer.removeEventListener("error",this._onDashErrorCallback),this._mediaPlayer=null)},_onVolumeChange:function(){var t=this.element;n._onVolumeChange.call(this,t.volume,t.muted)},_onProgress:function(){var i=this.element,t=i.buffered;n._onProgress.call(this,t&&t.length>0?t.end(t.length-1):0)},_onTimeUpdate:function(){var t=this.element,i=this.dataContext;t&&t.duration&&n._onTimeUpdate.call(this,t.currentTime,t.duration)},_onDashError:function(i){var u,e,r,f;i=i||{},u=i.error,e=i.event;switch(u){case"download":this.dataContext.isLoading?(Trace.log("Dash error during video load, falling back to not use streaming.",this.traceCategory),this._logLoadTimes("dashDownloadManifestError"),this.dataContext.restoreVideo(!0)):r=t.networkError;break;default:r=t.unexpectedError}f="dashError (error: "+u+", event: "+e+")",Trace.log("event: "+f,this.traceCategory),r&&n._onError.call(this,r,f)},_onVideoElementError:function(){var r=this,o=r.element,u=o&&o.error?o.error.code:0,s=r.dataContext?r.dataContext.videoUrl:"",e,h;if(u&&s){switch(u){case 1:break;case 2:u="MEDIA_ERR_NETWORK",e=t.networkError;break;case 3:u="MEDIA_ERR_DECODE",e=t.decodeError;break;case 4:u="MEDIA_ERR_SRC_NOT_SUPPORTED",e=t.unsupportedFormatError;break;case 5:break;default:e=t.unexpectedError}h="videoElementError, code: "+u+", url: "+s,r.setTimeout(function(){r.isActive&&r.dataContext.videoUrl==s&&(Trace.log("event: "+h,r.traceCategory),e&&n._onError.call(r,e,h))},f)}},_doReset:function(){var n=this.element;if(n)try{n.pause()}catch(t){}this._disposeMediaPlayer(),n&&n.src&&(n.src="")},_doInitialize:function(){var n=this,t;n._reset(),n.dataContext.useStreaming?n._mediaPlayer?n._onInitialized():(t=Trace.log("Initializing dash player",this.traceCategory),require(["DashMerge.js"],function(){n.isActive&&(MediaPlayer.dependencies.BufferExtensions.BUFFER_TIME_AT_TOP_QUALITY=300,n._mediaPlayer=new MediaPlayer(new Dash.di.DashContext),n._mediaPlayer.startup(),n._mediaPlayer.debug.setLogToBrowserConsole(u),n._mediaPlayer.addEventListener("error",n._onDashErrorCallback),n._mediaPlayer.attachView(n.element),Trace.logTo(t,"Complete",this.traceCategory),n._onInitialized())})):n._onInitialized()},_doLoad:function(n){var r=this,t=r.dataContext,u=r.element,i;t&&(t.useStreaming?(i=r._mediaPlayer,Trace.log("Attaching dash source (audio: "+t.defaultAudioQuality+", video: "+t.defaultVideoQuality+")",this.traceCategory),i.setScheduleWhilePaused(!0),i.attachSource(n),i.setQualityFor("audio",t.defaultAudioQuality),i.setQualityFor("video",t.defaultVideoQuality)):(Trace.log("Setting video source",this.traceCategory),u.src=n,u.load()))},_doSetMute:function(n){var t=this.element;t.muted=n},_doSetVolume:function(n){var t=this.element;t.volume=n},_doAdjustQuality:function(n){var r=this,t=r._mediaPlayer,u,i,f;t&&!n.hasError&&(u=t.getMetricsFor("video"),i=t.getMetricsExt(),u&&i&&(f=i.getCurrentRepresentationSwitch(u),f!==null&&n.setData({bufferingVideoQuality:i.getIndexForRepresentation(f.to),playingVideoQuality:t.getQualityFor("video"),maxVideoQuality:i.getMaxIndexForBufferType("video")-1,bufferingAudioQuality:t.getQualityFor("audio")})),r._autoAdjustQuality!==n.autoAdjustQuality&&(Trace.log("action: setAutoSwitchQuality (autoAdjustQuality: "+n.autoAdjustQuality+")",this.traceCategory),t.setAutoSwitchQuality(n.autoAdjustQuality),r._autoAdjustQuality=n.autoAdjustQuality),n.userVideoQuality!=-1&&(n.userVideoQuality=Math.min(n.maxVideoQuality,Math.max(0,n.userVideoQuality)),Trace.log("action: setQualityFor (quality: "+n.userVideoQuality+")",this.traceCategory),t.setQualityFor("video",n.userVideoQuality),n.userVideoQuality=-1))},_doPlay:function(){var n=this.element;n.play()},_doPause:function(){var n=this.element;n.pause()},_doSeek:function(n){var t=this.element;try{t.currentTime=n}catch(i){}}})})()}),define("HtmlVideoCanvas.html.js",["HtmlVideoCanvas.js"],function(){SkyDrive.UI.HtmlVideoCanvas.prototype.onRenderHtml=function(){return"<"+this.baseTag+' id="'+htmlAttributeEncode(this.id+"_0")+'"'+(this.baseStyle?' style="'+this.baseStyle+'"':"")+' class="c-'+this.controlName+" "+this.baseClass+'"'+generateAttributesString("poster",this.posterUrl)+"><\/"+this.baseTag+">"},processAnnotations(SkyDrive.UI.HtmlVideoCanvas,[{id:0,attr:["poster","posterUrl"]}],[],{})}),define("HtmlDashVideoCanvas.js",["HtmlVideoCanvas.html.js"],function(){(function(){var n="HtmlDashVideoCanvas";defineSubClass("SkyDrive.UI.HtmlDashVideoCanvas",SkyDrive.UI.HtmlVideoCanvas,function(){},{traceCategory:n,videoFormatBase:"Dash"})})()}),define("ScrubBar.js",["HtmlDashVideoCanvas.js"],function(){(function(){var i=$B.IE?$B.V>10?"pointerdown":"MSPointerDown":"touchstart",n=$B.IE?$B.V>10?"pointermove":"MSPointerMove":"touchmove",t=$B.IE?$B.V>10?"pointerup":"MSPointerUp":"touchend";defineSubClass("SkyDrive.UI.ScrubBar",JBase.UI.BaseControl,function(){},{apiIdBase:"SkyDriveWeb_Internal_Control_ScrubBar",thumbPercentage:"0%",scrubTooltipVisible:!1,scrubTooltip:"",scrubTooltipPercentage:"0%",mouseOverValue:0,trackMouse:!1,isDisabled:!1,_isMouseDown:!1,_isMouseOver:!1,_originalPercentage:"0%",_captureDiv:null,onDataContextChanged:function(n){this.isDisabled=n.isDisabled,this.thumbPercentage=100*(n.value||0)+"%",this.bufferPercentage=100*(n.bufferValue||0)+"%",this.scrubTooltipVisible=!!n.scrubTooltip,this.scrubTooltip=n.scrubTooltip||""},onDeactivate:function(){this._endCapture()},_onMouseDown:function(n){this.isDisabled||this._isMouseDown||(toggleClass(this.element,"isScrubbing",!0),this._isMouseDown=!0,this._startCapture(),this._originalPercentage=this.thumbPercentage,this._updateMouseOverValue(n),this.dataContext.value=this.mouseOverValue,this.change(),raiseEvent(this,"startscrub",{value:this.dataContext.value},!0),this._onMouseMove(n))},_onMouseMove:function(n){return this.isDisabled||((this.trackMouse||this._isMouseDown)&&this._updateMouseOverValue(n),this._isMouseDown&&this.dataContext.value!=this.mouseOverValue&&(this.setDataContext({value:this.mouseOverValue}),raiseEvent(this,"scrub",{value:this.mouseOverValue},!0),raiseEvent(this,"mousemove",n)),this.trackMouse&&this._isMouseOver&&raiseEvent(this,"mousemove",n)),!1},_onMouseOver:function(){this._isMouseOver=!0},_onMouseOut:function(n){this._isMouseOver=!1,this.isDisabled||this._isMouseDown||raiseEvent(this,"mouseout",n)},_onDragStart:function(){return!1},_onMouseUp:function(n){!this.isDisabled&&this._isMouseDown&&(toggleClass(this.element,"isScrubbing",!1),this._isMouseDown=!1,this._endCapture(),raiseEvent(this,"endscrub",{value:this.dataContext.value},!0),this._isMouseOver||raiseEvent(this,"mouseout",n))},_startCapture:function(){if(!this._captureDiv){var i=this._captureDiv=ce("div");i.className="c-ScrubBar eventCatcher",document.body.appendChild(i),this.addElementListener(i,"mousemove",this._onMouseMove),this.addElementListener(i,"mouseup",this._onMouseUp),this.addElementListener(i,n,this._onMouseMove),this.addElementListener(i,t,this._onMouseUp)}},_endCapture:function(){if(this._captureDiv){var i=this._captureDiv;this.removeElementListener(i,"mousemove",this._onMouseMove),this.removeElementListener(i,"mouseup",this._onMouseUp),this.removeElementListener(i,n,this._onMouseMove),this.removeElementListener(i,t,this._onMouseUp),document.body.removeChild(this._captureDiv),this._captureDiv=null}},_updateMouseOverValue:function(n){var t=getRect(this.subElements.scrubArea);t.width&&(this.mouseOverValue=Math.min(1,Math.max(0,(n.originalEvent.clientX-t.left)/t.width)))}})})()}),define("ScrubBar.html.js",["ScrubBar.js"],function(){SkyDrive.UI.ScrubBar.prototype.onRenderHtml=function(){return"<"+this.baseTag+' id="'+htmlAttributeEncode(this.id+"_0")+'"'+(this.baseStyle?' style="'+this.baseStyle+'"':"")+' class="c-'+this.controlName+" "+this.baseClass+""+generateClassAttribute("isDisabled",this.isDisabled)+'"><div class="scrubContainer"><div class="unbuffered scrubArea dimmed"><\/div><div id="'+htmlAttributeEncode(this.id+"_1")+'" style="'+generateStyleAttribute("width",this.bufferPercentage)+'" class="buffered scrubArea dimmed"><\/div><div id="'+htmlAttributeEncode(this.id+"_2")+'" style="'+generateStyleAttribute("width",this.thumbPercentage)+'" class="played scrubArea dimmed"><\/div><div id="'+htmlAttributeEncode(this.id+"_3")+'" class="thumb scrubArea"><div id="'+htmlAttributeEncode(this.id+"_4")+'" style="'+generateStyleAttribute("left",this.thumbPercentage)+'" class="highlight"><\/div><\/div><\/div><\/'+this.baseTag+">"},processAnnotations(SkyDrive.UI.ScrubBar,[{id:0,className:["isDisabled","isDisabled"],userActions:{touchstart:"_onMouseDown",pointerdown:"_onMouseDown",MSPointerDown:"_onMouseDown",mousedown:"_onMouseDown",mouseover:"_onMouseOver",mouseout:"_onMouseOut",dragstart:"_onDragStart",mousemove:"_onMouseMove"}},{id:1,css:["width","bufferPercentage"]},{id:2,css:["width","thumbPercentage"]},{id:3,childId:"scrubArea"},{id:4,css:["left","thumbPercentage"]}],[],{})}),define("PlaybackPanel.js",["ScrubBar.html.js"],function(){(function(){function u(n){n=n||0;var t=Math.floor(n/60);return n=Math.floor(n%60),t+":"+(n<10?"0":"")+n}function r(n,t){return{image:i.getImageInfo("video"+n),hoverImage:i.getImageInfo("video"+n+"Hover"),pressedImage:i.getImageInfo("video"+n+"Pressed"),disabledImage:i.getImageInfo("video"+n+"Disabled"),isDisabled:!!t}}function n(n,t,i){var u,r;return u=n=="DisableStreaming"?"Play original":n?e("Video.QualityMenu"+n):"",r=new Shared.UI.NavItemDataContext({text:u}),n?t&&i?(r.key=i.key,r.isImageSelectMode=!0,r.imageData=i.key=="auto"?s:o,r.click=function(){return t._onQualitySelected(i),!1},r.isSelected=!1):r.isEnabled=!1:r.type="NavSeparator",r}var t=SkyDrive.UI.VideoDataContext,i=JBase.UI.ImageStripHelper,e=wLive.Core.AleHelpers.getString,o=JBase.UI.ImageStripHelper.getImageInfo("sortMenuBullet"),s=JBase.UI.ImageStripHelper.getImageInfo("checkMark"),f=5,h=32,c=27,l=36,a=35,v=37,y=39,p=38,w=40,b=70;defineSubClass("SkyDrive.UI.PlaybackPanel",JBase.UI.BaseControl,function(){},{renderDirection:$B.rtl?"rtl":"ltr",isPlayButtonVisible:!0,isLoaded:"",currentTime:"",duration:"",scrubTooltipVisible:!1,scrubTooltipLeft:0,scrubTooltip:"",hasSettings:!1,apiIdBase:"SkyDriveWeb_Internal_Control_PlaybackPanel",_hasUserPausedBeforeScrubbing:!1,_isUserScrubbing:!1,_lastVideoUrl:null,_maxVideoQuality:null,onInitialize:function(){this.positionScrubBar.baseClass="position",this.positionScrubBar.trackMouse=!0,this.positionScrubBar.setDataContext({value:0,bufferValue:.5}),this.volumeScrubBar.baseClass="volume",this.settingsButton.baseClass="settings",this.settingsMenu.baseClass="settingsMenu",this.settingsMenu.menuLoc=2,this.settingsMenu.skipEdgeDetection=!0,this.settingsMenu.navLinksRepeater.baseClass+=" c_mfw"},onDataContextChanged:function(n){var i=0,t=this,f;t.isActive&&t._lastVideoUrl!=n.videoUrl&&(t._lastVideoUrl=n.videoUrl,n.videoUrl&&t.focus()),n.duration&&(i=n.userSeekTime==-1?n.currentTime:n.userSeekTime),t.hasSettings=n.useStreaming&&n.maxVideoQuality>=0,t.currentTime=u(i),this.duration=u(n.duration),this.isPlayButtonVisible=!n.hasError||n.isErrorDismissable,this._updateQualityMenu(n),n.duration?i/=n.duration:i=0,f=!n.item||n.hasError,this.playButton.setDataContext(r(this._isUserScrubbing?this._hasUserPausedBeforeScrubbing:n.hasUserPaused?"Play":"Pause")),this.volumeButton.setDataContext(r(n.isMuted||n.volume==0?"Mute":"Volume",f)),this.positionScrubBar.setDataContext({value:i,bufferValue:n.bufferTime?n.bufferTime/n.duration:0,throttleScrubDelay:500}),this.volumeScrubBar.setDataContext({value:n.isMuted?0:n.volume,isDisabled:f}),this.settingsButton.setDataContext(r("Settings",f)),this.expandButton.setDataContext(r(n.isExpanded?"Collapse":"Expand",f))},onActivate:function(){this.addObjectListener(this.playButton,"click",this._onPlayClicked),this.addObjectListener(this.positionScrubBar,"startscrub",this._onPositionStartScrub),this.addObjectListener(this.positionScrubBar,"scrub",this._onPositionScrub),this.addObjectListener(this.positionScrubBar,"endscrub",this._onPositionEndScrub),this.addObjectListener(this.positionScrubBar,"mousemove",this._onPositionMouseMove),this.addObjectListener(this.positionScrubBar,"mouseout",this._onPositionMouseOut),this.addObjectListener(this.settingsButton,"mousedown",this._onSettingsMouseDown),this.addObjectListener(this.settingsButton,"click",this._onSettingsClicked),this.addObjectListener(this.volumeButton,"click",this._onVolumeClicked),this.addObjectListener(this.volumeScrubBar,"startscrub",this._onVolumeStartScrub),this.addObjectListener(this.volumeScrubBar,"scrub",this._onVolumeScrub),this.addObjectListener(this.volumeScrubBar,"endscrub",this._onVolumeEndScrub),this.addObjectListener(this.expandButton,"click",this._onExpandClicked)},focus:function(){var n=this;n.setTimeout(function(){if(n.playButton&&n.playButton.element)try{n.playButton.element.focus()}catch(t){}},10)},_onKeyDown:function(n){var t=this.dataContext,i=!0,r=t.isSeeking?t.userSeekTime:t.currentTime;if(t&&t.item&&!n.ctrlKey&&!n.metaKey&&!n.altKey)switch(n.which){case h:t.setData({hasUserPaused:!t.hasUserPaused}),i=!1;break;case c:t.isExpanded&&(t.setData({isExpanded:!1}),i=!1);break;case b:t.isExpanded||(t.setData({isExpanded:!0}),i=!1);break;case l:t.setData({userSeekTime:0}),i=!1;break;case a:t.setData({userSeekTime:t.duration}),i=!1;break;case v:r>0&&(this._onJumpBehind(null),i=!1);break;case y:t.isAtEndOfVideo()||(this._onJumpAhead(null),i=!1);break;case p:t.volume<1&&(t.setData({volume:Math.min(1,t.volume+.1)}),i=!1);break;case w:t.volume>0&&!t.isMuted&&(t.setData({volume:Math.max(0,t.volume-.1)}),i=!1)}return i},_onSettingsMouseDown:function(){return this.settingsMenu.isExpanded?this.settingsMenu.hide():this.settingsMenu.show(),!1},_onSettingsClicked:function(){return!1},_onQualitySelected:function(n){var t=this.dataContext;this.settingsMenu.hide(),n.key=="auto"?t.setData({autoAdjustQuality:!t.autoAdjustQuality}):n.key=="disableStreaming"?t.restoreVideo(!0):n.settings&&t.setData(n.settings)},_onPlayClicked:function(){var t=this.dataContext,i=t.hasError&&t.isErrorDismissable||t.isVideoUrlExpired();return t.hasUserPaused&&i?t.restoreVideo():t.setData({hasUserPaused:!t.hasUserPaused}),!1},_onJumpAhead:function(){var t=this.dataContext,i=t.userSeekTime>-1?t.userSeekTime:t.currentTime,r=Math.min(this.dataContext.duration,i+f);t.setData({userSeekTime:r})},_onJumpBehind:function(){var t=this.dataContext,i=t.userSeekTime>-1?t.userSeekTime:t.currentTime,r=Math.max(0,i-f);t.setData({userSeekTime:r})},_onPositionStartScrub:function(n){this._hasUserPausedBeforeSeeking=this.dataContext.hasUserPaused,this._isUserScrubbing=!0,this.setDataContext({userSeekTime:this.dataContext.duration*n.value,hasUserPaused:!0})},_onPositionScrub:function(n){this.setDataContext({userSeekTime:this.dataContext.duration*n.value})},_onPositionEndScrub:function(n){this._isUserScrubbing=!1,this.setDataContext({userSeekTime:this.dataContext.duration*n.value,hasUserPaused:n.value==1?!0:this._hasUserPausedBeforeSeeking}),this.focus()},_onPositionMouseMove:function(n){var t=getRect(this.element),i=getRect(this.positionScrubBar.element),f=this.positionScrubBar.mouseOverValue,r=i.left-t.left+5,e=r+i.width-15;this.scrubTooltipVisible=!0,this.scrubTooltipLeft=Math.min(e,Math.max(r,n.originalEvent.clientX-t.left)),this.scrubTooltip=u(Math.floor(f*this.dataContext.duration)),this._updateBindings()},_onPositionMouseOut:function(){this.scrubTooltipVisible=!1,this._updateBindings()},_onVolumeClicked:function(){t.setVolume(this.dataContext.volume,!this.dataContext.isMuted)},_onVolumeStartScrub:function(n){this.dataContext.volume>0&&(this._originalVolume=this.dataContext.volume),t.setVolume(n.value,n.value==0)},_onVolumeScrub:function(n){t.setVolume(n.value,n.value==0)},_onVolumeEndScrub:function(n){n.value==0?t.setVolume(this._originalVolume,!0):t.setVolume(n.value,!1),this.focus()},_onExpandClicked:function(){this.setDataContext({isExpanded:!this.dataContext.isExpanded})},_updateQualityMenu:function(t){var r=t.maxVideoQuality,i;this._maxVideoQuality!==r&&(i=[n("Header")],this._maxVideoQuality=r,r>=4&&i.push(n("1080",this,{key:"4",settings:{userVideoQuality:4,bufferingVideoQuality:4,autoAdjustQuality:!1}})),r>=3&&i.push(n("720",this,{key:"3",settings:{userVideoQuality:3,bufferingVideoQuality:3,autoAdjustQuality:!1}})),r>=2&&i.push(n("480",this,{key:"2",settings:{userVideoQuality:2,bufferingVideoQuality:2,autoAdjustQuality:!1}})),r>=1&&i.push(n("360",this,{key:"1",settings:{userVideoQuality:1,bufferingVideoQuality:1,autoAdjustQuality:!1}})),i.push(n("240",this,{key:"0",settings:{userVideoQuality:0,bufferingVideoQuality:0,autoAdjustQuality:!1}})),i.push(n()),i.push(n("Auto",this,{key:"auto"})),this.settingsMenu.setDataContext({text:"",showChevron:!1,childItems:i})),this._updateQualitySelection(t)},_updateQualitySelection:function(n){for(var r=this.settingsMenu.dataContext.childItems,u=!!n.autoAdjustQuality,t,i=0;i<r.length;i++)t=r[i],t.setData({isSelected:t.key=="auto"?u:t.key==n.playingVideoQuality,isBolded:t.key==n.bufferingVideoQuality})}})})()}),define("PlaybackPanel.html.js",["PlaybackPanel.js"],function(){SkyDrive.UI.PlaybackPanel.prototype.onRenderHtml=function(){return"<"+this.baseTag+' dir="ltr" id="'+htmlAttributeEncode(this.id+"_0")+'"'+(this.baseStyle?' style="'+this.baseStyle+'"':"")+' class="c-'+this.controlName+" "+this.baseClass+'"><div class="near area"><div class="play section"><div id="'+htmlAttributeEncode(this.id+"_1")+'" style="'+generateStyleAttribute("display.inlineblock",this.isPlayButtonVisible)+'" class="playButton">'+this.playButton.renderHtml()+'<\/div><div class="seekTime"><span role="button" tabindex="0" id="'+htmlAttributeEncode(this.id+"_2")+'" class="currentTime">'+htmlEncode(this.currentTime)+'<\/span><span>&nbsp;/&nbsp;<\/span><span role="button" tabindex="0" id="'+htmlAttributeEncode(this.id+"_3")+'" class="duration">'+htmlEncode(this.duration)+'<\/span><\/div><\/div><\/div><div class="far area"><div id="'+htmlAttributeEncode(this.id+"_4")+'" class="config section'+generateClassAttribute("hasSettings",this.hasSettings)+'">'+this.settingsButton.renderHtml()+this.volumeButton.renderHtml()+this.volumeScrubBar.renderHtml()+this.expandButton.renderHtml()+'<\/div><\/div><div class="area"><div role="button" class="scrub section">'+this.positionScrubBar.renderHtml()+'<\/div><\/div><div id="'+htmlAttributeEncode(this.id+"_5")+'" style="'+generateStyleAttribute("left.px",this.scrubTooltipLeft)+'" class="tooltipCenter'+generateClassAttribute("isVisible",this.scrubTooltipVisible)+'"><div class="tooltipFrame"><div id="'+htmlAttributeEncode(this.id+"_6")+'" class="tooltipContent">'+htmlEncode(this.scrubTooltip)+'<\/div><\/div><\/div><div id="'+htmlAttributeEncode(this.id+"_7")+'"'+generateAttributesString("dir",this.renderDirection)+">"+this.settingsMenu.renderHtml()+"<\/div><\/"+this.baseTag+">"},processAnnotations(SkyDrive.UI.PlaybackPanel,[{id:0,userActions:{keydown:"_onKeyDown"}},{id:1,css:["display.inlineBlock","isPlayButtonVisible"]},{id:2,attr:["text","currentTime"],childId:"jumpBehindButton",userActions:{click:"_onJumpBehind"}},{id:3,attr:["text","duration"],childId:"jumpAheadButton",userActions:{click:"_onJumpAhead"}},{id:4,className:["hasSettings","hasSettings"]},{id:5,css:["left.px","scrubTooltipLeft"],className:["isVisible","scrubTooltipVisible"]},{id:6,attr:["text","scrubTooltip"]},{id:7,attr:["dir","renderDirection"]}],[],{playButton:Shared.UI.ImageButton,settingsButton:Shared.UI.ImageButton,volumeButton:Shared.UI.ImageButton,volumeScrubBar:SkyDrive.UI.ScrubBar,expandButton:Shared.UI.ImageButton,positionScrubBar:SkyDrive.UI.ScrubBar,settingsMenu:Shared.UI.Menu})}),define("VideoPlayer.js",["PlaybackPanel.html.js"],function(){(function(){var r=wLive.Core.SkyDriveItemHelper,t="VideoPlayer",i=3e3,n=window.$B&&($B.SF_iPhone||$B.Mobile);defineSubClass("SkyDrive.UI.VideoPlayer",JBase.UI.BaseControl,function(){this.playbackCanvas=this.createChild(JBase.UI.ContentControl,{disposeOnSwap:!0,getControlType:bind(this,this._getCanvasType)}),this.posterImage=this.createChild(JBase.UI.ImageTile,{baseClass:"posterImage",scaleToFit:!0,allowStretching:!0})},{apiIdBase:"SkyDriveWeb_Internal_Control_VideoPlayer",baseDataContextType:SkyDrive.UI.VideoDataContext,isFullScreen:!1,isFullWindow:!1,isPosterVisible:!1,isUserIdle:!1,hasError:!1,isPlaybackPanelVisible:!n,isLoading:!1,errorMessage:"",debugMessage:"",canvasSize:{width:500,height:500},_userIdleTimer:0,_lastMove:0,_lastMouseX:0,_lastMouseY:0,_placeholderDiv:null,_hasStartedWaiting:!1,_isUserIdle:!1,onInitialize:function(){var n=new SkyDrive.UI.VideoDataContext;this.setDataContext(n),this.playbackPanel.setDataContext(n),this.playbackCanvas.setDataContext(n)},onDataContextChanged:function(t){var i=t.item,u,e,f;this._updateExpandState(t),this._updateWaitingState(t),this.isPlaybackPanelVisible=!n&&!!i,this.isUserIdle=!t.hasUserPaused&&t.isPlaying&&!t.isSeeking&&t.userSeekTime==-1&&this._isUserIdle,this.isLoading=t.isLoading,u=!!(i&&i.video&&!t.canPlay&&!t.hasError&&i.thumbnailSet),t.posterImage||(u?(e=i.thumbnailSet,f=r.pickThumbnail(i.thumbnailSet,this.canvasSize.width,this.canvasSize.height),this.dataContext.setData({posterImage:{url:e.baseUrl+f.url,containerSize:this.canvasSize,originalSize:f,imagePosition:{}}})):t.setData({posterImage:{url:null}})),this.isPosterVisible=u&&!n,n||this.posterImage.setDataContext(t.posterImage),mix(this,{hasError:t.hasError,errorMessage:t.errorMessage,debugMessage:t.debugMessage,isPlaying:t.isPlaying,isLoading:t.isLoading,isWaiting:t.isWaiting,videoCanvasType:t.videoCanvasType,useStreaming:t.useStreaming,currentTime:t.currentTime,duration:t.duration,volume:t.volume,isMuted:t.isMuted,isExpanded:t.isExpanded,autoAdjustQuality:t.autoAdjustQuality,playingVideoQuality:t.playingVideoQuality,bufferingVideoQuality:t.bufferingVideoQuality,userVideoQuality:t.userVideoQuality})},onActivate:function(n){this._updateExpandState(n),this.onResize(),this.addElementListener(document,"fullscreenchange",this._onFullScreenChanged),this.addElementListener(document,"webkitfullscreenchange",this._onFullScreenChanged),this.addElementListener(document,"mozfullscreenchange",this._onFullScreenChanged),this.addElementListener(document,"MSFullscreenChange",this._onFullScreenChanged)},onDeactivate:function(){this._updateWaitingState()},onResize:function(){var t=this.subElements,n;t&&(n=getRect(t.canvasControl),this.canvasSize={width:n.width,height:n.height},this.dataContext.posterImage=null,this.change())},_updateWaitingState:function(i){var r=window.$header;r&&!n&&(this.isActive&&i&&(i.isWaiting||i.isSeeking||i.isLoading)?this._hasStartedWaiting||(Trace.log("Showing waiting state",t),this._hasStartedWaiting=!0,r.showLoading()):this._hasStartedWaiting&&(Trace.log("Hiding waiting state",t),this._hasStartedWaiting=!1,r.hideLoading()))},_onCanvasClicked:function(){var t=!0,i;return n||(i=this.dataContext,i.isExpanded&&this.isUserIdle?(this._isUserIdle=!1,this.change()):this.playbackPanel._onPlayClicked(null),this.playbackPanel.focus(),t=!1),t},_onCanvasDoubleClicked:function(){var t=!0;return n||(this.dataContext.setData({isExpanded:!this.dataContext.isExpanded}),t=!1),t},_onFullScreenChanged:function(){var t=this.dataContext,n=this._getFullScreenState();this.isFullScreen=this._isUserIdle=n,t.setData({isExpanded:n})},_onKeyDown:function(n){return this.playbackPanel._onKeyDown(n)},_onMouseMove:function(n){(this._lastMouseX!=n.clientX||this._lastMouseY!=n.clientY)&&(this._lastMouseX=n.clientX,this._lastMouseY=n.clientY,this._isUserIdle&&(this._isUserIdle=!1,this.change()),this.clearTimeout(this._userIdleTimer),this._userIdleTimer=this.setTimeout(this._onUserIdle,i))},_onUserIdle:function(){this.dataContext.isPlaying?(this._userIdleTimer=0,this._isUserIdle=!0,this.change()):this._userIdleTimer=this.setTimeout(this._onUserIdle,i)},_updateExpandState:function(n){var i=this.element,t=this.isFullScreen||this.isFullWindow;i&&(n.isExpanded&&!t?this._enterFullScreen():!n.isExpanded&&t&&this._exitFullScreen())},_getFullScreenState:function(){var n=document;return!!(n.fullscreenElement||n.msFullscreenElement||n.mozFullScreenElement||n.webkitFullscreenElement)},_enterFullScreen:function(){var n=this,i=document.body,r=document;n._enterFullWindow(),Trace.log("enterFullScreen()",t),i.requestFullScreen?(i.requestFullScreen(),n.isFullScreen=!!r.fullScreenElement):i.msRequestFullscreen?(i.msRequestFullscreen(),n.isFullScreen=!!r.msFullscreenElement):i.mozRequestFullScreen?(i.mozRequestFullScreen(),n.isFullScreen=!!r.mozFullScreenElement):i.webkitRequestFullScreen&&(i.webkitRequestFullScreen(),n.isFullScreen=!!r.webkitFullScreenElement),n.setTimeout(function(){n.resize(),n.playbackPanel.focus()},100)},_exitFullScreen:function(){var i=this,n=document;Trace.log("exitFullScreen()",t),i._exitFullWindow(),i.isFullScreen&&(i.isFullScreen=!1,n.exitFullScreen?n.exitFullScreen():n.msExitFullscreen?n.msExitFullscreen():n.mozCancelFullScreen?n.mozCancelFullScreen():n.webkitCancelFullScreen&&n.webkitCancelFullScreen()),i.setTimeout(function(){i.resize(),i.playbackPanel.focus()},100)},_enterFullWindow:function(){this.isFullWindow||(Trace.log("enterFullWindow()",t),this.isFullWindow=!0,toggleClass(document.body,"videoFullWindow",!0))},_exitFullWindow:function(){this.isFullWindow&&(Trace.log("exitFullWindow()",t),this.isFullWindow=!1,toggleClass(document.body,"videoFullWindow",!1))},_getCanvasType:function(n){return n.videoCanvasType?SkyDrive.UI[n.videoCanvasType]:null}})})()}),define("VideoPlayer.html.js",["VideoPlayer.js"],function(){SkyDrive.UI.VideoPlayer.prototype.onRenderHtml=function(){return"<"+this.baseTag+' id="'+htmlAttributeEncode(this.id+"_0")+'"'+(this.baseStyle?' style="'+this.baseStyle+'"':"")+' class="c-'+this.controlName+" "+this.baseClass+""+generateClassAttribute("isFullWindow",this.isFullWindow,"isFullScreen",this.isFullScreen,"isUserIdle",this.isUserIdle,"hasError",this.hasError,"showPoster",this.isPosterVisible,"isLoading",this.isLoading)+'"><div class="canvas"><div id="'+htmlAttributeEncode(this.id+"_1")+'" class="canvasControl">'+this.playbackCanvas.renderHtml()+this.posterImage.renderHtml()+'<\/div><div class="errorMessage"><span id="'+htmlAttributeEncode(this.id+"_2")+'">'+htmlEncode(this.errorMessage)+'<\/span><br><\/br><span id="'+htmlAttributeEncode(this.id+"_3")+'">'+htmlEncode(this.debugMessage)+'<\/span><\/div><\/div><div id="'+htmlAttributeEncode(this.id+"_4")+'" class="canvasOverlay"><\/div><div id="'+htmlAttributeEncode(this.id+"_5")+'" style="'+generateStyleAttribute("display",this.isPlaybackPanelVisible)+'">'+this.playbackPanel.renderHtml()+"<\/div><\/"+this.baseTag+">"},processAnnotations(SkyDrive.UI.VideoPlayer,[{id:0,className:["isFullWindow","isFullWindow","isFullScreen","isFullScreen","isUserIdle","isUserIdle","hasError","hasError","showPoster","isPosterVisible","isLoading","isLoading"],userActions:{mousemove:"_onMouseMove"}},{id:1,childId:"canvasControl"},{id:2,attr:["text","errorMessage"]},{id:3,attr:["text","debugMessage"]},{id:4,childId:"playbackCanvas",userActions:{click:"_onCanvasClicked",dblclick:"_onCanvasDoubleClicked"}},{id:5,css:["display","isPlaybackPanelVisible"]}],["isPlaying","isLoading","isWaiting","videoCanvasType","useStreaming","currentTime","duration","volume","isMuted","isExpanded","autoAdjustQuality","playingVideoQuality","bufferingVideoQuality","userVideoQuality","hasError","errorMessage"],{playbackPanel:SkyDrive.UI.PlaybackPanel})}),define("immersiveViewer.js",["ImageTile.js","PageStats.js","NewControlAdapter.js","AleHelpers.js","ItemActionHelper.js"],function(){(function(){var t=wLive.Core,s=t.ItemActionHelper,f=t.AleHelpers.getString,e=t.AleHelpers.getPCString,i=JBase.UI.ImageStripHelper,n,o,r="{0}&zippath={1}",h="formats/cubemap/cubemap.json",c="/GetDownloadUrl/?{cidQueryString}{resIdQueryString}{authKeyQueryString}&canary={FilesConfig.canary:encodeURIComponent}&Open=true",l=27,a=32,v=.05,u=null,y=e("Map.ZoomIn"),p=e("Map.ZoomOut");defineSubClass("SkyDrive.UI.ImmersiveViewer",JBase.UI.BaseControl,function(){n=n||t.PageController.getInstance()&&t.PageController.getInstance().getViewContext(),o=jQuery(n),this._viewer=null,this._dataSources=[],this._worldConfiguration=null,this.isInEmbedMode=n.viewParams&&n.viewParams.mode=="interactiveEmbed",this.isInIterativeMode=n.viewParams&&n.viewParams.mode!=="interactive"&&!this.isInEmbedMode,this.viewerLoading=!0,this.isMouseDown=!1,this.forceShowInteractiveModeButton=this.isInIterativeMode,this.errorLoadingPanorama=!1,this._isGoingClockwise=!0,this.backButton=this.createChild(JBase.UI.ImageTile),this.interactiveModeButton=this.createChild(JBase.UI.ImageTile),this.backButton.setDataContext(i.getImageInfo("PanoBackRest")),this.interactiveModeButton.setDataContext(i.getImageInfo("InteractiveModeButtonRest")),$B.Mobile||(this._createCssRulesForInteractiveModeControl("sivZoomInButton","PanoZoomIn"),this._createCssRulesForInteractiveModeControl("sivZoomOutButton","PanoZoomOut"),this._createCssRulesForInteractiveModeControl("sivExitInteractiveModeButton","PanoBack",!0)),this._createCssRulesForInteractiveModeControl("sivInteractiveModeButton","InteractiveModeButton",!0),$B.IE&&!$B.Mobile&&this._addIECursorCSSRules()},{interactiveModeText:f("ImmersiveViewer.EnterInteractiveMode"),interactiveModeLabel:f("ImmersiveViewer.EnterInteractiveModeAria"),onDataContextChanged:function(n){var i=this,e=n.item||{},f,u;"undefined"!=typeof $header&&$header.showLoading(),this._viewer&&this._viewer.dispose(),this._viewer=null,f=s.itemStringFormat(c,e),u=new t.DataRequest(f,f,null,function(n){var t=n.DownloadUrl,u=r.format(t,h);require(["siv.js"],function(){var n=new Microsoft.ImmersiveViewer.PhotosynthSivDataSource;i._dataSources=[n],n.createFromJsonUri(u,i._onDataSourceCreated.bind(i),function(){return r.format(t,"")},!0,!0)})},function(){i._handleError()}),u.apiId="SkyDrive_Json_GetDownloadUrl",u.propertyId="SkyDrive",u.start()},startAutoPan:function(){this._viewer&&(this._handlePanning(),u=this._handlePanning.bind(this),this._viewer.viewChangeEndEvent.addEventListener(u))},stopAutoPan:function(){var n=this._viewer;n&&(n.setView(n.getPitch(),n.getHeading(),n.getVerticalFov()),n.viewChangeEndEvent.removeEventListener(u))},resetView:function(){if(this._viewer&&this._worldConfiguration){var n=this._worldConfiguration.source;this._viewer.setView(n?n.startingPitch:0,n?n.startingHeading:0,Math.PI),this._isGoingClockwise=!0}},exitInteractiveMode:function(){this.isInEmbedMode||(this.isInIterativeMode=!0,this._updateBindings(),this._viewer&&(this.resetView(),this.startAutoPan(),this._viewer.setIsInteractive(!1),document.activeElement&&document.activeElement.blur()))},enterInteractiveMode:function(){this.isInIterativeMode=!1,this.forceShowInteractiveModeButton=!1,this._updateBindings(),this._viewer&&(this.stopAutoPan(),this._viewer.setIsInteractive(!0),this._viewer.setFocus())},onActivate:function(){!this._viewer&&this._worldConfiguration&&this._instantiateViewer()},onDeactivate:function(){this._viewer&&this._viewer.dispose(),"undefined"!=typeof $header&&$header.hideLoading()},_onExitInteractiveButtonClick:function(){var t=n.actionManager;return t.doAction(t.getAction("ViewItem",this.dataContext.item)),!1},_onEnterInteractiveButtonClick:function(){var t=n.actionManager;return t.doAction(t.getAction("ViewItemInInteractiveMode",this.dataContext.item)),!1},_onClick:function(){return this.isInIterativeMode},_handleTouch:function(){return this.isInIterativeMode},_onRightClick:function(){return!1},_onKeyDown:function(n){var t=this.isInIterativeMode;return t||n.which!==l?n.which===a&&(t=!0):this._onExitInteractiveButtonClick(),t},_onMouseDown:function(){return this.isMouseDown=!0,this.isInEmbedMode&&this.stopAutoPan(),this._updateBindings(),this.isInIterativeMode},_onMouseUp:function(){return this.isMouseDown=!1,this._updateBindings(),this.isInIterativeMode},_onMouseOut:function(){this.forceShowInteractiveModeButton=!1,this._updateBindings()},resize:function(){this._viewer&&this._viewer.setViewportSize(this.element.offsetWidth,this.element.offsetHeight)},_getAbsoluteUrl:function(n){return this._getZipPathUrl(n,"")},_getZipPathUrl:function(n,t){return n&&n.urls&&n.urls.open?r.format(n.urls.open,t):""},_onDataSourceCreated:function(n){this._worldConfiguration=n,n?this._instantiateViewer():this._handleError()},_addIECursorCSSRules:function(){var n=document.styleSheets[0];n&&(n.addRule(".IE .c-ImmersiveViewer .sivContainer","cursor:url("+FilesConfig.imgBaseUrl+"/grab.cur),default"),n.addRule(".IE .c-ImmersiveViewer .mouseDown .sivContainer","cursor:url("+FilesConfig.imgBaseUrl+"/grabbing.cur),default"),n.addRule(".IE .c-ImmersiveViewer .isInIterativeMode .sivContainer","cursor:url("+FilesConfig.imgBaseUrl+"/Zoom_Out.cur),default"))},_createCssRulesForInteractiveModeControl:function(n,t,r){var u=r?".c-ImmersiveViewer .{0} img{1} {left: {2}px; top: {3}px;}":".c-ImmersiveViewer .{0}{1} img {background-position: {2}px {3}px;}",e=i.getImageInfo(t+"Rest"),o=i.getImageInfo(t+"Hover"),s=i.getImageInfo(t+"Active"),f=document.styleSheets[0];try{f.insertRule(u.format(n,":active",s.imagePosition.left,s.imagePosition.top),0),f.insertRule(u.format(n,":hover",o.imagePosition.left,o.imagePosition.top),0),f.insertRule(u.format(n,"",e.imagePosition.left,e.imagePosition.top),0)}catch(h){}},_handleError:function(){this.errorLoadingPanorama=!0,o.trigger("immersiveViewerError")},_instantiateViewer:function(){var i,r,u;this.element&&(this._viewer=new Microsoft.ImmersiveViewer.SharedImmersiveViewer(this.subElements.sivContainer,{dataSources:this._dataSources,backgroundColor:null,width:this.element.offsetWidth,height:this.element.offsetHeight}),this.viewerLoading=!1,n.viewParams&&(n.viewParams.mode==="interactive"||n.viewParams.mode==="interactiveEmbed")?(this.enterInteractiveMode(),this.isInEmbedMode&&this.startAutoPan()):this.exitInteractiveMode(),i=jQuery(this.subElements.sivContainer),t.ImageStrip&&(r=i.find(".sivZoomInButton").attr({tabindex:"-1","aria-label":y}).html(t.ImageStrip.getImage("PanoZoomInRest")).find("img").css("background-position",""),u=i.find(".sivZoomOutButton").attr({tabindex:"-1","aria-label":p}).html(t.ImageStrip.getImage("PanoZoomOutRest")).find("img").css("background-position",""),sutra(r,"$Sutra.SkyDrive.SivZoomInButton"),sutra(u,"$Sutra.SkyDrive.SivZoomOutButton")),jQuery(this.subElements.enterInteractiveButton).find("img").css({left:"",top:""}),jQuery(this.subElements.exitInteractiveButton).find("img").css({left:"",top:""}),"undefined"!=typeof $header&&$header.hideLoading())},_handlePanning:function(){var t=this._viewer,e=this,a;if(this.isInIterativeMode||this.isInEmbedMode){var n=t.getBounds(),i=n.right||Math.PI,f=(n.right>n.left?n.left:n.left-2*Math.PI)||-Math.PI,o=n.top||Math.PI/2,c=n.bottom||-Math.PI/2,l=i-f,y=o-c,p=l>=y,r=t.getHeading(),s=t.getPitch(),u=r,h=s;p?l==Math.PI*2?r==i||r==f?(u=0,this._isGoingClockwise=!this._isGoingClockwise):u=this._isGoingClockwise?i:f:u=r<i?i:f:h=s<o?o:c,a=(Math.abs(u-r)+Math.abs(h-s))*1e3/v,setTimeout(function(){e.isActive&&(e.isInIterativeMode||e.isInEmbedMode)&&t.setView(h,u,t.getVerticalFov(),!0,a)},1e3)}else this.stopAutoPan()}}),defineSubClass("wLive.Controls.ImmersiveViewer",SkyDrive.UI.NewControlAdapter,function(){},{controlType:SkyDrive.UI.ImmersiveViewer})})()}),define("immersiveViewer.html.js",["immersiveViewer.js"],function(){SkyDrive.UI.ImmersiveViewer.prototype.onRenderHtml=function(){return"<"+this.baseTag+""+sutraAttribute("SkyDrive.ImmersiveViewer")+' id="'+htmlAttributeEncode(this.id+"_0")+'"'+(this.baseStyle?' style="'+this.baseStyle+'"':"")+' class="c-'+this.controlName+" "+this.baseClass+'"><div id="'+htmlAttributeEncode(this.id+"_1")+'" class="'+generateClassAttribute("isInIterativeMode",this.isInIterativeMode,"mouseDown",this.isMouseDown,"viewerLoading",this.viewerLoading,"notYetLeft",this.forceShowInteractiveModeButton,"isInEmbedMode",this.isInEmbedMode)+'"><div'+sutraAttribute("SkyDrive.ImmersiveViewerSivContainer")+' id="'+htmlAttributeEncode(this.id+"_2")+'" class="sivContainer"><\/div><a'+sutraAttribute("SkyDrive.ImmersiveViewerEnterInteractiveMode")+' id="'+htmlAttributeEncode(this.id+"_3")+'" class="sivInteractiveModeButton selfAnimate"'+generateAttributesString("aria-label",this.interactiveModeLabel)+">"+this.interactiveModeButton.renderHtml()+"<\/a><a"+sutraAttribute("SkyDrive.ImmersiveViewerExitInteractiveMode")+' id="'+htmlAttributeEncode(this.id+"_4")+'" class="sivExitInteractiveModeButton">'+this.backButton.renderHtml()+"<\/a><\/div><\/"+this.baseTag+">"},processAnnotations(SkyDrive.UI.ImmersiveViewer,[{id:0},{id:1,className:["isInIterativeMode","isInIterativeMode","mouseDown","isMouseDown","viewerLoading","viewerLoading","notYetLeft","forceShowInteractiveModeButton","isInEmbedMode","isInEmbedMode"],childId:"eventEater",userActions:{click:"_onClick",contextmenu:"_onRightClick",keydown:"_onKeyDown",keypress:"_onKeyDown",mousedown:"_onMouseDown",mouseup:"_onMouseUp",mouseout:"_onMouseOut",touchstart:"_handleTouch",touchend:"_handleTouch",touchmove:"_handleTouch",MSPointerDown:"_onMouseDown",MSPointerMove:"_handleTouch",MSPointerUp:"_onMouseUp",pointermove:"_handleTouch",pointerup:"_onMouseUp"}},{id:2,childId:"sivContainer"},{id:3,attr:["aria-label","interactiveModeLabel"],childId:"enterInteractiveButton",userActions:{click:"_onEnterInteractiveButtonClick"}},{id:4,childId:"exitInteractiveButton",userActions:{click:"_onExitInteractiveButtonClick"}}],[],{})}),define("ChallengeHelper.js",["InfoPaneHeader.js","VideoPlayer.html.js","immersiveViewer.html.js","SearchBox.js","PageController.js","themes.js"],function(){(function(){var r=wLive.Core,n=r.AleHelpers.getPCString,o=wLive.Controls,s=4,c=FilesConfig,l='<a id="cofcLnk" target="_blank" href="'+c.codeOfConductLink+'">',a="<\/a>",v='<span id="chSpin"><\/span>',y=FilesConfig.baseApiUrl,p="OwnerRequestReview",h=y+p,w=0,f=!1,u,i,e,t,b=n("ReportAbuse.Submitting");r.ChallengeHelper={ownerCanRequestReview:function(n){var t=n.getParent(!0),i=t&&t.sharingLevelValue===s;return!n.folder&&n.itemStatus&&n.itemStatus>0&&n.itemStatus<3&&n.isViewerOwner()&&(n.sharingLevelValue!=s||!i)},showChallengeDialog:function(s){function yt(i,e,o){if(o==="action"){if(f){c&&c.dismiss();return}c.getButton({buttonName:"action"}).prop("disabled",!0),t&&t.show(),u=new r.DataRequest(h+w++,h,vt,function(){for(var r,u=s.length,i=0;i<u;i++)r=s[i],r.expire(!0),r.invalidate();lt(n("OwnerRequestReview.RequestSucceededTitle"),n("OwnerRequestReview.RequestSucceededBody"))},function(){lt(n("OwnerRequestReview.RequestFailedTitle"),n("OwnerRequestReview.RequestFailedBody"))}),u.apiId="SkyDrive_Json_OwnerRequestReview",u.propertyId="SkyDrive",u.start()}else c&&c.dismiss()}function lt(r,u){t&&t.hide(),i.text(n("Close")),sutra(i,"$Sutra.SkyDrive.OwnerRequestReviewCloseBtn"),e.hide(),jQuery("div.ModalDialog div.UserTitle").text(r),tt.html("<div>"+u+"<\/div>"),c&&c.reposition(),f=!0,i&&i.prop("disabled",!1)}for(var tt=jQuery('<div class="orr_review_wrapper"><\/div>'),rt=$Config.email,ut=s?s.length:0,at=ut>1,it=!1,ft=[],d,y,et,p,nt,ct,k=0;k<ut;k++)d=s[k],!it&&d.folder&&(it=!0),r.ChallengeHelper.ownerCanRequestReview(d)&&ft.push(d.id);y="",y=at?it?n("OwnerRequestReview.MultipleItemsSubfolders"):n("OwnerRequestReview.MultipleItems"):n("OwnerRequestReview.SingleItem"),et=y.format(l,a,rt),tt.html("<p>"+et+"<\/p>");var vt=Object.toJSON({ids:ft,email:rt}),g=o.Notifications,c=g.createModalDialog({buttons:{action:n("OwnerRequestReview.RequestReviewButtonText"),close:n("OwnerRequestReview.CloseButtonText")},content:tt[0],title:n("OwnerRequestReview.DialogTitle"),options:{dismissOnButtonClick:!1}});p=jQuery(c),p.bind({"aftershow._dlg":function(){f=!1;var u=jQuery(c.content());jQuery("div.NotificationArea",u).prepend(v).show(),i=c.getButton({buttonName:"action"}),e=c.getButton({buttonName:"close"}),t=jQuery("#chSpin"),t&&t.hide(),_loadingSpinner=new o.LoadingSpinner(t,b),_loadingSpinner.render(),sutra(u,"$Sutra.SkyDrive.OwnerRequestReviewPopover"),sutra(jQuery(".UserTitle",u),"$Sutra.SkyDrive.OwnerRequestReviewTitle"),sutra(jQuery(".orr_review_wrapper",u),"$Sutra.SkyDrive.OwnerRequestReviewMessageBody"),sutra(i,"$Sutra.SkyDrive.OwnerRequestReviewReportBtn"),sutra(e,"$Sutra.SkyDrive.OwnerRequestReviewCancelBtn")},"afterdismiss._dlg":function(){p&&p.unbind("._dlg"),p=null,c=null},"buttonclick._dlg":yt});var ot=g&&g.getQueue(),st=g.BarDismissalMode,ht=jQuery.merge(ot.getNotificationBars(function(n){var t=n.dismissalMode();return t===st.Implicit||t===st.Timeout}),ot.getFlyouts());for(nt=ht.length-1;nt>=0;nt--)ht[nt].dismiss();ct=jQuery(".NotificationBar"),ct.hide(),c.show()}}})()}),define("FilmStripItem.js",["ChallengeHelper.js"],function(){(function(){function e(r,e){function p(){e.delayVideo=!1}var h=this,w=e.dataModel,c;r.html(f);var o=jQuery("a.filmStripI",r),y=jQuery(".filmStripIe",o),s=jQuery(".filmStripIb",o),l=jQuery(".filmStripIc",o),a={iw:!0,sm:!0},v=new n.ItemTile(l,e,a);o.bind(u,p),s.bind("contextmenu",function(n){return n.shiftKey?undefined:(v.showContextMenu(n),!1)}),sutra(o,"$Sutra.SkyDrive.FilmStripItem"),h.select=function(){s.addClass(i)},h.deselect=function(){s.removeClass(i)},h.render=function(n,i,r){var u,f;c&&n&&c.key==n.key||(c=n,n?(u=Math.round(n.getRotationState()*90),s.removeClass("rotate90 rotate180 rotate270"),u&&s.addClass("rotate"+u),y.hide(),l.show(),a.w=i,a.h=r,v.render(n),s.width(i-t*2),s.height(r-t*2),f=e.actionManager.getAction("ViewItem",n),f&&wLive.Core.ActionManager.setATagAction(f,o),o.attr("title",n.name)):(y.show(),l.hide()))},h.resize=function(){},h.dispose=function(){o.unbind(),v.dispose()}}var n=wLive.Controls,r=wLive.Core,o=r.AleHelpers.getPCString,t=3,u="click",s="href",i="filmStripIs",f='<a class="filmStripI"><span class="filmStripIb"><\/span><span class="filmStripIe"><\/span><span class="filmStripIc"><\/span><\/a>';n.FilmStripItem=e})()}),define("FilmStrip.js",["FilmStripItem.js"],function(){(function(){function b(b,k,d){function or(){lt.addObjectListener(rr,f.DataModel.dataChangedEvent,yr,"SkyDriveWeb_Internal_Control_FilmStrip_DataChanged")}function ki(n){var i=bi,t;if(n&&(t=n.thumbnailSet?n.thumbnailSet.size:null,t)){var r=n.getRotationState()%2!=0,u=r?t.height:t.width,f=r?t.width:t.height;i=f>kt?parseInt(1*u/f*kt):u}return Math.max(ur,Math.min(fr,i))}function di(){yi(),lr();var n=yt();nt=it=vt=st=rt=ft=n,ui(),ri()}function gi(){!et&&(st==-1||nt<rt||nt>ft)||et&&it<rt||it>ft?di():((nt<=st||it<=vt)&&ui(),(nt>=st||it>=vt)&&ri(),sr(),st=nt)}function sr(){var i=0,r=0,u;if(et?(i=vt,r=it):ci?(i=it,r=nt,ci=!1,vt=it=nt):(i=st,r=nt),u=0,i>r){for(;i>r;r++)u+=g[r][0].w+n;dt-=u}else if(i<r){for(;i<r;i++)u+=g[i][0].w+n;dt+=u}et||(g[st]&&g[st].data(t).deselect(),g[nt]&&g[nt].data(t).select())}function ri(){ht||(ht=setTimeout(hr,h))}function hr(){var r,h;ht=null;var u=yt(),t=ft+1,i=g[ft].offset().left-g[u].offset().left,f=0,e=!1,s=tt.getChildren();if(i==0&&nt!=ft)for(t=u+1;t<=ft;t++)i+=g[t][0].w+n;for(r=s.getCount(),_maxLength=r;t<r&&i<wt;t++)if(h=s.get(t),pi(h,t,1),ft=t,i+=g[t][0].w+n,e=!0,f++,i<wt&&o<=f){ri();break}(i>=wt||t==r)&&(ai=!0,nr()),e&&bt(!0)}function ui(){ct||(ct=setTimeout(cr,h))}function cr(){var e;ct=null;var r=yt(),t=rt-1,i=g[r].offset().left-g[rt].offset().left,u=0,f=!1,s=tt.getChildren();if(i==0&&r!=rt)for(t=r-1;t>=rt;t--)i+=g[t][0].w+n;for(;t>=0&&i<wt;t--)if(e=s.get(t),pi(e,t,0),rt=t,i+=g[t][0].w+n,f=!0,u++,i<wt&&o<=u){ui();break}(i>=wt||t<0)&&(vi=!0,nr()),f&&bt(!0)}function nr(){vi&&ai&&(wi.hide(),et||g[nt].data(t).select())}function lr(){var n=yt();pi(tt.getChildren().get(n),n,1)}function yi(){if(rt>-1)for(index=rt;index<=ft;index++)g[index].data(t).dispose(),delete g[index];ni={},rt=ft=st=-1,ti=oi=0,dt=0,gt=dt-ii,fi.css(i,gt),pt=0,at.width(pt),at.html(""),vi=!1,ai=!1,wi.show(),ht&&(clearTimeout(ht),ht=null),ct&&(clearTimeout(ct),ct=null),ot&&(clearTimeout(ot),ot=null)}function ar(n,t,i){var r=Math.floor(ut/2),h=Math.floor(ut*a),f=Math.floor(i/2),e=0-t-ti,o=e+f,s=n-o,u,c,l,v;return n<=ut?(c=Math.floor((ut-n)/2),u=c+e):o<r?(l=h*((r-o)/r),u=l+e):s<r?(v=h*((r-s)/r),u=ut-s-f-v):u=r-f,u}function bt(t){var e=yt(),f,o,u,h;e!=-1&&g[e]&&(f=-1*dt,o=g[e][0].w+n,f+=ar(pt,f,o),u={},d.disableAnimations||t||!d.fullView?(gt=f-ii,u[i]=gt,fi.css(u)):(ii=f-gt,u[i]=ii,at.stop(!0),d.useCSS3Animations?at.css(u):(h=jQuery.fx.interval,jQuery.fx.interval=s,at.animate(u,d.animationDuration-p,r),jQuery.fx.interval=h)))}function vr(n,r){var f=g[n],e=ki(r),o=e-f[0].w,s,h,c;f.width(e),f[0].w=e,pt+=o,tr();for(s in ni)s>n&&(h=g[s],h.css(i,h.position().left+o));n<yt()&&(dt+=o),c=f.data(t),c.render(r,e,u)}function pi(r,f,o){var h=bi,c,s,l;r&&(h=ki(r)),c=h+n,s=jQuery('<div class="filmstripi"><\/div>'),s.width(h).height(kt),s[0].w=h,pt+=c,at.width(pt),tr(),o?(at.append(s),s.css(i,oi),oi+=c):(at.prepend(s),ti-=c,s.css(i,ti)),l=new e.FilmStripItem(s,k),l.render(r,h,u),g[f]=s,r||(ni[f]=1),s.data(t,l)}function tr(){function n(){clearTimeout(ot),ot=null,tt&&nt!=-1&&(di(),bt(!0))}pt>5e4&&!ot&&(ot=setTimeout(n,0))}function yr(n){var t,i;if(tt&&tt.key==n.key){for(t in ni)i=tt.getChildren().peek(t),i&&vr(t,i);bt(!0)}}function ir(n){nt=n,n>=0&&et&&(ci=!0)&&(et=!1)}function yt(){return et?it:nt}var lt=this,pr=jQuery(k),rr=k.dataModel;b.html(w);var fi=jQuery(".filmstrip",b),at=jQuery(".filmstripa",b),wi=jQuery(".filmstripc",b),ei=jQuery(".filmstripb",b),g={},ni={},rt=-1,ti=0,ft=-1,oi=0,st=-1,pt=-1,tt,nt=-1,si,hi=!1,et=!1,ci=!1,it=-1,vt=-1,li,ut,kt=u,ur=Math.ceil(kt*2/3),fr=Math.floor(kt*9/2),er,wt,bi=kt,ot,dt=0,gt=0,ii=0,ht,ct,ai,vi;sutra(fi,"$Sutra.SkyDrive.FilmStrip"),lt.resize=function(){var n=b.width(),t;ut!=n&&(t=n>ut,ut=n,er=Math.ceil(v*ut),wt=Math.ceil(y*ut),tt&&nt!=-1&&(t&&(ui(),ri()),bt(!0)))},lt.resetState=function(){yi(),si=null,tt=null,ir(-1)},lt.render=function(n,t){var i=n.getVersion(),r=!tt||!n||!f.SkyDriveItem.areItemsSame(tt,n)||si!=i;si=i,tt=n,et&&(t==-1||nt==-1)||(ir(t),r&&(ut=0,lt.resize())),tt&&yt()>=0?(gi(),bt(r)):yi()},lt.dispose=function(){var i,n;ht&&(clearTimeout(ht),ht=null),ct&&(clearTimeout(ct),ct=null),ot&&(clearTimeout(ot),ot=null);for(i in g)n=g[i].data(t),n&&n.dispose()},lt.mouseScroll=function(n){var t;if(tt&&(t=n<0,li=tt.getChildren().getCount()-1,vt=yt(),it=t?Math.min(li,vt+l):Math.max(0,vt-l),et=!0,gi(),bt(!0),(it==0||it==li)&&!hi)){hi=!0,ei.stop();var i=(t?-1*c:c)/2,u=d.animationDuration/2,f=jQuery.fx.interval;jQuery.fx.interval=s,ei.animate({left:"+="+i},u,r),ei.animate({left:"-="+i},u,r,function(){hi=!1}),jQuery.fx.interval=f}},mix(lt,Shared.ObjectEventing),or()}var f=wLive.Core,e=wLive.Controls,n=1,a=.1,t="o",o=5,v=.5,y=1,p=50,r="linear",s=50,h=100,u=75,i=$B.ltr?"left":"right",w='<div class="filmstripb"><div class="filmstripc"><\/div><div class="filmstrip">   <div class="filmstripa"><\/div><\/div><\/div>',c=$B.rtl?-30:30,l=$B.rtl?-2:2;e.FilmStrip=b})()}),define("SelfItem.js",["FilmStrip.js"],function(){(function(){function ft(r,u,f){function at(n,t,i){n.width(t),n.height(i)}function dt(){var i=!1,u=r[0],n=u.w||r.width(),t=u.h||r.height();return(n!=bt||t!=kt)&&(bt=n,kt=t,i=!0,pt.w=f.cw=n,pt.h=f.ch=t,at(vt,n,t),at(ot,n,t),at(yt,n,t),at(lt,n,t)),i}function wt(n){return n&&n.isPanorama&&!s.errorLoadingPanorama()&&o}var s=this,gt=t.SkyDriveItemHelper,ni=u.dataModel,e,et;f=f||{},r.html(c);var vt=jQuery(".selfItem",r),ct=jQuery(".selfItemP",r),ot=jQuery(".selfItemV",r),st=jQuery(".selfItemTH",r),yt=jQuery(".selfItemTC",r),lt=jQuery(".selfItemSIV",r),bt,kt,pt={dt:!0,dv:!0,as:!0,sp:2,nms:f.nms},ht=new i.ItemTile(ct,u,pt),b,o,d,ft,k;ut&&(o=new i.ImmersiveViewer(lt,u)),$B.Mobile||f.ht?(st.hide(),yt.hide()):(ft=new i.TagHover(st,u,f),k=new i.TagCreate(yt,u,f)),s.isLoaded=function(){return d?d.isLoaded?d.isLoaded():!0:!1},s.enterInteractivePanoramaMode=function(){o&&o._controlInstance&&o._controlInstance.enterInteractiveMode()},s.exitInteractivePanoramaMode=function(){o&&o._controlInstance&&o._controlInstance.exitInteractiveMode()},s.startPanoramaAutoPan=function(){o&&o._controlInstance&&o._controlInstance.startAutoPan()},s.stopPanoramaAutoPan=function(){o&&o._controlInstance&&o._controlInstance.stopAutoPan()},s.errorLoadingPanorama=function(){return o&&o._controlInstance&&o._controlInstance.errorLoadingPanorama},s.showContextMenu=function(n){e&&!e.video&&ht.showContextMenu(n)},s.render=function(i,s,c){var ti=t.SkyDriveItem.areItemsSame(e,i),ut,yt,pt,kt;if(sutra(vt,"$Sutra.SkyDrive.SelfItem"),!s&&$B.IE&&$B.V<9&&r.css("filter",""),!ti||et!=s||c)if(et=s,e=i,dt(),st.hide(),e){if(e.photo||e.isWebPlayableVideo()||e.isProcessingVideo||(e.video&&!e.isWebPlayableVideo()?u.errorManager.add({$element:jQuery(rt),actionBtnName:h("DownloadCommand"),actionCallback:function(){var n=u.actionManager;n.doAction(n.getAction("Download",e))},priority:1,type:4}):u.errorManager.add({$element:jQuery(it),priority:1,type:4})),!u.isSuper&&e.itemStatus&&e.itemStatus>0){var bt=1,at=1,ii=ni.getItem(e.parentKey,!0);if(gt.isViewerOwner(e)){if(ii.sharingLevelValue!=4||e.sharingLevelValue!=4){ut="",yt=null,at=e.itemStatus;switch(e.itemStatus){case 2:ut=a;break;case 3:ut=v;break;case 4:ut=y;break;case 5:ut=p;break;case 6:ut=w;break;default:ut=l}ut="<div>"+ut+"<\/div>",pt=null,kt=t.ChallengeHelper.ownerCanRequestReview(e),kt&&(ut+=tt,pt=g),yt=jQuery(ut),u.errorManager.add({$element:yt,actionBtnName:pt,actionCallback:function(){var r=e.reviewState&&e.reviewState==t.ReviewState.ChallengeReviewed,n;$B.Mobile||r?$BSI.navigateTo(nt,"_blank"):(n=[],n.push(i),u.operationManager.execute("OwnerRequestReview",{items:n}))},priority:1,type:4})}}else bt=2,at=e.itemStatus==2?2:1,u.errorManager.add({$element:jQuery("<span>"+n("RestrictedNotification.Visitor")+"<\/span>"),priority:1,type:4});$BSI.reportEvent("SkyDrive.Abuse.TargetedTakedown",{RestrictedType:bt,RestrictedReason:at})}d=null,e&&e.video||e.isProcessingVideo||wt(e)?ct.hide():(d=ht,ct.show(),ht.render(e,s)),e.isWebPlayableVideo()&&!s?(f.te=!0,ot.show(),b||(b=new SkyDrive.UI.VideoPlayer,ot.html(b.renderHtml())),d=b,b.activate(),b.setDataContext({item:e})):(f.te=!1,ot.hide(),s||(f.te=!0,ft&&(st.show(),ft.render(e))),!i.video&&i.isProcessingVideo&&u.errorManager.add({$element:jQuery("<span>"+n("Video.BeingProcessedHeader")+". "+n("Video.BeingProcessedMessage")+"<\/span>"),priority:1,type:4})),wt(e)&&!s?(lt.show(),d=o,o.render(e),o.resize(),st.hide()):lt.hide()}else ct.hide(),ot.hide();et||k&&k.render(e)},s.stop=function(){k&&k.stop()},s.unset=function(){unsutra(vt),b&&(b.setDataContext(null),b.deactivate())},s.resize=function(){dt()&&e&&(wt(e)?o.resize():ht.resize(),e.photo&&!et&&ft&&ft.resize(),et||e.video&&b&&b.resize()),et||k&&k.resize()},s.dispose=function(){ht.dispose(),b&&b.dispose(),ft&&ft.dispose(),k&&k.dispose(),o&&o.dispose()}}var t=wLive.Core,i=wLive.Controls,n=t.AleHelpers.getString,h=t.AleHelpers.getPCString,u=FilesConfig,c='<div class="selfItem"><div class="selfItemP"><\/div><div class="selfItemV"><\/div><div class="selfItemSIV"><\/div><div class="selfItemTH"><\/div><div class="selfItemTC"><\/div><\/div>',o='<a target="_blank" href="{0}">',f="<\/a>",s=o.format(u.codeOfConductLink.encodeHtmlAttribute()),l=n("RestrictedNotification.Owner").format(s,f),a=n("RestrictedNotification.OwnerICN").format(s,f),r=n("RestrictedNotification.OwnerFurtherViolations"),v=n("RestrictedNotification.OwnerDMCA")+" "+r,y=n("RestrictedNotification.OwnerTM")+" "+r,p=n("RestrictedNotification.OwnerLCL")+" "+r,w=n("RestrictedNotification.OwnerOPT")+" "+r,b=n("Video.LoadError"),k=n("Video.UnsupportedFormat"),d=o.format(u.contactUsLink.encodeHtmlAttribute()),e;e=$B.Mobile?n("RestrictedNotification.OwnerContactUs").format(d,f):n("RestrictedNotification.OwnerContactUs").format("","");var g=n("RestrictedNotification.ContactUs"),nt=u.contactUsLink,tt="<div>"+e+"<\/div>",it="<div>"+b+"<\/div>",rt="<div>"+k+"<\/div>",ut=!!document.createElement("canvas").getContext;i.SelfItem=ft})()}),define("TagHover.js",["SelfItem.js"],function(){(function(){function u(u,f,e){function k(){var i,r,t,c,v,b,f,p,h,n,k,w;if(u.empty(),u.show(),y=[],o=null,i=s.peopleTags,r=s.ocr&&s.ocr.entityTags,i||r){for(t=jQuery("<div><\/div>"),sutra(t,"$Sutra.SkyDrive.TagBoxContainer"),c=0;i&&c<i.length;c++)v=i[c],b=v.rect,b&&(f=b.split(","),f.length==4&&f[2]!=0&&f[3]!=0&&(p=jQuery("<div id=tagBox_"+v.id+" class='th_tag_box'><div class='th_tag_box_inner'><\/div><div class='th_tag_name'><span class='th_tag_name_bg'>"+v.name.encodeHtml()+"<\/span><\/div><\/div>"),sutra(p,"$Sutra.SkyDrive.TagBox"),g(p,f),t.append(p)));for(h=0;r&&h<r.length;h++)n=r[h],n&&(k=[n.topLeftX/s.photo.width,n.topLeftY/s.photo.height,(n.btmRightY-n.topLeftX)/s.photo.width,(n.btmRightX-n.topLeftY)/s.photo.height],w=jQuery("<div id=tagBox_e"+h+" class='th_tag_box th_entity'><\/div>"),sutra(w,"$Sutra.SkyDrive.TagBox"),g(w,k),t.append(w));u.html(t),l=jQuery(".th_tag_box",t),a=jQuery(".th_tag_name",l),a.show(),e.tm&&tt()}}function g(n,t){var s=e.cw,h=e.ch,i=s*t[0],r=h*t[1],f=s*t[2],o=h*t[3];i<0?i=0:i+f>s-c*2&&(i=s-f-c*2),r<0?r=0:r+o>h-c*2&&(r=h-o-c*2),n.css("left",i).css("top",r).css("width",f).css("height",o),i+=u.offset().left+c,r+=u.offset().top+c,y.push({elem:n,top:r,left:i,bottom:r+o,right:i+f,x:i+f/2,y:r+o/2})}function ut(n){var o=e.cw,s=u.offset(),i=s.left,t=jQuery(".th_tag_name",n),r=jQuery(".th_tag_name_bg",n),h=jQuery(".th_tag_box_inner",n);if(h[0]){var a=h.offset().left,f=r.offset(),l=a-i+c/2;f.left>i+o-r.width()&&(t.css("right","auto"),t.css("left",-1*(l-(o-t.width())))),f.left<i&&(t.css("right","auto"),t.css("left",-1*l)),f.top>s.top+e.ch-r.height()&&t.css("top","-29px")}}function d(){var n=u.offset().top,t=u.offset().left;v={top:n,left:t,bottom:n+e.ch,right:t+e.cw}}function ft(){jQuery(f).bind("tagHoverEnter"+h,function(n,t,i){i==p&&nt(jQuery(_ge("tagBox_"+t)))}).bind("tagHoverLeave"+h,function(n,t,i){i==p&&w(jQuery(_ge("tagBox_"+t)))}).bind("reloadTags"+h,function(n,t){t==p&&k()}).bind("enableTagging"+h,function(){tt()}).bind("disableTagging"+h,function(){it()}),jQuery(document).bind("mousemove"+h,function(t){var r,u,i;e.tm||!e.te||n.PopoverHelpers.isPopoverVisible()||(r=t.pageX,u=t.pageY,y.length>0&&v.top<=u&&v.bottom>=u&&v.left<=r&&v.right>=r?(i=et(r,u),i?o!=i&&(o&&w(o),nt(i),o=i):o&&(w(o),o=null)):o&&(w(o),o=null))})}function et(n,t){for(var f,u,h=y.length,i,r=0;r<h;r++)if(i=y[r],i.top<=t&&i.bottom>=t&&i.left<=n&&i.right>=n){var e=i.x-n,o=i.y-t,s=e*e+o*o;(!u||f>s)&&(u=i.elem,f=s)}return u}function nt(n){n.length&&($B.IE&&$B.V<9?n.css("filter",""):n.css("opacity",n.hasClass("th_entity")?r:i),n.show(),e.tm||ut(n))}function w(n){n.length&&(e.tm?n.css("opacity",t):n.hide())}function tt(){l&&l.css("opacity",t).show(),a&&a.hide()}function it(){l&&l.hide(),a&&a.show()}var b=this;e=e||{};var rt=e.thc=e.thc?e.thc+1:1,h=".taghover"+rt,s,p,ot=e.tm,l,a,v={},y=[],o,c=4;d(),ft(),b.render=function(t){var i=!n.SkyDriveItem.areItemsSame(s,t);s=t,p=t.key,i&&(k(),d())},b.resize=function(){k(),d()},b.dispose=function(){it(),u.empty(),jQuery(f).unbind(h),jQuery(window).unbind(h)}}var n=wLive.Core,t="0.5",i="0.8",r="0.1";wLive.Controls.TagHover=u})()}),define("SelfNotificationBar.js",["TagHover.js"],function(){(function(){function s(s,h){function y(n){a.dismiss(),n.preventDefault()}function g(){var i,n;$B.Mobile?c.hide():(i=jQuery(".NotificationBar"),i.hide(),n=t.Notifications,n&&n.getQueue().reset())}function k(){var n=a.getErrors();n.length>0&&nt(n[0])}function nt(i){$B.Mobile?(b.html(i.$element),c.removeClass(r).removeClass(u).removeClass(f).addClass(i.type===0?r:i.type===1?u:f).show()):v?v.renderBar(i,y):(l.push(i),require(["NotificationHelper.js"],function(){for(v=new n.NotificationHelper(t.Notifications);l&&l.length;)v.renderBar(l.shift(),y)}))}var d=this,a=h.errorManager,w=jQuery(a),c=jQuery(e),p=c.find(".selfnbdismiss"),b=c.find(".selfnbcontent"),v,l;c.hide(),s.html(c),sutra(c,"$Sutra.SkyDrive.SelfNotificationBar"),sutra(b,"$Sutra.SkyDrive.SelfNotificationBarMessage"),sutra(p,"$Sutra.SkyDrive.SelfNotificationBarDismiss"),w.bind(a.errorClearedEventName+i,g).bind(a.errorReceivedEventName+i,k),p.bind("click",y).html(n.ImageStrip.getImage("close",o)),l=[],d.dispose=function(){w.unbind(i),p.unbind("click",y),l=null},k()}var n=wLive.Core,t=wLive.Controls;t.SelfNotificationBar=s;var i=".selfnb",e='<div class="selfnbcontainer"><a class="selfnbdismiss" href="#"><\/a><div class="selfnbcontent"><\/div><\/div>',r="selfnberror",u="selfnbwarning",f="selfnbinfo",o=n.AleHelpers.getPCString("PPickerClosePicker")})()}),define("TagModeStatusBar.js",["SelfNotificationBar.js"],function(){(function(){function s(i,s,h){var l=this,a,c,y,v;h=h||{},i.html(r),c=jQuery(".tsbar",i).hide(),sutra(c,"$Sutra.SkyDrive.TagStatusBar"),c.html('<span class="tsb_text"><\/span><input class="tsb_done" type="button" value="'+n("Tagging.TaggingModeClose")+'">'),y=jQuery(".tsb_text",c),v=jQuery(".tsb_done",c),sutra(v,"$Sutra.SkyDrive.TagStatusBarClose"),v.bind("click",function(){return h.tm=!1,jQuery(s).trigger("disableTagging"),!1}),jQuery(s).bind(u,function(){h.tm=!0,c.show()}).bind(f,function(){h.tm=!1,c.hide()}),l.render=function(n){if(!a||a.key!=n.key){a=n;var t=n.photo?e:o;y.html(t)}},l.resize=function(){},l.dispose=function(){jQuery(s).unbind(t),i.empty()}}var i=wLive.Core,n=i.AleHelpers.getPCString,r='<div class="tsbar"><\/div>',t=".tagStatusBar",u="enableTagging"+t,f="disableTagging"+t,e=n("Tagging.TaggingModePhoto"),o=n("Tagging.TaggingModeVideo");wLive.Controls.TagStatusBar=s})()}),define("PeoplePicker.js",["TagModeStatusBar.js"],function(){(function(){function d(n,d){function fi(){g.focus()}function ei(){g.bind("keyup.m",rr).bind("focus.m",nr).bind(k+".m",tr),yt.bind("submit",ir),h?g.bind("input.m",ur):(g.bind("cut.m",hi),g.bind("paste.m",hi)),tt=new $SB.PeoplePickerMenu(st,wi),tt._getHtml=tt.getHtml,tt.getHtml=pi}function yi(){at||(n.append(ai),rt=jQuery("."+l,n),g=jQuery("#"+o,n),yt=jQuery("form",n),ut=jQuery(f.format(i)).append(r.ImageStrip.getImage("ppGreyX",s,s)).hide().addClass(c),ft=jQuery(f.format(i)).append(r.ImageStrip.getImage("ppSearch")).addClass(c),jQuery(".searchBox",n).append(ft).append(ut),jQuery(".topRow",n),ut.bind("click",ni),ft.bind("click",function(){return!1}),sutra(n,"$Sutra.SkyDrive.PeoplePicker"),sutra(g,"$Sutra.SkyDrive.PeoplePickerSearchBox"),sutra(ut,"$Sutra.SkyDrive.PeoplePickerClearButton"),et=window.setTimeout(sr,b),require(["SearchBox.js"],ei),at=!0)}function pi(n,t){var r="all",i,u,h,f,e,c,o,l,s,a,v;if(vt=!1,i=ht.peopleTags,i&&i.length>0)for(u=0;u<i.length;u++)h=i[u],h.cid&&(r+=";"+h.id);if(!t&&it&&it[r])f=it[r],vt=!0;else{if(i&&i.length>0){for(c={},o=0;o<i.length;o++)l=i[o],l.cid&&(c[l.cid.toLowerCase()]=!0);for(e=[],s=0;s<n.length;s++)a=n[s],v=a.hexCid(),v&&c[v]||e.push(a)}else e=n;f=tt._getHtml(e,t),t||(it[r]=f,vt=!0)}return f}function wi(){lt()}function bi(){return gt(d.callerCid,null,FilesConfig.userDisplayName),!1}function ki(){return gt(null,null,dt()),!1}function di(){var r=d.callerCid.toLowerCase(),t=ht.peopleTags,n,i;if(t)for(n=0;n<t.length;n++)if(i=t[n],i.cid&&i.cid.toLowerCase()==r)return!0;return!1}function gi(n,i,r){var e,l,h,o,s,c,a,v;if(et&&(window.clearTimeout(et),et=null),vi=r,e=jQuery('<ul class="t_hovl"><\/ul>'),sutra(e,"$Sutra.SkyDrive.PeoplePickerOptions"),i||di()||(l=jQuery("<li><\/li>").append(f.format(y.encodeHtml())).appendTo(e).click(bi),sutra(l,"$Sutra.SkyDrive.PeoplePickerOption")),oi(e,n,0,10),i){if(h=!0,o=ht.peopleTags,o)for(s=0;s<o.length;s++)if(c=o[s],!c.cid&&c.name==i){h=!1;break}h&&(a=p.format(i).encodeHtml(),v=jQuery("<li><\/li>").append(f.format(a)).addClass("ct_tt").appendTo(e).click(ki),sutra(v,"$Sutra.SkyDrive.PeoplePickerOption"))}r&&bt&&(g.addClass(t),g.val(u),g.removeAttr("disabled").removeClass("vhidden"),bt=!1),ui?rt.children().detach():rt.empty(),rt.append(e),ui=vt}function oi(n,t,i,r){var u,o,f,e;for(ot=null,u=i+r,o=u>=t.length,o&&(u=t.length),f=jQuery(""),e=i;e<u;e++)f=f.add(jQuery("<li><\/li>").append(t[e]));sutra(f,"$Sutra.SkyDrive.PeoplePickerOption"),f.appendTo(n),o||(ot=window.setTimeout(function(){oi(n,t,u,r)},50))}function si(n,t){if(tt&&(n!==ti||t)){var i=tt.getMatches(n),r=tt._getHtml(i,n);gi(r,n,!n),ti=n}}function lt(n){var t=dt();n?si(t,n):(wt=t,pt||(pt=setTimeout(function(){si(wt),wt=null,pt=null},$SBC.queryInterval))),kt(t)}function kt(n){!!n&&ct?(ct=!1,$B.IE&&$B.V>9||ut.show(),ft.hide()):n||ct||(ct=!0,ut.hide(),ft.show())}function nr(){g.hasClass(t)&&(g.removeClass(t),g.val(i),kt(i))}function dt(){if(g.hasClass(t))return i;var n=g.val();return n?n.trim():i}function tr(){var n=dt();kt(n),g.hasClass(t)||n.length!=0||(g.addClass(t),g.val(u))}function ir(){var t=jQuery("a",rt);return nt?nt.click():t.length==1&&t.click(),!1}function rr(n){return n.keyCode==27?(ct?fr():window.setTimeout(ni,1),!1):n.keyCode==38||n.keyCode==40?(or(n.keyCode==40),!1):(h||lt(),undefined)}function hi(){function n(){ii=0,lt()}ii=window.setTimeout(n,1)}function ur(){lt()}function gt(n,t,i){ri.trigger("peoplePickerContactSelected",[n,t,i,ht.key])}function fr(){return ri.trigger("peoplePickerClose"),!1}function ni(n){return at&&(g.addClass(t),g.val(u),lt(n)),!1}function er(){nt||(nt=rt.find("a."+e).first(),nt=nt.length==1?nt:null)}function or(n){er(),nt?ci(n?nt.next():nt.prev()):ci(rt.find("a").first())}function ci(n){nt&&nt.removeClass(e),nt=n,nt&&nt.addClass(e)}function sr(){d.errorManager.add({$element:jQuery("<span>"+w.encodeHtml()+"<\/span>"),priority:10,type:4})}var st=this,li=$f&&$f.createLoading({returnMarkup:!0,text:v}),ai='<div class="pp"><div class="topRow"><h3>'+a.encodeHtml()+'<\/h3><\/div><div class="ppSearch"><div class="searchBox"><form><label for="'+o+'" class="hidden">'+u.encodeHtml()+'<\/label><input type="text" class="vhidden" value="'+t+'" value="'+u.encodeHtmlAttribute()+'" maxlength="128" disabled="disabled" id="'+o+'" /><\/form><\/div><\/div><div class="'+l+'"><ul tabindex="-1"><li class="LoadingText"><table align="center"><tr><td><span>'+li+"<\/span><\/td><\/tr><\/table><\/li><\/ul><\/div><\/div>",ht,at=!1,rt,g,yt,ut,ft,tt,pt,wt,ti="",hr=0,vi=!1,ii,ct=!0,bt=!0,nt,ri=jQuery(d),et,it=[],vt=!1,ui=!1,ot;st.contactOverride=function(n){var t=n.hexCid()||null;return gt(t,n.cid(),n.displayName()),!1},st.render=function(n){ot&&clearTimeout(ot),ht=n,yi(),ni(!0)},st.dispose=function(){var r,t,i;if(jQuery("a",n).unbind(),it&it.length>0)for(r in it)for(t=it[r],i=0;i<t.length;i++)jQuery(t).unbind();$Do.remove("$SB",ei),ot&&clearTimeout(ot),et&&clearTimeout(et),at&&(g.unbind(),ut.unbind(),ft.unbind(),yt.unbind(),tt=null)},st.focus=function(){bt?setTimeout(fi,100):fi()}}var r=wLive.Core,n=r.AleHelpers.getPCString,g=r.SkyDriveItemHelper,nt=r.ActionManager;wLive.Controls.PeoplePicker=d;var a=n("PPickerTitle"),u=n("PPickerFindPerson"),v=n("PPickerLoading"),tt=FilesConfig.imgBaseUrl,y=n("PPickerThatsMe"),p=n("PPickerTagAs"),s=n("PPickerClearSearch"),it=n("PPickerClosePicker"),w=n("PPickerTimeoutMessage"),t="watermark",h=$B.Firefox,i="",e="t_sel",c="button",rt=FilesConfig.isEnterKeyEnabled,o="c_searchInput",l="ppContacts",f='<a href="#">{0}<\/a>',b=15e3,k="blur"})()}),define("TagCreate.js",["PeoplePicker.js"],function(){(function(){function c(c,l,a){function at(){var r=!1,u=c.offset(),n,t,i;return ft=u.left,et=u.top,n=c.width(),t=c.height(),(n!=b||t!=d)&&(b=n,d=t,g=s*(b<d?b:d),ht=g/2+f,v.width(g).height(g),i=g+f*2,ct=b-i,lt=d-i,r=!0),r}function bt(){if(!w&&!tt)if(k)kt();else{k=!0,ei();var n=v.position(),t=n.left/b,i=n.top/d,r=g/b,u=g/d;ut=t+","+i+","+r+","+u,pt=ot/b,wt=st/d}return!1}function kt(){ut=null,k=!1,tt=!0,v.hide(),y.hide()}function ei(){var o=v.offset(),s=o.left,n=s+g+t,u=o.top,f=e.height();n+i>e.width()&&(n=s-t-i),u+r>f&&r<f&&(u=f-t-r),y.css("left",n),y.css("top",u),y.show(),nt.render(p),nt.focus()}function dt(n,t,i){ot=t-ft,st=i-et;var r=ot-ht,u=st-ht;r<0?r=0:r>ct&&(r=ct),u<0?u=0:u>lt&&(u=lt),n.css("left",r).css("top",u)}function vt(){y.css("left",ft+(b-i)/2),y.css("top",et),y.show()}function gt(t,i,r){var f={id:"loading"+ +new Date,name:i,rect:r,cid:t},u=p,e=u.peopleTags,o;e?e.push(f):u.peopleTags=[f],o='{ "group": "'+(l.viewParams.group||0)+'", "files": [ { "id": "'+u.id+'", "tags": [ { "tag": { "cid": "'+(t?t:h)+'", "name": "'+i.encodeJson()+'", "rect": "'+r+'" } } ] } ] }',l.dataModel.updateItem(u,"AddPeopleTags",o,function(t){for(var o=u.peopleTags,s,h,e=o.length-1;e>=0;e--)if(s=o[e],n.StringHelpers.caseInsensitiveStringEquals(s.id,f.id)){o.splice(e,1);break}h=t.files[0].tags[0].tag,o.push(h),jQuery(l).trigger("reloadTags",[u.key])},function(xhr,textStatus,errorThrown){var errorString=n.AleHelpers.getPCString("Tagging.TagCreateError"),responseText,fileResponseTextTags,fileResponseErrorMessage,tags,index,tagInfo;for(xhr&&xhr.responseText&&(responseText=eval("("+xhr.responseText+")"),responseText.files&&responseText.files.length>0&&(fileResponseTextTags=responseText.files[0].tags,fileResponseTextTags&&fileResponseTextTags.length>0&&fileResponseTextTags[0].error&&(fileResponseErrorMessage=responseText.files[0].tags[0].error.message,fileResponseErrorMessage&&(errorString=fileResponseErrorMessage)))),l.errorManager.add({$element:jQuery("<span>"+errorString.encodeHtml()+"<\/span>"),priority:1,type:0,code:"tagCreate"}),tags=u.peopleTags,index=tags.length-1;index>=0;index--)if(tagInfo=tags[index],n.StringHelpers.caseInsensitiveStringEquals(tagInfo.id,f.id)){deletePeopleTag=tags.splice(index,1);break}jQuery(l).trigger("reloadTags",[u.key])}),jQuery(l).trigger("reloadTags",[p.key]),k=!1}var rt=this,ui,ft,et,b,d,g,ht,ct,lt,v;a=a||{};var yt=a.tcc=a.tcc?a.tcc+1:1,it=".tagCreate"+yt,ni="enableTagging"+it,ti="disableTagging"+it,ii="peoplePickerClose"+it,ri="peoplePickerContactSelected"+it,p,k=!1,tt=!1,ut,pt,wt,ot,st,w=!1;c.hide(),c.html(o),sutra(c,"$Sutra.SkyDrive.TagCreateContainer"),ui=jQuery(".tagArea",c),v=jQuery("#tagBoxNew",c).hide(),sutra(v,"$Sutra.SkyDrive.TagBoxNew");var fi='<div id="peoplePicker'+yt+'" class="th_pp_cont"><\/div>',y=jQuery(fi).appendTo(document.body).hide(),nt=new u.PeoplePicker(y,l);c.bind("click",bt).bind("mouseenter",function(){w||v.show()}).bind("mouseleave",function(){k||w||v.hide()}).bind("mousemove",function(n){a.tm&&a.te&&!k&&!w&&(tt&&(v.show(),tt=!1),dt(v,n.pageX,n.pageY))}),jQuery(l).bind(ni,function(n,t){c.show(),at(),p&&p.key==t&&(nt.render(p),w&&(vt(),y.show(),nt.focus()))}).bind(ti,function(){c.hide(),v.hide(),y.hide(),k=!1}).bind(ri,function(n,t,i,r,u){p&&p.key==u&&r&&(w?(gt(t,r,"0,0,0,0"),nt.render(p)):ut&&(gt(t,r,ut),y.hide()))}).bind(ii,function(){kt(),w&&jQuery(l).trigger("disableTagging")}),rt.render=function(n){v.hide(),y.hide(),k=!1,w=!1,p=n,a.tm&&c.show(),at(),n.video?(w=!0,a.tm&&(nt.render(p),vt(),nt.focus())):tt=!0},rt.resize=function(){at(),a.tm&&(w?vt():k?(k=!1,b==0||d==0?(y.hide(),v.hide()):(dt(v,pt*b+ft,wt*d+et),bt())):tt=!0)},rt.stop=function(){c.hide(),y.hide(),v.hide(),w=!1},rt.dispose=function(){c.unbind(),c.empty(),nt.dispose(),y.remove(),jQuery(l).unbind(it)}}var n=wLive.Core,u=wLive.Controls,o='<div class="tagArea"><\/div><div id=tagBoxNew class="th_tag_box_new"><div class="th_tag_box_inner"><\/div><\/div>',s=.25,f=4,t=15,i=200,r=300,l=100,h="",e=jQuery(document);u.TagCreate=c})()}),define("SelfView.js",["TagCreate.js"],function(){(function(){function kr(e,et,di){function fa(){tu.addObjectListener(dl,i.DataModel.dataChangedEvent,sv,"SkyDriveWeb_Internal_Control_SelfView_DataChanged"),tu.addObjectListener(SkyDrive.UI.BaseVideoCanvas,"error",wc),tu.addObjectListener(SkyDrive.UI.BaseVideoCanvas,"complete",wc)}function pc(){lf!=-1&&(yu=!0,ih=gf!=0,na=!et.infoPaneClosed,fu.hide(),uu.hide(),iu.hide(),pu.hide(),ih&&rf(),pf.addClass("selfis"),ou=setTimeout(he,lo),ea(document.documentElement))}function he(){if(clearTimeout(ou),ou=null,ph(),!ke&&!df){var n=et.itemProvider.getChildren(kr).getRawCount();n-1>vr?kf(vr+1):kf(0)}}function wc(n,t){gi.key===t&&(ke=!1,yu&&!ou&&he())}function ph(){df&&(!ao||kt.hasLoadedImage(ao))&&(!vo||kt.hasLoadedImage(vo))&&(df=!1,yu&&!ou&&he())}function ce(){yu&&(clearTimeout(ou),ou=null,yu=!1,fu.show(),uu.show(),iu.show(),pu.show(),ih&&rf(),pf.removeClass("selfis"),setTimeout(oa,100))}function ea(n){n.requestFullscreen?n.requestFullscreen():n.mozRequestFullScreen?n.mozRequestFullScreen():n.webkitRequestFullScreen?n.webkitRequestFullScreen():n.msRequestFullscreen&&n.msRequestFullscreen()}function oa(){var n=document;n.exitFullscreen?n.exitFullscreen():n.mozCancelFullScreen?n.mozCancelFullScreen():n.webkitCancelFullScreen?n.webkitCancelFullScreen():n.msExitFullscreen&&n.msExitFullscreen()}function bc(n,t){return jQuery('<img src="'+n.encodeHtmlAttribute()+'" alt="'+t.encodeHtmlAttribute()+'" />')}function la(n){n.originalEvent.preventDefault&&(n.originalEvent.pointerType==2||n.originalEvent.pointerType=="touch")&&gi&&gi.photo&&!bu.tm&&n.originalEvent.preventDefault()}function aa(n){var t,i,s,h;if($B.Full){if(rc())t=p.height(),i=p.width();else if(di.moSelf)t=e.height(),i=e.width();else{ys.removeClass(st),t=($B.SF_M7?p.innerHeight():p.height())-uh,i=e.width();var r=se.deviceXDPI,u=se.deviceYDPI,f=se.logicalXDPI,o=se.logicalYDPI;r&&u&&f&&o&&(r>=f||u>=o)&&(cs=Math.min(cs,r),ls=Math.min(ls,u),(u!=ls||r!=cs)&&(i=Math.floor(1*i*r/cs),t=Math.floor(1*t*u/ls),ys.addClass(st))),e.height(t)}eu=i-fh,ef=t-gf-gu}else t=p.height(),i=p.width(),$B.IE&&(t=$B.V<9?i==320?485:244:i==320?432:288),s=jQuery(document.body).width(),eu=Math.max(yi,Math.min(i,s)),ef=Math.max(yi,t);ah=Math.floor(eu*ar),$B.Mobile||di.moSelf||du()?(ee=eu,of=ef):(ee=eu-hi*2,of=n&&n.video?ef-li-vi:ef-ci-ai,fs&&(n&&fs.render(n),h=Math.max(0,us.outerHeight()+15-(n&&n.video?vi:ai)),of-=h))}function ws(){var t,n;aa(gi),$B.Full?(pf.width(eu),pu.height(ef),pu.css("margin-top",gu),t=ef-us.outerHeight()-(wu&&wu.video?70:0),uu.width(ah),uu.height(t),fu.width(ah),fu.height(t)):(pf.width(eu),pu.width(eu)),n=ef-pt,$B.Full?(n-=us.outerHeight(),n=er&&!di.moSelf?Math.floor(n*.35):Math.floor(n/2),cu.css(h,n+gu),lu.css(h,n+gu)):(n=Math.floor(n*.15),uu.css(h,n+gu),fu.css(h,n+gu)),bf(!0),uo(gi,dr),cf(gi,dr)}function bs(){bu.tm?(uu.css(o,1),fu.css(o,1),iu.css(o,2)):(uu.css(o,3),fu.css(o,3),iu.css(o,4))}function uo(n,t){var r=0,u=0,e,f;if(n){e=of,f=ee,$B.Full&&(bu.tm||n.video)&&(f-=di.moSelf?80:40),$B.Full&&n.video&&(e-=30),n.video?(r=n.video.width,u=n.video.height):n.photo&&(r=n.photo.width,u=n.photo.height),di.moSelf&&(r*=2,u*=2);var o=n.getRotationState()%2!=0,s=o?r:u,h=o?u:r,i;i=pe(n)||!!n.video&&$B.Full?{w:f,h:e}:hl(n,h,s,f,e),t.height(i.h),t.width(i.w),t[0].h=i.h,t[0].w=i.w}}function cf(n,i,r,u){var c;r=r||0;var o=i[0],s=o.h||i.height(),l=o.w||i.width(),f,e;$B.Full?(f=Math.floor((of-s)/2)+gu,e=Math.floor((ee-l)/2)+r,di.moSelf||du()||(f+=n&&n.video?li:ci,e+=hi)):(f=Math.floor((of-s)/4),e=Math.floor((ee-l)/2)+r,c=f+s,pf.height(c),pu.css(h,c)),o[h]!=f&&i.css(h,f),u?i.animate({left:e},ra):i.css(t,e),i[0][t]=e,i[0][h]=f}function va(n){return n.shiftKey?undefined:(ru.showContextMenu(n),!1)}function dc(t){if(!ue){var i=tl(t);i&&(t.originalEvent.pointerId&&(eh=t.originalEvent.pointerId),ue=!0,ge=i.pageX,nf=!1,ff=!1,vf=!1,oh=ge,no=ge,$B.Full&&!bu.tm&&(nf=!0,de=!0,n.useTouchAnimations?nc():bf()),cc=i.pageY,kl(ie.Touch),nh(),ds())}}function gc(t){var u=kr&&et.itemProvider.getChildren(kr),e,h,o,i,r,c,l,s,y,p;if(ue&&(e=tl(t),t.originalEvent.pointerId&&(h=t.originalEvent.pointerId),!!e&&("undefined"==typeof h||h===eh))){if(o=e.pageX,i=o-ge,!nf){var w=e.pageY-cc,a=Math.abs(w),v=Math.abs(i);if(a<10&&v<10)return!0;if(a>=v)return ue=!1,!0;nf=!0,bu.tm||n.useTouchAnimations||bf()}return i>0?(vr>0?!vf&&u&&(vf=u.get(vr-1),r=vf):l=!0,c=-1,ff=null):(u&&vr+1<u.getRawCount()?ff||(ff=u.get(vr+1),r=ff):l=!0,c=1,vf=null),r&&(su.css(f,1).hide(),uo(r,su),vs.render(r,!0)),(!n.useTouchAnimations||sh&&i!=0||r)&&(sh=!1,setTimeout(function(){sh=!0},100),l?(vf=ff=null,su.css(f,0).hide(),s=eu*.2,Math.abs(i)>s&&(i=i>0?s:s*-1)):(y=(eu-su[0].w)/2,p=i+c*(eu-y),cf(r,su,p)),cf(gi,dr,i)),r&&su.show(),Math.abs(o-no)>10&&(oh=no,no=o),!1}return undefined}function nl(t){var s,h;if(ue&&ya(t)){eh=undefined,ue=!1,nf=!1,yu&&(clearTimeout(ou),ou=setTimeout(he,lo));var u=no,f=u-oh,e=u-ge,r,i,o=kr&&et.itemProvider.getChildren(kr);vf&&e>10&&f>=0?(i=eu,vr--,r=!0):ff&&e<-10&&f<=0?(i=-1*eu,vr++,r=!0):i=ff?eu:-1*eu,r&&o&&(gi=o.get(vr),s=su,su=dr,dr=s,h=vs,vs=ru,ru=h,vs.unset(),et.errorManager.clear(),ic(),hu?hu.render(kr,vr):gh(),gr&&clearTimeout(gr),gr=setTimeout(fo,n.animationDuration+b)),cf(gi,su,i,!n.useTouchAnimations),cf(gi,dr,0,!n.useTouchAnimations),te&&nh(),ne&&ds(),po=!0}}function ya(n){var t=n.touches||n.originalEvent.touches;if(t){if(t.length==0)return!0}else if(n.originalEvent.pointerType==2||n.originalEvent.pointerType=="touch")return!0;return!1}function tl(n){var t=n.touches||n.originalEvent.touches;if(t){if(t.length>0)return t[0]}else if(n.originalEvent.pointerType==2||n.originalEvent.pointerType=="touch")return n.originalEvent;return null}function il(){return yu&&!de?(ce(),!1):undefined}function rl(t){var r=t.which,u,f,e,o;if(!i.DomHelpers.isTextInputElement(jQuery(t.target))&&!i.PopoverHelpers.isPopoverVisible()){if(vr!=-1&&kr&&!du()&&(f=et.itemProvider.getChildren(kr),t.altKey||t.ctrlKey||t.shiftKey||t.metaKey||(r==yr||r==34?(u=!0,oo()):r==pr||r==33?(u=!0,eo()):r==36?(u=!0,vr!=0?kf(0):eo()):r==35&&(u=!0,vr!=f.getRawCount()-1?kf(f.getRawCount()-1):oo()))),yu&&(e=t.altKey||t.ctrlKey||t.metaKey||t.shiftKey||u||r==122||r==91,!e))return ce(),!1;if(r==27)return rc()||(pe(gi)&&du()?(au.doAction(au.getAction("ViewItem",gi)),rf()):fl()),!1;r==40&&n.fullView&&!du()?rf():r!=38||n.fullView||du()?(r==32||r==13)&&pe(gi)&&!rc()&&(o=du()?au.getAction("ViewItem",gi):au.getAction("ViewItemInInteractiveMode",gi),au.doAction(o)):rf()}return undefined}function ul(){return kr&&!kr.isPlaceholder}function fl(){ul()&&au.doAction(au.getAction("ViewItem",kr))}function el(){to=vu&&vu.isEditing()}function pa(){pe(gi)&&n.fullView&&!de?au.doAction(au.getAction("ViewItemInInteractiveMode",gi)):gi&&gi.video||nf||to||de||du()?de=!1:rf(),to=!1}function wa(){nf||to||rf(),to=!1}function rf(){di.moSelf||(re?(clearTimeout(re),re=null):kh.addClass(ht),n.fullView?ol():(oe.css(it,"0px"),pu.css($B.rtl?t:ti,"0px"),iu.show(),gf=ut,uh=hc,fh=yt,n.fullView=!0,e.addClass(ct),dh(),lt&&(gs(),ks())),ku.css(it,gf),tu.resize(),n.fullView&&u&&u.toggleFixedHeader(!0),jQuery(".TopBar").offset(gl.offset()),re=setTimeout(function(){kh.removeClass(ht),re=null},200))}function ol(){oe.css(it,"-"+ut+"px"),pu.css($B.rtl?t:ti,"-"+yt+"px"),iu.hide(),u&&u.toggleFixedHeader(!1),gf=0,uh=0,fh=0,n.fullView=!1,e.removeClass(ct),dh(),lt&&(nh(),ds())}function dh(){if($B.IE&&!$B.Mobile&&!di.moSelf){var t="url("+FilesConfig.imgBaseUrl+(n.fullView?"/Zoom_In.cur":"/Zoom_Out.cur")+"),default";sa.css(vt,t),ha.css(vt,t),rs.css(vt,t)}}function ba(){gu=vc.height(),tu.resize(),bs()}function ka(){gu=0,tu.resize(),bs()}function da(){ws(),wu&&ru.render(wu,!1,!0)}function sl(){tf.toggle()}function gh(){if(kr&&vr!=-1){var n=Math.max(0,vr-bi),t=Math.min(vr+bi,et.itemProvider.getChildren(kr).getRawCount()-1),i=1,r=1;cl(n,t,i,r)}}function ga(){if(kr&&vr!=-1){var n=Math.max(0,vr-ki),t=Math.min(vr+ki,et.itemProvider.getChildren(kr).getRawCount()-1);cl(n,t,ee,of,vr)}}function hl(n,t,i,r,u){var e,f;return u<=0||r<=0?(e=0,f=0):t>r||i>u?t/i>r/u?(e=r,f=i/t*r):(f=u,e=t/i*u):(f=i,e=t),f=Math.round(f),e=Math.round(e),n&&n.video&&$B.Mobile&&(f=Math.max(f,200)),{w:e,h:f}}function cl(n,t,r,u,f){var h,o,e,s,a;for(f!==undefined&&(ao=null,vo=null),h=et.itemProvider.getChildren(kr),o=n;o<t;o++)if(e=h.get(o),e&&e.photo&&e.thumbnailSet){var c=hl(e,e.photo.width,e.photo.height,r,u),v=fc.isGifOrPng(e)?2:null,l=fc.pickThumbnail(e.thumbnailSet,c.w,c.h,v);l&&(s=e.thumbnailSet.baseUrl+l.url,f!==undefined&&(o==f?ao=s:o==f+1&&(vo=s),a=sc),i.Images.loadImage(s,a))}}function ll(t){if(!ch){ch=!0,yu&&(clearTimeout(ou),ou=setTimeout(he,lo)),bf();var i=(t?-1*wt:wt)/2,r=n.animationDuration/2,u=jQuery.fx.interval;jQuery.fx.interval=w,dr.animate({left:"+="+i},r,ii),dr.animate({left:"-="+i},r,ii,nv),jQuery.fx.interval=u}}function nv(){ch=!1,gr&&(clearTimeout(gr),gr=null),gr=setTimeout(fo,b)}function bf(t){dr.stop(!1,!0),dr.stop(!1,!0),nu.stop(!1,!0),nu.stop(!1,!0),su.stop(!1,!0),su.hide(),nu.hide(),n.useCSS3Animations?(yf&&(clearTimeout(yf),yf=null,al()),nu.removeClass("selfAnimate"),dr.removeClass("selfAnimate"),su.removeClass("selfAnimate"),hh=!1):ns&&vl(!0),t||(gr&&(clearTimeout(gr),gr=null),ru.stop())}function kf(r){var c,u,l,a,e,s,h;ec&&ec.getQueue().reset(),kh.removeClass(ht),re=null,yu&&(clearTimeout(ou),ou=setTimeout(he,lo)),r!=vr&&(pe(gi)&&ru.stopPanoramaAutoPan(),c=r>vr,vr=r,gi=et.itemProvider.getChildren(kr).get(vr),co=!1,ho=gi?gi.getRotationState():0,et.errorManager.clear(),ic(),kr&&vr!=-1&&(hu?hu.render(kr,vr):gh()),bf(),clearTimeout(gr),gr=null,u=(c?-1:1)*($B.Mobile?eu:wt),l=nu,nu=dr,dr=l,nu.removeAttr("role"),dr.attr("role","main"),a=as,as=ru,ru=a,as.unset(),nu.css(o,-1),dr.css(o,2),dr.css("display","block"),sf=u,ko=nu[0][t],n.useCSS3Animations?($B.Full&&dr.css(f,0),uo(gi,dr),cf(gi,dr,-1*u),go=dr[0][t],yf&&clearTimeout(yf),yf=i.DomHelpers.setTimeoutZero(al)):(e=w/n.animationDuration,s=Math.round(u*e),$B.Full&&nu.css(f,1-e),h=ko+s,nu.css(t,h),nu[0][t]=h,$B.Full&&dr.css(f,e),uo(gi,dr),cf(gi,dr,-1*u+s),go=dr[0][t]-s,lc=+new Date,ac=lc+n.animationDuration-w,ns=setInterval(tv,w)),ru.render(gi,!0),gi&&(gi.video?ke=!0:df=!0,pe(gi)&&ru.startPanoramaAutoPan()),vu&&(gi?(ku.show(),vu.render(gi),yu||vu.focus()):ku.hide()))}function al(){if(yf=null,sf!=0){nc();var i=ko+sf,r=go+sf;nu.css(t,i),nu[0][t]=i,dr.css(t,r),dr[0][t]=r,$B.Full&&(nu.css(f,0),dr.css(f,1)),sf=0,gr&&clearTimeout(gr),gr=setTimeout(fo,n.animationDuration+b)}}function nc(){hh||(nu.addClass("selfAnimate"),dr.addClass("selfAnimate"),su.addClass("selfAnimate"),hh=!0)}function tv(){vl()}function vl(i){var r,h,u,e,o,s;sf!=0&&(i?r=0:(h=+new Date,r=Math.max(ac-h,0)/n.animationDuration),u=1-r,e=Math.round(u*sf),$B.Full&&(nu.css(f,r),dr.css(f,u)),o=ko+e,s=go+e,nu.css(t,o),nu[0][t]=o,dr.css(t,s),dr[0][t]=s,(r==0||i)&&(clearInterval(ns),ns=null,sf=0,i||(gr&&clearTimeout(gr),gr=setTimeout(fo,b))))}function fo(){gr=null,gi?(af=gi,be=vr,di.moSelf||i.StringHelpers.caseInsensitiveStringEquals(et.viewParams.id,gi.id)?tc():au.doAction(au.getAction("ViewItem",gi))):tc()}function tc(){if($B.Mobile&&window.scrollTo(0,1),nu.css("display","none"),af){if(wu=af,lf=be,af=null,be=-1,di.onSelectedIndexChanged)di.onSelectedIndexChanged(lf);bs(),ws(),ru.render(gi),gi.video?ke=!0:df=!0,vu&&(gi?(du()||ku.show(),vu.render(gi)):ku.hide()),tf&&(tf.render(gi),et.infoPaneClosed&&tf.toggle()),wf&&wf.render(gi),is&&gi&&(is.clear(),ft.populateSharedCommands(et,gi,null,is,br,null))}ga()}function ic(){var n=!0,t=!0;kr&&vr!=-1&&(vr!=0&&(n=!1),et.itemProvider.getChildren(kr).getRawCount()-1!=vr&&(t=!1)),n?cu.removeClass(nt):cu.addClass(nt),t?lu.removeClass(nt):lu.addClass(nt)}function iv(){ic(),kr&&vr!=-1&&(hu?hu.render(kr,vr):gh(),lh&&(lh=!1,ev(!bo))),ul()&&yc.render(!1),bo&&(bo=!1),gr&&clearTimeout(gr),gr=setTimeout(fo,b)}function eo(){kr&&vr>-1&&(vr>0?kf(vr-1):ll())}function rv(n){n.which!=1||nf||(ye(),fe=setInterval(eo,pi),eo())}function uv(n){n.which!=1||nf||(ye(),fe=setInterval(oo,pi),oo())}function ye(){clearInterval(fe),fe=null}function oo(){vr!=-1&&kr&&(et.itemProvider.getChildren(kr).getRawCount()-1>vr?kf(vr+1):ll(!0))}function yl(n){kl(ie.Mouse),po&&(!ne&&!te||jQuery(n.target).closest(".selfps").length||jQuery(n.target).closest(".selfns").length||(ds(),nh()))}function fv(){ks(),gs()}function ks(){ne||(ne=!0,cu.stop(!0),cu.animate({opacity:1},c),iu.stop(!0),iu.animate({opacity:1},c)),po=!0}function ds(){ne&&(ne=!1,cu.stop(!0),cu.animate({opacity:0},wi),wo!==ie.Touch&&(iu.stop(!0),iu.animate({opacity:0},c)))}function ev(n){($B.Full||lt)&&(n?(cu.animate({opacity:1},c*4),lu.animate({opacity:1},c*4),iu.animate({opacity:1},c)):(cu.css("opacity",1),lu.css("opacity",1),iu.css("opacity",1)))}function ov(){ks(),gs()}function gs(){te||(te=!0,lu.stop(!0),lu.animate({opacity:1},c)),po=!0}function nh(){te&&(te=!1,lu.stop(!0),lu.animate({opacity:0},wi))}function sv(n){var t,r,i,u;if(we==n.key)if(gi){if(t=et.itemProvider.getChildren(n).indexOf(gi),rh&&gi.key==rh||(rh=gi.key,yo=0),t==-1&&et.viewParams.qt==ir)if(yo<ia)yo++;else{yo=0,$BSI.navigateTo("#qt=search&q="+encodeURIComponent(et.viewParams.q));return}t!=-1||vr==-1?(r=t==-1&&vr==-1||co,wl(r),co=!1,tu.render(gi)):pl()}else i=et.itemProvider.getChildren(kr).get(vr),i&&tu.render(i);else gi&&gi.key===n.key?(u=et.itemProvider.getChildren(kr).indexOf(gi),u!=-1?(vu&&(ku.show(),vu.render(n)),tu.resize()):lh||pl(),uc()):!we&&th&&bo&&(tu.render(th),uc())}function pl(){var t,r,i,n,u;kr&&(t=et.itemProvider.getChildren(kr).getRawCount(),i=!1,t>0?(u=Math.min(t-1,vr),n=et.itemProvider.getChildren(kr).get(u),r=!!n):(i=!0,n=kr),i&&hv(),r&&tu.render(n),n&&au.doAction(au.getAction("ViewItem",n)))}function wl(n){lf=-1,vr=-1,be=-1,hu&&!n&&hu.resetState()}function hv(){wl(),wu=null,gi=null,af=-0,kr=null,we=null,so=!1}function cv(n,t){var r=n.parentKey,f=t.viewParams.parQt,u=t.viewParams.parId;return u&&(r=i.SkyDriveItem.getItemKey(u,n.ownerCid,n.group,f)),r}function bl(n){et.itemProvider.currentFilterType=i.JSONConstants.FilterType.PhotosAndVideos,et.itemProvider.setSkyDriveItemDefaultSetKey(n)}function pe(n){return or&&n&&n.isPanorama&&!(ru&&ru.errorLoadingPanorama())}function lv(){var i=du(),t=i?"hide":"show";fu[t](),uu[t](),ku[t](),$B.Mobile&&pu[t](),i?(n.fullView?rf():tu.resize(),ru.enterInteractivePanoramaMode()):(n.fullView||rf(),ru.exitInteractivePanoramaMode())}function du(){return et.viewParams&&(et.viewParams.mode==="interactive"||et.viewParams.mode==="interactiveEmbed")}function rc(){return et.viewParams&&et.viewParams.mode==="interactiveEmbed"}function av(n){return n.getRotationState()!==ho}function vv(){k.$header&&!ts&&(k.$header.showLoading(),ts=!0)}function uc(){k.$header&&ts&&(k.$header.hideLoading(),ts=!1)}function kl(n){wo!==n&&(n===ie.Mouse?wo=n:n===ie.Touch&&(iu.stop(!0),iu.animate({opacity:1},c),wo=n))}var tu=this,uf=jQuery(et),fc=i.SkyDriveItemHelper,au=et.actionManager,dl=et.dataModel,ec=r.Notifications,gl=jQuery("#c_base"),is,io,le,ae,wh,bh,kc,ro,tf;di=di||{},di.moSelf?n.fullView=!1:e.addClass(ct),n.useTouchAnimations=di.moSelf;var kr,we,wu,lf=-1,so,oc,ho,co=!1,gi,vr=-1,af,be=-1,th,yu,ou,lo=3e3,ke=!1,ih,na,df=!1,sc=new Image,ao,vo,ta=jQuery(sc).bind(gt,ph),rh=null,yo=0,ia=2,hc=u&&u.getHeaderHeight(),gu=0,uh=n.fullView?hc:0,fh=n.fullView?yt:0,gf=n.fullView?ut:0,ne=!0,te=!0,po,ie={Mouse:0,Touch:1},wo=ie.Mouse,re,ue,de,eh,ge,cc,ff,vf,no,oh,nf,ra=$B.Full?200:100,sh=!0,hh=!0,to,fe,gr,lc,ch,bo=!0,lh=!0,eu,ef,ah,ee,of,ac,sf=0,ko,go,ns,yf,ts=!1,vh=null,bu={tm:!1,thc:0,tcc:0,te:!0,at:!0,nms:di.moSelf,ht:di.moSelf};nr.to=bu,ft&&(io=ft.initializeCommandBar(et,"$Sutra.SkyDrive.SelfCommandBar"),io&&(is=io.getDataModel().list)),e.html(wr);var pf=jQuery(".selfi",e).bind(ur,function(n){return i.DomHelpers.isTextInputElement(jQuery(n.target))?undefined:!1}),rs=jQuery(".selfb",e),iu=jQuery(".selfbb",e),uu=jQuery(".selfps",e),vc=jQuery(".selftn",e),ua=jQuery(".selfnb",e),hf=jQuery(".selfp",e),dr=jQuery(hf[0]).attr("role","main"),nu=jQuery(hf[1]),su=jQuery(hf[2]),fu=jQuery(".selfns",e),cu=jQuery(".selfpa",e),oe=jQuery(".selff",e),lu=jQuery(".selfna",e),pu=jQuery(".selfip",e),ku=jQuery(jQuery(".selfc",e)[0]),us=jQuery(jQuery(".selfc",e)[1]),vu,fs,yc;di.moSelf||$B.Mobile?ku.hide():(vu=new ot(ku,et,tr),fs=new ot(us,et,tr),e.addClass(fr)),yc=new r.BackImageButton(iu,et),n.useTouchAnimations&&n.useCSS3Animations&&nc();var hu,yh,wf,es,os,ss,hs,se=window.screen,cs=se.deviceXDPI,ls=se.deviceYDPI;window.$theme&&($theme.previewTheme(["SkyDriveDark2",null,null,$theme.version],!1,null),e.addClass(ri),window.$CommandBar&&io.addLightHover()),"undefined"!=typeof $WLXIM&&$Do.when("$WLXIM.SidebarCreated",0,function(){jQuery($WLXIM.sidebar).bind("onSidebarOpenedEvent"+s,tu.resize),jQuery($WLXIM.sidebar).bind("onSidebarCloseCompletedEvent"+s,tu.resize)}),di.moSelf?(wh=di.images,bh=di.strings,le=bh.Previous,ae=bh.Next,os=es=bc(wh.previousEnabled,le),hs=ss=bc(wh.nextEnabled,ae)):(le=bt("Previous"),ae=bt("Next"),es=jQuery(d.getImage("previousRest",le)),os=jQuery(d.getImage("previousHover",le)),ss=jQuery(d.getImage("nextRest",ae)),hs=jQuery(d.getImage("nextHover",ae))),es.addClass("selfpar"),os.addClass("selfpah"),ss.addClass("selfnar"),hs.addClass("selfnah"),cu.append(es),cu.append(os),lu.append(ss),lu.append(hs),$B.Full&&(nu.css({opacity:0}),su.css({opacity:0}),cu.height(pt),oe.height(ut),lu.height(pt),ku.css(it,gf),di.moSelf||(hu=new r.FilmStrip(oe,et,n),wf=new r.TagStatusBar(vc,et,bu),kc=function(t){n.fullView&&hu&&hu.mouseScroll(t.originalEvent.wheelDelta||t.originalEvent.detail)},oe.bind(si,function(n){kc(n)})),uu.bind(tt,fv),fu.bind(tt,ov),l.bind(tt,yl),uf.bind(hr,ba),uf.bind(cr,ka),uf.bind(lr,da),ro=document,l.bind("fullscreenchange"+s,function(){ro.fullscreen||ce()}),l.bind("mozfullscreenchange"+s,function(){ro.mozFullScreen||ce()}),l.bind("webkitfullscreenchange"+s,function(){ro.webkitIsFullScreen||ce()}),l.bind("msfullscreenchange"+s,function(){ro.msFullScreen||ce()}),uf.bind("toggleProperties",sl)),di.moSelf||(yh=new r.SelfNotificationBar(ua,et),tf=new r.InfoPane(pu,et,nr),uf.bind("slideshow",pc));var ru=new r.SelfItem(dr,et,bu),as=new r.SelfItem(nu,et,bu),vs=new r.SelfItem(su,et,bu),sa=jQuery(".itemT",dr),ha=jQuery(".itemT",nu);dh();var ys=jQuery(rr).addClass(dt),ca=jQuery(document),ps=ca,kh=jQuery("body"),ve=pf;ve.bind(at,dc),ve.bind(ui,gc),ve.bind(fi,nl),ps.bind(ni,rl),ps.bind(v,il),rs.bind(v,wa),hf.bind(v,pa),!di.moSelf&&$B.Full&&hf.bind(sr,va),rs.bind(y,el),hf.bind(y,el),uu.attr("role","button"),uu.attr("aria-label",le),fu.attr("role","button"),fu.attr("aria-label",ae),di.moSelf?(uu.bind(v,eo),fu.bind(v,oo)):(uu.bind(y,rv),uu.bind(ei,ye),uu.bind(oi,ye),fu.bind(y,uv),fu.bind(ei,ye),fu.bind(oi,ye)),iu.bind(v,fl),iu.bind(y,function(){return!1}),hf.bind(at,la),sutra(uu,"$Sutra.SkyDrive.PreviousHover"),sutra(cu,"$Sutra.SkyDrive.PreviousArrow"),sutra(fu,"$Sutra.SkyDrive.NextHover"),sutra(lu,"$Sutra.SkyDrive.NextArrow"),$B.Full?n.fullView?u.toggleFixedHeader(!0):ol():jQuery("#m_wh").hide(),tu.isLoaded=function(){return ru.isLoaded()},tu.render=function(t){var i,u,s,f,r,h,c;if(t){var e=g(af,t),o=g(wu,t)&&t.getVersion()==oc,l=g(gi,t),v=cv(t,et);if(et.viewParams&&et.viewParams.parQt==="sharedby"&&bl(t.key),i=et.itemProvider.getItem(v),t.isPlaceholder||et.viewParams&&et.viewParams.parId&&!i){th=t,vv();return}u=t.parentKey,s=so&&g(kr,i),s||i.folder.photoCount===undefined||i.folder.photoCount<et.itemProvider.getChildren(i).getRawCount()?(bl(t.key),so=!0):so=!1,et.selectionManager.deselectAll(),o&&!e&&kr&&lf!=-1||(o||(et.errorManager.clear(),f="ReadView.Content.File.Photo",t.video&&(f="ReadView.Content.File.Movie"),$BSI.reportEvent(f,{ViewMethod:"oneup",ResourceId:t.id,Extension:t.extension?t.extension.replace(".",a):a})),e?tc():l&&vr!=-1||(r=et.itemProvider.getChildren(i).indexOf(t),kr&&gi&&lf!=-1&&we==u&&r!=-1?kf(r):(h=wu&&wu.key==t.key,bf(h),af=null,be=-1,gi=wu=t,vr=lf=r,kr=i,we=u,oc=t.getVersion(),gi&&(gi.video?ke=!0:df=!0),bs(),$B.Mobile&&(window.scrollTo(0,1),n.fullView&&(gs(),ks())),ws(),iv())),av(t)&&(co=t.getRotationState(!0)==null&&ho,ho=t.getRotationState(),uo(t,dr),cf(t,dr),ru.render(t,!1,!0))),c=vh?vh.mode:null,et.viewParams&&et.viewParams.mode!=c&&lv(),vh=et.viewParams}},tu.resize=function(){ws(),hu&&hu.resize(),wf&&wf.resize(),tf&&tf.resize(),vu&&(vu.resize(),fs.resize()),ru.resize()},tu.dispose=function(){et.itemProvider.currentFilterType="",ta.unbind(gt,ph),bf(!1),tu.clearObjectListeners(),clearInterval(fe),fe=null,clearTimeout(gr),gr=null,ps.unbind(ni,rl),ps.unbind(y,il),ve.unbind(at,dc),ve.unbind(ui,gc),ve.unbind(fi,nl),pf.unbind(),pu.unbind(),rs.unbind(),hf.unbind(),uu.unbind(),fu.unbind(),iu.unbind(),jQuery(n).unbind(),uf.unbind(rt),uf.unbind("toggleProperties",sl),uf.unbind("slideshow",pc),l.unbind(tt,yl),l.unbind(s),"undefined"!=typeof $WLXIM&&jQuery($WLXIM.sidebar).unbind(s),cu.stop(!0),lu.stop(!0),iu.stop(!0),ys.removeClass(dt),ys.removeClass(st),e.width("auto"),e.height("auto"),hu&&(oe.unbind(si),hu.dispose()),yh&&yh.dispose(),wf&&wf.dispose(),tf&&tf.dispose(),ru.dispose(),as.dispose(),clearTimeout(ou),ou=null,window.$theme&&($theme.previewTheme(["SkyDrive",null,null,$theme.version],!1,null),e.removeClass(ri),window.$CommandBar&&io.removeLightHover()),uc(),!n.fullView&&u&&u.toggleFixedHeader(!0)},mix(tu,Shared.ObjectEventing),fa()}var k=window,i=wLive.Core,e=i.CommandManager,r=wLive.Controls,ft=r.CommandBarHelper,bt=i.AleHelpers.getString,u=window.$baseMaster,et=JBase.UI.ImageStripHelper,d=i.ImageStrip,kt=i.Images,ot=r.EditableText,g=i.SkyDriveItem.areItemsSame,ir="search",rr="html",dt="self",st="selfZoom",f="opacity",a="",gt="load",ur="selectstart",ni="keydown",v="click",t="left",ti="right",o="z-index",ii="linear",s=".SelfView",nt="enabled",ri="darkTheme",ht="transitionsOn",ct="fullView",fr="webView",er=$B.IE&&$B.V>9&&window.outerHeight===window.innerHeight,lt=$B.Mobile&&$B.IE&&$B.V<10,or=!!document.createElement("canvas").getContext,at=$B.IE?$B.V>10?"pointerdown":"MSPointerDown":"touchstart",ui=$B.IE?$B.V>10?"pointermove":"MSPointerMove":"touchmove",fi=$B.IE?$B.V>10?"pointerup":"MSPointerUp":"touchend",tt="mousemove",y="mousedown",sr="contextmenu",ei="mouseleave",oi="mouseup",si="mousewheel DOMMouseScroll",vt="cursor",h="top",it="bottom",rt=".self",hr="enableTagging"+rt,cr="disableTagging"+rt,lr="immersiveViewerError"+rt,ut=77,yt=300,pt=40,hi=20,ci=10,li=20,ai=10,vi=20,yi=240,ar=.1,wt=$B.rtl?-30:30,vr=300,pi=800,w=50,b=50,c=200,wi=200,yr=$B.ltr?39:37,pr=$B.ltr?37:39,bi=5,ki=$B.Mobile?3:5,di='<div class="selfps"><span class="selfbb" role="button"><\/span><span class="selfih"><\/span><span class="selfpa"><\/span><\/div>',gi='<div class="selfns"><span class="selfih"><\/span><span class="selfna"><\/span><\/div>',wr=($B.Mobile?di:a)+'<div><div class="selfi"><div class="selfssc"><\/div><div class="selfb"><\/div>'+($B.Mobile?a:di)+'<div class="selfp"><\/div><div class="selfp"><\/div><div class="selfp"><\/div><div class="selfc"><\/div><div class="selfc" style="visibility: hidden"><\/div>'+($B.Mobile?a:gi)+"<\/div>"+($B.Mobile?gi:a)+'<div class="selfip"><\/div><\/div><div class="selff"><\/div><div class="selfnbs"><div class="selfnb"><\/div><div class="selftn"><\/div><\/div>',nr={fh:!0,lp:!0,i:!0,bici:"IP",cs:!0,oi:!0,h:{sp:!0,vf:!0}},tr=$B.Mobile?null:jQuery.extend({},ot.CaptionOptions,{c:!0,hc:!0,ic:"selfci",stt:!0}),n={fullView:!0,disableAnimations:$B.Full&&$B.IE&&$B.V<9,useCSS3Animations:!($B.IE&&$B.V<10||$B.Firefox&&$B.V<4),animationDuration:vr,animationInterval:w,useTouchAnimations:!1},p=jQuery(window),l=jQuery(document),br=e?{TopLevelRename:e.commandDisabled,ViewItem:e.commandDisabled,Rename:e.commandDisabled,NestedDownload:e.commandDisabled,NestedEmbed:e.commandDisabled,Properties:e.commandDisabled,ViewInFolder:e.commandDisabled}:null;r.SelfView=kr,defineSubClass("wLive.Controls.BackImageButton",SkyDrive.UI.NewControlAdapter,function(){this.setContext(this._getButtonContext())},{controlType:Shared.UI.ImageButton,render:function(n){this.initialize(),this._controlInstance.setDataContext(this._dataContext,n),this._controlInstance.isActive||(this.element.innerHTML=this._controlInstance.renderHtml(),this._controlInstance.activate())},setContext:function(n){this._dataContext=n},_getButtonContext:function(){return{image:et.getImageInfo("PanoBackRest"),hoverImage:et.getImageInfo("PanoBackHover"),pressedImage:et.getImageInfo("PanoBackActive")}}}),$Do.register("wLive.Controls.SelfView")})()}),define("siv.js",[],function(){(function(){function ht(n,t,i,r){this.m00=n||0,this.m01=t||0,this.m10=i||0,this.m11=r||0}function t(n,t,i,r,u,f,e,o,s,h,c,l,a,v,y,p){this.m11=n,this.m12=t,this.m13=i,this.m14=r,this.m21=u,this.m22=f,this.m23=e,this.m24=o,this.m31=s,this.m32=h,this.m33=c,this.m34=l,this.m41=a,this.m42=v,this.m43=y,this.m44=p}function vt(n,t,i,r,u){this.a=n,this.b=t,this.c=i,this.d=r,this.normal=new f(this.a,this.b,this.c),this.point=u}function s(n,t,i,r){this.w=n,this.x=t,this.y=i,this.z=r}function er(n,t,i,r){this.x=n,this.y=t,this.width=i,this.height=r}function l(n,t){this.x=n||0,this.y=t||0}function f(n,t,i){this.x=n,this.y=t,this.z=i}function u(n,t,i,r){this.x=n,this.y=t,this.z=i,this.w=r}function h(n,t){function i(){}i.prototype=t.prototype,n.prototype=new i,n.prototype.constructor=n,n.baseConstructor=t,n.superClass=t.prototype,n.__super=t}function ni(){function t(){return!n||n.length===0}var n=[];this.fire=function(i){if(!t())for(var r=0,u=n.length;r<u;r++)n[r](i)},this.addEventListener=function(t){n=n||[];for(var i=0,r=n.length;i<r;i++)if(n[i]===t)return;n.push(t)},this.removeEventListener=function(i){if(!t())for(var r=0,u=n.length;r<u;r++)n[r]===i&&n.splice(r,1)}}function rt(){this.map={},this._innerArray=[]}function fi(n,t){this.screenArray=n,this.textureArray=t}function tt(n,t,i,r,u,f,e){tt.__super.call(this),this._url=n,this._loadCallback=t,this._loadCallbackInfo=i,this._image=null,this._wrapS=r!==undefined?r:tt.Wrap.CLAMP_TO_EDGE,this._wrapT=u!==undefined?u:tt.Wrap.CLAMP_TO_EDGE,this._minFilter=f!==undefined?f:tt.Filter.LINEAR_MIPMAP_LINEAR,this._magFilter=e!==undefined?e:tt.Filter.LINEAR,this._isReady=!1,this._isDirty=!1}function yt(){yt.__super.call(this),yt._animation=null,yt._animationEndStates=null}function ei(n){this._texture=n,ei.__super.call(this)}function oi(){this._rotX=this._rotY=this._rotZ=0,this._translateX=this._translateY=this._translateZ=0,this._scaleX=this._scaleY=this._scaleZ=0,oi.__super.call(this)}function pi(n){this._geometry=n.geometry||null,this._material=n.material||null,this._transform=n.transform||null}function v(n){v.__super.constructor.call(this),this._name="BaseRenderer",this._renderables={},this._viewModel=null,this._removedRenderables={},this._layers={},this._window=n,this._rootElement=null,this._viewProjMatrix=t.createIdentity(),this._clearColor={r:0,g:0,b:0,a:1},this.SortRenderableFucntion=function(n,t){var i=n.id.levelOfDetail,r=t.id.levelOfDetail;return i&&r?i-r:i||r?i?1:-1:0}}function a(){}function wi(n,i,r,u,f,e){var h,s,o,l,c;wi.__super.call(this,{}),h=this,s=document.createElement("canvas"),s.width=n,s.height=i,o=s.getContext("2d"),o.clearRect(0,0,n,i),o.fillStyle=u||"gray",o.fillRect(0,0,n,i),o.fillStyle="black",o.font="12pt Segoe UI,sans-serif",o.fillText(f,n*.3,i*.3),l=s.toDataURL(),c=new tt(l,null,null,null,null,null,null),e&&c.loadImageInDOM(),h._material=new ei(c),h._transform=r?r:t.createIdentity()}function o(n,t,r){o.__super.call(this,n),this._width=t,this._height=r;var f,e,u="css3d is not supported";if(!ut.isValidBrowser())throw u;this._rootElement=document.createElement("div"),this._rootElement.width=this._width,this._rootElement.height=this._height,this._flatten3D=document.createElement("div"),this._flatten3D.style.width=this._width+"px",this._flatten3D.style.height=this._height+"px",this._flatten3D.style.position="absolute",this._flatten3D.style.webkitTransformStyle="flat",this._flatten3D.style.msTransformStyle="flat",this._flatten3D.style.mozTransformStyle="flat",this._flatten3D.style.backgroundColor="rgba("+this._clearColor.r*255+","+this._clearColor.g*255+","+this._clearColor.b*255+","+this._clearColor.a+")",this._3dViewportDiv=document.createElement("div"),this._3dViewportDiv.width=this._width,this._3dViewportDiv.height=this._height,this._3dViewportDiv.style.position="absolute",this._flatten3D.appendChild(this._3dViewportDiv),this._rootElement.appendChild(this._flatten3D),p.supportsPreserve3D&&!g.forceIERenderPath&&(this._3dViewportDiv.style.webkitTransformStyle="preserve-3d",this._3dViewportDiv.style.webkitTransform="matrix3d(1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1)",this._3dViewportDiv.style.mozTransformStyle="preserve-3d",this._3dViewportDiv.style.mozTransform="matrix3d(1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1)"),n.appendChild(this._rootElement),o.prototype.viewportToScreenTransform=i.createViewportToScreen(this._width,this._height)}function nt(n,t,i){var u,r;if(nt.__super.call(this,n),this._width=t,this._height=i,u=document.createElement("canvas"),this._rootElement=u,this._rootElement.width=this._width,this._rootElement.height=this._height,this._gl=ft.getWebGLContext(this._rootElement),this._gl){if(p.isWebGLCORSRequired&&!p.isWebGLCORSSupported)throw"CORS image textures are not supported in this browser";}else throw"WebGL is not supported.";r=this._gl,r.viewportWidth=this._width,r.viewportHeight=this._height,r.viewport(0,0,this._gl.viewportWidth,this._gl.viewportHeight),r.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a),this._gl.clearDepth(1),r.disable(r.DEPTH_TEST),r.disable(r.CULL_FACE),this.init(),n.appendChild(this._rootElement)}function bi(n,t,i){var u,f;return(u=n.createShader(t),n.shaderSource(u,i),n.compileShader(u),!n.getShaderParameter(u,n.COMPILE_STATUS))?(f=n.getShaderInfoLog(u),r.log("Shader compiling error: "+f),n.deleteShader(u),null):u}function w(n,t,i){w.__super.call(this,n),this._width=t,this._height=i,this._initNewCanvas(this._layerIdBackground,0),this.setClearColor(),this._expansionInPixels=w.STD_PIXEL_EXPANSION}function ii(){}function y(){}function c(){}function ki(n){h(this,n);var t={};this.Tesselate=function(i,r,u){var s=i.viewElementId.id,e=t[s],o,f;return e||(e={},t[s]=e),f=e[r],f===undefined&&(f=n.prototype.Tesselate.apply(this,[i,r,u]),o=f.density,o>0&&(e[o]=f)),f},this.GetRawDensity=function(t,i){return n.prototype.GetRawDensity.call(this,t,i)}}function b(){var n={};this.register=function(t){var i=t.id;return n[i]?(r.log(i+" cannot be registered for transition due to pending action on it."),!1):(n[i]=t,!0)},this.unregister=function(t){var i=t.id;n[i]||r.log(i+" cannot be unregistered."),delete n[i]},this.getTransitionItem=function(t){return n[t]}}function ct(n){this.cullWorldAtLod=function(i,r,u){var v=n.getViewProjectionTransform(),c=i.getViewElements(r,u),l,e=t.createIdentity(),a={},o,h;for(o in c){var f=c[o],s=f.viewElementId,y=f.textureSource(s.x,s.y,s.levelOfDetail);(f.priority=0,f.url=y,l!=f.faceTransform&&(e=v.multiply(f.faceTransform),l=f.faceTransform),h=this.genericCullPolygon(f.geometryPolygon,f.texturePolygon,e),h)&&(f.computedGeometry=h,f.mvpMatrix=e,a[o]=f)}return a},this.genericCullPolygon=function(n,t,r){var u,e,o=i.applyWorldTransformation(n,r),f=it.clip(ct.lowerVisibleBoundary,ct.higherVisibleBoundary,o,t);return u=f.polygon,e=f.polygonTexture,e.length=u.length,u.length>2?f:undefined}}function hr(t,r,u){function c(n,i,u,e,o){var y=i||!o||o<0,c,l,a,s,v;if(!y)return!1;c=!1,l=u.map;for(a in l)if((s=l[a],s&&s.viewElementId.levelOfDetail==e)&&!h.isBorderTile(n,s)&&t.getState(s.url)==k.ready){v=n.getElementRawTesselationDensity(s,r),f[n.getDataSourceName()].tesselationMap[e]=v,c=!0;break}return c}function o(t){var f=t.getMinimumLod(),h=t.getMaximumLod(),e=r.getViewport(),c=e.getHeight(),l=e.getWidth(),o=r.getVerticalFov(),a=c,v,u,s;return l>c&&(o=et.convertVerticalToHorizontalFieldOfView(e.getAspectRatio(),o),a=l),v=i.calculateTexelToPixelRatioAtFov(i._cubeSide,t.getWorldConfiguration().source.tileSize,a,o),u=f+Math.round(n.logBase(1/v,2)),u>h?u=h:u<f&&(u=f),d.debugEnabled&&(s=document.getElementById("LODV"),s&&(s.innerHTML="LOD: "+u)),u}function s(n,i,r,u){var f=n.getParent(),o;return f&&!t.AllCompleted.get(f.id,!0)&&f.levelOfDetail>i&&(o=r.getViewElementById(f,u),e(o)||t.downloadImage(o.textureSource(f.x,f.y,f.levelOfDetail),0,f.id),f=s(n.getParent(),i,r,u)),f}function e(n){var i=t.getState(n.url);return i==k.failed||i==k.timedout}var f={},h=this;window.instrumentPerf&&window.instrumentPerf.ttl&&(o=function(n){return n.getMinimumLod()}),this.initDataSource=function(n){f[n.getDataSourceName()]={currentLod:n.getMinimumLod(),tesselationMap:{},lastLod:-1}},this.dropDataSource=function(n){delete f[n]},this.UpdateLodAndTesselation=function(n,t,i){var s=n.getDataSourceName(),u=f[s],r=u.currentLod,l=r==u.lastLod,e=!l||i,h;return e&&(u.lastLod=r,u.currentLod=r=o(n)),h=c(n,e,t,r,this.GetCurrentTesselationDensity(r,s)),e&h},this.getCurrentLod=function(n){var t=f[n].currentLod;return!t,t},this.GetCurrentTesselationDensity=function(n,t){var i=f[t].tesselationMap[n];return i?i:-1},this.EnrichWithParentIViewElements=function(n,i,f){var p=n.getMinimumLod(),k=r.getViewProjectionTransform(),l,h,a,v,y,b;for(l in i){var o=i[l],c=t.AllCompleted.get(l,!0),w=c?c.opacity||c.style.opacity:0;if((!c||w===undefined||w<1||c.animationInProgress)&&o.viewElementId.levelOfDetail>p)if(h=s(o.viewElementId,p,n,f),a=h.id,e(o)&&delete i[l],i[a]===undefined){if(o=n.getViewElementById(h),e(o))continue;if(v=k.multiply(o.faceTransform),o.mvpMatrix=v,y=u.genericCullPolygon(o.geometryPolygon,o.texturePolygon,v),y)o.computedGeometry=y,b=o.textureSource(h.x,h.y,h.levelOfDetail),o.priority=0,o.url=b,i[a]=o;else{i[a]=!1;continue}}else continue}},this.isBorderTile=function(n,t){return t.viewElementWidth!=n.worldConfiguration.source.tileSize||t.viewElementHeight!=n.worldConfiguration.source.tileSize}}function cr(t,u,f,s){function st(n){var t=null;return n&&n.animationType!==undefined&&(n.animation||(n.animation=e.createAnimation(n.animationType)),t=n.animation),t||(t=e.createAnimation(e.TYPE.FadeIn)),t}function ht(n){if(window.elapsed===undefined&&!s.currentlyDownloading()&&n){window.elapsed=+new Date-window.instrumentPerf.startTime,document.getElementById("timerSpan").innerText=window.elapsed+" ms.";var t=document.createElement("img");t.src=PingRequest.end}}function lt(){p=f.getViewport(),k=p.getWidth(),g=p.getHeight();var i=f.getVerticalFov(),r=Math.abs(rt-i);a|=!n.isZero(r),a&&(rt=i),t.setViewProjectionMatrix(f.getViewProjectionTransform())}function at(n,i){var v,f,s,r,y,p,h,u,w;f=t.getType()=="2D",v=f;var c=n.dataSourceName,e=l.getCurrentLod(c),b=l.GetCurrentTesselationDensity(e,c),a=t instanceof o;a&&e>n.getMinimumLod()&&(e-=i),s=ut.cullWorldAtLod(n,e,a),l.EnrichWithParentIViewElements(n,s,a),r=[];for(y in s)r.push(s[y]);if(p=r.length,f)for(h=0;h<p;h++)u=r[h],u.computedGeometry=n.covertToScreenSpace(u.computedGeometry.polygon,u.computedGeometry.polygonTexture,k,g),v&&vt(n,u,b,f);return w=yt(r,c)}function vt(n,t,r,u){var o=t.computedGeometry,c,e,y,a,p,w;if(r===0)o.intileTesselated=[o],o.density=0;else{var b=l.isBorderTile(n,t)?-1:r,v=n.tesselate(t,b,f),s=v.squares,h=v.texelSquares;for(s.length!=h.length,o.intileTesselated=new Array(s.length),c=0,e=0,y=s.length;e<y;e++)a=i.applyWorldTransformation(s[e],t.mvpMatrix),p=it.clip(ct.lowerVisibleBoundary,ct.higherVisibleBoundary,a,h[e]),p.polygon.length>2&&(u?(w=n.covertToScreenSpace(a,h[e],k,g),o.intileTesselated[c]=w):o.intileTesselated[c]=new fi(a,h[e]),c++)}}function yt(n,t){for(var s=[],c=[],l=[],u=h.getVisibleElements(t).map||{},a={},f,v=n.length,i,e,o,r=0;r<v;r++)(i=n[r],f=i.viewElementId,f)&&(e=f.id,u[e]?c.push(i):s.push(i),a[e]=i);for(o in u)a[o]||l.push(u[o]);return{added:s,updated:c,removed:l}}function pt(n){for(var r=n.getDataSourceName(),o=h.getDelta(r).added,s=h.getRenderables(r),a=s.map,v=l.getCurrentLod(r),u,i=0,c=o.length;i<c;++i){var t=o[i],f=t.viewElementId,e={texture:new tt(t.url,null,null,null,null,null,null),polygon:t.texturePolygon.slice()};e.texture.dataSourceWidth=t.viewElementWidth,e.texture.dataSourceHeight=t.viewElementHeight,u=new di(t.geometryPolygon,[e],f,v),ft(t,u),a[f.id],s.add(f.id,u)}}function ft(n,i){switch(t.getType()){case"2D":i.geometryPloygon=n.computedGeometry;break;case"3D":i.transform=n.faceTransform}d.debugEnabled&&(i.isClipped=n.isClipped)}function wt(n){var t,i=h.getDelta(n),u,f,r;if(i.removed&&i.removed.length>0)for(u=i.removed.length,t=0;t<u;++t)s.cancel(i.removed[t].viewElementId.id);if(i.added&&i.added.length>0)for(f=i.added.length,t=0;t<f;++t)r=i.added[t],s.downloadImage(r.url,r.priority,r.viewElementId.id)}function bt(n){for(var f=h.getRenderables(n).getArray(),r,t,u,i=0,e=f.length;i<e;i++)if(r=f[i],t=r.texturesWithPolygons[0].texture,!t._image){if(u=s.AllCompleted.get(r.id.id,!0),!u)continue;t._image=u,t._isReady=!0,t._isDirty=!0,t._image.opacity!==undefined&&(r.animation=null)}}var h=new lr,rt=-1,a=!1,ut=new ct(f),v=[],l=new hr(s,f,ut),p=f.getViewport(),k=p.getWidth(),g=p.getHeight(),w=new b,et=48e4,ot=1049088,nt=0;for(this.doPerfPingCall=function(){},window.instrumentPerf&&(this.doPerfPingCall=ht),t.setViewModel(h),this.RenderFrame=function(n){var r,f,p,k,d,y,o,g,tt;for(lt(),r=!1,f=0,p=v.length;f<p;f++){var e=v[f],i=e.getDataSourceName(),c=w.getTransitionItem(i),it=st(c);for(c&&c.transitionType==b.TRANSITION_TYPE.OUT||(k=at(e,n),h.setDelta(i,k),wt(i),pt(e)),h.syncAddedFromDeltaCurrentVisibleElements(i),h.syncUpdatedFromDeltaCurrentVisibleElements(i,ft),s.update(),bt(i),t.syncRemovedRenderables(i),h.syncRemovedFromDeltaCurrentVisibleElements(i),d=l.UpdateLodAndTesselation(e,h.getVisibleElements(i),a),d&&(a=!1),t.render(i,it,n),y=h.getRenderables(i).getArray(),o=0,g=y.length;o<g;o++){var rt=y[o],ut=rt.texturesWithPolygons[0],nt=ut.texture,u=nt._isReady?nt._image:null;if(u){if(tt=u.opacity||u.style?u.style.opacity:0,tt==0||u.animationInProgress){r=!0;break}}else{r=!0;break}}}return this.doPerfPingCall(!r),!r},this.setViewChanged=function(n){a=n;var t=f.getViewport(),r=t.getWidth(),u=t.getHeight(),i=r*u;i<et?(y.setScreenQuadSize(32),c.setScreenQuadSize(32)):i<ot?(y.setScreenQuadSize(64),c.setScreenQuadSize(64)):(y.setScreenQuadSize(128),c.setScreenQuadSize(128))},this.registerDataSourceForAdd=function(n,i,r){var f=n.getDataSourceName(),u=new b.DataSourceRegistryItem(n,i,r,b.TRANSITION_TYPE.IN),e=w.register(u);e&&(v.push(n),l.initDataSource(n),t.initLayer(f,n.getZOrder()),w.unregister(u))},this.registerDataSourceForRemoval=function(n,i,u){v[n]||r.log(n+" not found in ViewController's ds list.");var f=w.register(new b.DataSourceRegistryItem(v[n],i,u,b.TRANSITION_TYPE.OUT));f||t.finalizeLayer(n)};nt<u.length;)this.registerDataSourceForAdd(u[nt]),nt++;this.setViewChanged(!0)}function di(n,t,i,r){this.geometryPloygon=n.slice(),this.texturesWithPolygons=t.slice(),this.id=i,this.worldLod=r}function lr(){function t(t){return n[t]?!0:(n[t]=new i,!1)}function i(){this.delta={added:[],removed:[],updated:[]},this.currentRenderables=new rt,this.currentVisibleElements=new rt}var n={};this.getVisibleElements=function(i){return t(i),n[i].currentVisibleElements},this.getRenderables=function(i){return!t(i),n[i].currentRenderables},this.getDelta=function(i){return!t(i),n[i].delta},this.setDelta=function(i,r){t(i),n[i].delta=r},this.syncAddedFromDeltaCurrentVisibleElements=function(i){var r,e;!t(i);var o=n[i].delta,u=o.added,s=n[i].currentVisibleElements,f;for(r=0,e=u.length;r<e;r++)f=u[r],s.add(f.viewElementId.id,f);u.length=0},this.syncUpdatedFromDeltaCurrentVisibleElements=function(i,r){var u,l,o,s,h;!t(i);var f=n[i],a=f.delta,e=a.updated,v=f.currentVisibleElements.map,y=f.currentRenderables.map,c;for(u=0,l=e.length;u<l;u++)c=e[u],o=c.viewElementId.id,s=v[o],!s,h=y[o],h&&r(s,h);e.length=0},this.syncRemovedFromDeltaCurrentVisibleElements=function(i){var f,h;!t(i);var e=n[i],c=e.delta,o=c.removed,l=e.currentVisibleElements,s=e.currentRenderables,r,u;for(f=0,h=o.length;f<h;f++)r=o[f].viewElementId.id,l.remove(r),u=s.map[r],u.animation&&u.animation.finalize(u),s.remove(r);o.length=0}}function e(n){this._duration=n||e.DefaultDurationMs,this._start=+new Date,this._timeStamp=this._start}function pt(n){pt.__super.call(this,n)}function wt(n){wt.__super.call(this,n)}function et(n,t,i,r){this._width=n,this._height=t,this._aspectRatio=this._width/this._height,this._nearDistance=i,this._farDistance=r}function ar(n,t,i,r,u,e){this.width=n?n.getWidth():0,this.height=n?n.getHeight():0,this.up=f.clone(r),this.look=f.clone(u),this.fieldOfView=e;var o=function(n,t,i){var r=n.dot(t),u;return r>1?r=1:r<-1&&(r=-1),u=Math.acos(r),u<i};this.isFuzzyEqualTo=function(n,t){if(this.width!==n.width||this.height!==n.height)return!1;var i=t*this.fieldOfView/this.height;return Math.abs(this.fieldOfView-n.fieldOfView)>i?!1:o(this.up,n.up,i)?o(this.look,n.look,i)?!0:!1:!1}}function vr(r,e){function a(){var n=Math.tan(.5*c);b=n===0?1:1/n,i.createLookAtRHOut(v,p,y,k),i.createPerspectiveOGLOut(c,s.getAspectRatio(),s.getNearDistance(),s.getFarDistance(),d),d.multiplyOut(k,g),o=!1}var nt=e||{verticalFov:n.degreesToRadians(80),position:new f(-1,-1,1),look:new f(0,0,-1),up:new f(0,1,0),side:new f(1,0,0)},h=nt,s=r,w=new l(0,0),v=h.position,y=h.up,p=h.look,c=h.verticalFov,b=-1,k=t.createIdentity(),d=t.createIdentity(),g=t.createIdentity(),o=!0;this.getCameraParameters=function(){return h},this.getPose=function(){return new ar(s,w,v,y,p,c)},this.setViewport=function(n){s=n,o=!0},this.getViewport=function(){return s},this.setPosition=function(n){v=n,o=!0},this.getPosition=function(){return v},this.setVerticalFov=function(n){c=n,o=!0},this.getVerticalFov=function(){return c},this.getFocalLength=function(){return o&&a(),b},this.setLook=function(n){p=n,o=!0},this.getLook=function(){return p},this.setUp=function(n){y=n,o=!0},this.getUp=function(){return y},this.setDigitalPan=function(n){w=n,o=!0},this.getDigitalPan=function(){return w},this.getViewTransform=function(){return o&&a(),k},this.getProjectionTransform=function(){return o&&a(),d},this.getViewProjectionTransform=function(){return o&&a(),g},this.projectTo2D=function(n){o&&a();var r=s.getWidth()*.5,f=s.getHeight()*.5,i=g.transformVector4(u.createFromVector3(n));return i.x/=i.w,i.y/=i.w,i.z=i.w=1,new t(r,0,r,0,0,-f,f,0,0,0,1,0,0,0,0,1).transformVector4(i)}}function bt(n,t,i){this._startTime=-1,this._initialValue=-1,this._timeInMillis=-1,this._springConstant=n,this._damperConstant=t,this._allowOvershoot=i,this._current=0,this._target=0,this._velocity=0,this._t=-1,this._isSettled=!1}function gi(n,t,i){this._internalSpring=new bt(n,t,i),this._internalSpringCurrentValue=0,this._internalSpringTargetValue=1,this._current=[],this._initial=[],this._target=[]}function yr(n,t){function w(n){n.type="gestureStart",it(n)}function b(n){n.type="gestureChange",rt(n)}function k(n){n.type="gestureEnd",ut(n),f.focus()}function l(n){n.type="discreteZoom",ft(n)}function d(n){n.preventDefault(),et(n)}function g(n){n.preventDefault(),ot(n)}function a(n){w({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY}),o={x:n.clientX,y:n.clientY},n.preventDefault()}function s(n){o!=null&&(b({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,translationX:n.clientX-o.x,translationY:n.clientY-o.y,scale:1}),n.preventDefault())}function h(n){o!=null&&(k({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,translationX:n.clientX-o.x,translationY:n.clientY-o.y,scale:1}),o=null,n.preventDefault())}function e(n){var t=n.detail?n.detail*-1:n.wheelDelta/40,i;t>0?i=1:t<0&&(i=-1),l({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,direction:i,wheelDelta:t,mouseInteractionType:"mousewheel"}),n.preventDefault()}function c(n){l({clientX:n.offsetX||n.layerX,clientY:n.offsetY||n.layerY,direction:1}),n.preventDefault()}var i=n,it=t.gestureStart||function(){},rt=t.gestureChange||function(){},ut=t.gestureEnd||function(){},ft=t.discreteZoom||function(){},et=t.keyDown||function(){},ot=t.keyUp||function(){},p=!1,st,u,o=null,v,y,f,nt,tt;window.navigator.msPointerEnabled&&window.MSGesture!==undefined?(v=function(){u=new wr(i,w,b,k,l),i.addEventListener("MSPointerDown",u.msPointerDown,!1),i.addEventListener("MSPointerUp",u.msPointerUp,!1),i.addEventListener("pointerdown",u.msPointerDown,!1),i.addEventListener("pointerup",u.msPointerUp,!1),i.addEventListener("MSGestureStart",u.msGestureStart,!0),i.addEventListener("MSGestureChange",u.msGestureChange,!0),i.addEventListener("MSGestureEnd",u.msGestureEnd,!0),i.addEventListener("dblclick",c,!1),i.addEventListener("mousewheel",e,!1)},y=function(){i.removeEventListener("MSPointerDown",u.msPointerDown,!1),i.removeEventListener("MSPointerUp",u.msPointerUp,!1),i.removeEventListener("pointerdown",u.msPointerDown,!1),i.removeEventListener("pointerup",u.msPointerUp,!1),i.removeEventListener("MSGestureStart",u.msGestureStart,!0),i.removeEventListener("MSGestureChange",u.msGestureChange,!0),i.removeEventListener("MSGestureEnd",u.msGestureEnd,!0),i.removeEventListener("dblclick",c,!1),i.removeEventListener("mousewheel",e,!1),st=null}):window.ontouchstart!==undefined?(u=new br(w,b,k,l),v=function(){i.addEventListener("touchstart",u.handleTouchStart,!1),i.addEventListener("touchend",u.handleTouchEnd,!1),i.addEventListener("touchcancel",u.handleTouchEnd,!1),i.addEventListener("touchleave",u.handleTouchEnd,!1),i.addEventListener("touchmove",u.handleTouchMove,!1),i.addEventListener("mousedown",a,!1),i.addEventListener("mousemove",s,!1),i.addEventListener("mouseup",h,!1),i.addEventListener("dblclick",c,!1),i.addEventListener("mousewheel",e,!1),i.addEventListener("DOMMouseScroll",e,!1)},y=function(){i.removeEventListener("touchstart",u.handleTouchStart,!1),i.removeEventListener("touchend",u.handleTouchEnd,!1),i.removeEventListener("touchcancel",u.handleTouchEnd,!1),i.removeEventListener("touchleave",u.handleTouchEnd,!1),i.removeEventListener("touchmove",u.handleTouchMove,!1),i.removeEventListener("mousedown",a,!1),i.removeEventListener("mousemove",s,!1),i.removeEventListener("mouseup",h,!1),i.removeEventListener("dblclick",c,!1),i.removeEventListener("mousewheel",e,!1),i.removeEventListener("DOMMouseScroll",e,!1)}):(v=function(){i.addEventListener("mousedown",a,!1),i.addEventListener("mousemove",s,!1),i.addEventListener("mouseup",h,!1),i.addEventListener("mousewheel",e,!1),i.addEventListener("DOMMouseScroll",e,!1),i.addEventListener("dblclick",c,!1),document.addEventListener("mousemove",s,!1),document.addEventListener("mouseup",h,!1)},y=function(){i.removeEventListener("mousedown",a,!1),i.removeEventListener("mousemove",s,!1),i.removeEventListener("mouseup",h,!1),i.removeEventListener("mousewheel",e,!1),i.removeEventListener("DOMMouseScroll",e,!1),i.removeEventListener("dblclick",c,!1),document.removeEventListener("mousemove",s,!1),document.removeEventListener("mouseup",h,!1)}),f=document.createElement("input"),f.readOnly=!0,f.id="focusElement",r.css(f,{width:"0px",height:"0px",opacity:0}),nt=function(){i.appendChild(f),f.addEventListener("keydown",d,!1),f.addEventListener("keyup",g,!1),f.focus()},tt=function(){f.removeEventListener("keydown",d,!1),f.removeEventListener("keyup",g,!1),f.parentNode&&f.parentNode.removeChild(f)},this.enable=function(){v(),nt(),p=!0},this.disable=function(){y(),tt(),p=!1,u=null},this.isEnabled=function(){return p},this.userCurrentlyInteracting=function(){return u?u.userCurrentlyInteracting():!1}}function pr(n,t){function i(n){u.push(n),t()}var u=[],r=new yr(n,{gestureStart:i,gestureChange:i,gestureEnd:i,discreteZoom:i,keyDown:i,keyUp:i});this.enable=function(){r.enable()},this.disable=function(){r.disable()},this.isEnabled=function(){return r.isEnabled()},this.getQueuedEvents=function(){var n=u;return u=[],n},this.userCurrentlyInteracting=function(){return r.userCurrentlyInteracting()}}function wr(n,t,i,r,u){var c=n,v=t,y=i,l=r,w=u,f,o,s,h=!1,e=0,p=c.parentNode.currentStyle.direction=="rtl",a=new MSGesture;this.msPointerDown=function(n){c.msSetPointerCapture(n.pointerId),a.target||(a.target=c),a.addPointer(n.pointerId),e++,e==1&&(v({clientX:n.offsetX,clientY:n.offsetY}),f=0,o=0,s=1)},this.msPointerUp=function(n){e=Math.max(0,e-1),h||e!=0||l({clientX:n.offsetX,clientY:n.offsetY,translationX:f,translationY:o,scale:s})},this.msGestureStart=function(){h=!0},this.msGestureChange=function(n){if(h){p?f-=n.translationX:f+=n.translationX,o+=n.translationY,s*=n.scale;var t={clientX:n.offsetX,clientY:n.offsetY,translationX:f,translationY:o,scale:s};n.detail&n.MSGESTURE_FLAG_INERTIA?(l(t),h=!1):y(t)}},this.msGestureEnd=function(n){h&&l({clientX:n.offsetX,clientY:n.offsetY,translationX:f,translationY:o,scale:s})},this.userCurrentlyInteracting=function(){return e>0}}function br(t,i,r,u){function l(n){var t=n.target.offsetParent,i=0,r=0;t&&(i=t.offsetLeft,r=t.offsetTop),n.actualX=n.clientX-i,n.actualY=n.clientY-r}function p(n){for(var r,t=0,i=f.length;t<i;t++)if(r=f[t].identifier,r==n)return t;return-1}var a=t,v=i,y=r,w=u,s,h,o,f=[],e,c=1;this.handleTouchStart=function(t){for(var u=t.changedTouches,r,i=0,v=u.length;i<v;i++)r=u[i],l(r),f.push(r);s=0,h=0,o=1,e=null,f.length==1?(a({clientX:f[0].actualX,clientY:f[0].actualY}),c=1):f.length==2&&(t.preventDefault(),a({clientX:(f[0].actualX+f[1].actualX)/2,clientY:(f[0].actualY+f[1].actualY)/2}),c=n.distanceBetweenTwoPoints(f[0].actualX,f[0].actualY,f[1].actualX,f[1].actualY))},this.handleTouchMove=function(t){var u,r,w,a,y,i,b;for(t.preventDefault(),u=t.changedTouches,r=0,w=u.length;r<w;r++)a=p(u[r].identifier),e||(e={},e.actualX=f[a].actualX,e.actualY=f[a].actualY),y=u[r],l(y),f.splice(a,1,y),i=f[r],s+=i.actualX-e.actualX,h+=i.actualY-e.actualY,f.length==1?(o=1,v({clientX:i.actualX,clientY:i.actualY,translationX:s,translationY:h,scale:o}),e.actualX=i.actualX,e.actualY=i.actualY):f.length==2&&(b=n.distanceBetweenTwoPoints(f[0].actualX,f[0].actualY,f[1].actualX,f[1].actualY),o=b/c,v({clientX:(f[0].actualX+f[1].actualX)/2,clientY:(f[0].actualY+f[1].actualY)/2,translationX:s,translationY:h,scale:o,isTouch:!0}))},this.handleTouchEnd=function(n){var u=n.changedTouches,t,c,i,a,r;for(e=null,t=0,c=u.length;t<c;t++)f.splice(t,1);if(n.touches.length==0&&f.length>0)for(i=0,a=f.length;i<a;i++)f.splice(i,1);f.length==0&&(r=u[0],l(r),y({clientX:r.actualX,clientY:r.actualY,translationX:s,translationY:h,scale:o})),o=1},this.userCurrentlyInteracting=function(){return f.length>0}}function hi(t,i,r,u,e){var o,h;this._camera=t,this._upperPitchLimit=r||n.degreesToRadians(90),this._lowerPitchLimit=u||n.degreesToRadians(-90),this._upperHeadingLimit=null,this._lowerHeadingLimit=null,this._currentView={pitch:0,heading:0,verticalFov:0},this._viewChanging=!1,this._pitchSpring=new bt(.01,1,!0),this._headingSpring=new bt(.01,1,!0),this._fieldOfViewSpring=new bt(.0033,1,!0),this._zoomToPointSpring=new gi(.01,1,!1),this._zoomingToPoint=!1,this._wheelZoomFudgeFactor=.1,this._pitchSpring.setCurrentAndTarget(0),this._headingSpring.setCurrentAndTarget(0),this._fieldOfViewSpring.setCurrentAndTarget(this._camera.getVerticalFov()),e?(o=n.degreesToRadians(40),this._minFieldOfView=e<o?e:o,h=n.degreesToRadians(5),this._minFieldOfView=this._minFieldOfView>h?this._minFieldOfView:h):this._minFieldOfView=n.degreesToRadians(20),this._maxFieldOfView=n.degreesToRadians(80),this._worldUp=i&&i.up?i.up:new f(0,1,0),this._worldLook=i&&i.look?i.look:new f(0,0,-1),this._worldSide=i&&i.side?i.side:new f(1,0,0),this._look=new f(0,0,0),this._side=new f(0,0,0),this._up=new f(0,0,0),this._tempQuaternion=new s(0,0,0,0),this._tempPitchRotationQuaternion=new s(0,0,0,0),this._tempHeadingRotationQuaternion=new s(0,0,0,0),this._lastGestureScale=null,this._startingPosition=null,this._discreteZoomFactor=.7,this._scrollSpeedX=0,this._scrollSpeedY=0,this._scrollAccX=0,this._scrollAccY=0,this._motionHandle=0,this._scrollSpeedDamper=.9,this._scrollSpeedAdjustmentFactor=200,this.viewChangeEvent=new ni,this.viewChangeEndEvent=new ni}function ci(i,r,u,e,o){function ht(){return[s._pitchSpring.getTarget(),s._headingSpring.getTarget()]}function ct(){var n=s._zoomToPointSpring.isSettled();return n&&(s._zoomingToPoint=!1),n&&s._pitchSpring.isSettled()&&s._headingSpring.isSettled()&&s._fieldOfViewSpring.isSettled()}function nt(n,t,i,r,u){var f,e,o=i/r;return e=n===0?0:2*Math.atan(o*(n/i)/u),f=t===0?0:2*Math.atan(-t/r/u),[f,e]}function lt(){if(ct()){s._viewChanging&&s.viewChangeEndEvent!=null&&s.viewChangeEndEvent.fire(s.getView()),s._viewChanging=!1;return}s._viewChanging=!0;var n=+new Date;s._zoomToPointSpring.step(n),s._pitchSpring.step(n),s._headingSpring.step(n),s._fieldOfViewSpring.step(n),s.updateCameraProperties()}function at(t,i,r,u,f,e,o){s._zoomingToPoint=!1,r*=o,u*=o;var a=s._camera.getFocalLength(),h,c,l=nt(r,u,f,e,a);h=l[0],c=l[1],y=s.constrainHeading(i-c),k=s.constrainPitch(t-h),b=n.pickStartHeadingToTakeShortestPath(s._headingSpring.getCurrent(),y),s._pitchSpring.setTarget(k),s._headingSpring.setCurrent(b),s._headingSpring.setTarget(y)}function vt(n){s.setViewTarget(s.getPitch(),s.getHeading(),s.getVerticalFov(),!1,null),s._lastGestureScale=1,wt(n.clientX,n.clientY)}function yt(){s._lastGestureScale=null,tt(),s._zoomingToPoint=!1}function pt(n){var t=s._lastGestureScale/n.scale,i,r;if(t!==1){tt(),i=(s._startingPosition[0]+n.clientX)/2,r=(s._startingPosition[1]+n.clientY)/2,n.clientX=i,n.clientY=r;s.onDiscreteZoom(n,t)}s._lastGestureScale=n.scale,h=new l(s._startingPosition[0]+n.translationX,s._startingPosition[1]+n.translationY)}function wt(n,t){p=!0,s._startingPosition=[n,t],a[0]=s.getPitch(),a[1]=s.getHeading()}function tt(){p=!1,h=null}function bt(){if(s._camera!==null&&h!==null&&p){var t=h.x,i=h.y,n=s._camera.getViewport(),r=1.1,u=t-s._startingPosition[0],f=i-s._startingPosition[1];at(a[0],a[1],u,f,n.getWidth(),n.getHeight(),r)}}function kt(t,i){var e=s.prevGyrometerReadingNonZero?2:2;if(t==null)return s.prevGyrometerReadingNonZero=!1,[0,0];if(Math.abs(t.angularVelocityX)<e&&Math.abs(t.angularVelocityY)<e&&Math.abs(t.angularVelocityZ)<e)return s.prevGyrometerReadingNonZero=!1,[0,0];s.prevGyrometerReadingNonZero=!0;var o=1.5*n.degreesToRadians(i/1e3)*Math.sin(s.getVerticalFov()),u=t.angularVelocityY*o,f=t.angularVelocityX*o,r=null;return(Windows&&Windows.Graphics&&Windows.Graphics.Display&&Windows.Graphics.Display.DisplayProperties&&(r=Windows.Graphics.Display.DisplayProperties.currentOrientation),r==null||r===Windows.Graphics.Display.DisplayOrientations.none||r===Windows.Graphics.Display.DisplayOrientations.landscape)?[f,u]:r===Windows.Graphics.Display.DisplayOrientations.portrait?[u,-f]:r===Windows.Graphics.Display.DisplayOrientations.landscapeFlipped?[-f,-u]:r===Windows.Graphics.Display.DisplayOrientations.portraitFlipped?[-u,f]:[0,0]}ci.__super.call(this,i,null,r,u,o);var s=this,dt=0,b=0,k=0,y=0,it=t.createIdentity(),gt=t.createIdentity().multiply(it),rt=e,ut=-.7,a=[],p=!1,h=null,c=!1,d=t.createIdentity(),g=t.createIdentity(),v=t.createIdentity(),w=t.createIdentity(),ft=new f(0,0,-1),et=new f(0,1,0),ot=new f(1,0,0),st=new f(0,0,0);this.setDimension=function(n){rt=n},this.setBounds=function(t){t.top>=0&&(this._upperPitchLimit=t.top,this._lowerPitchLimit=Math.min(ut,t.bottom));var i=Math.abs(t.left-t.right);i<n.twoPI&&(t.left>0&&t.left<t.right?(this._upperHeadingLimit=t.left,this._lowerHeadingLimit=t.right):(this._upperHeadingLimit=t.right,this._lowerHeadingLimit=t.left<0?n.twoPI+t.left:t.left))},this.updateCameraProperties=function(){var n,i,r,u,f;this._zoomingToPoint?(u=this._zoomToPointSpring.getCurrent(),n=u[0],i=u[1],r=u[2],this._pitchSpring.setCurrentAndTarget(n),this._headingSpring.setCurrentAndTarget(i),this._fieldOfViewSpring.setCurrentAndTarget(r)):(n=this.constrainPitch(this.getPitch()),i=this.getHeading(),r=this.getVerticalFov()),w.transformVector3Out(ft,this._worldLook),w.transformVector3Out(et,this._worldUp),w.transformVector3Out(ot,this._worldSide),t.createRotationXOut(n,d),t.createRotationYOut(-i,g),g.multiplyOut(d,v),v.transformVector3Out(this._worldLook,this._look),v.transformVector3Out(this._worldUp,this._up),v.transformVector3Out(this._worldSide,this._side),f=st,this._camera.setPosition(f),this._camera.setLook(this._look),this._camera.setUp(this._up),this._camera.setVerticalFov(r),this.viewChangeEvent!=null&&this.viewChangeEvent.fire(this.getView())},this.control=function(n,t){for(var i,e,r,u,f=0;f<t.length;++f){i=t[f];switch(i.type){case"gestureStart":c=!0,this.stopMovingCamera(),vt(i);break;case"gestureChange":pt(i);break;case"gestureEnd":c=!1,yt(i);break;case"discreteZoom":this.onDiscreteZoom(i,null);break;case"keydown":c=!0;this.onKeyDown(i);break;case"keyup":c=!1;this.onKeyUp(i)}}if(this._gyrometer){if(e=new Date,r=this._gyrometer.getCurrentReading(),r&&this.prevGyroReading&&r.timestamp!=this.prevGyroReading.timestamp&&!c&&this.prevFrameTime&&(u=kt(r,e-this.prevFrameTime),u[0]!==0&&u[1]!==0)){var o=ht(),s=o[0]+u[0],h=o[1]-u[1];this.setPitchAndHeading(s,h,!0)}this.prevGyroReading=r,this.prevFrameTime=e}return lt(),bt(),this._camera},this.setGyrometer=function(n){this._gyrometer=n}}function li(t,i,r,u){function g(){if(a){if(h&&v&&(s.x!==e.x||s.y!==e.y)){var t=n.clamp(c+w*(e.y-o.y),f._lowerPitchLimit,f._upperPitchLimit),i=n.normalizeRadian(y+b*(o.x-e.x));f.setViewTarget(t,i,null,!0)}s.x=e.x,s.y=e.y,v=!0}}function nt(){var n=+new Date,t=f._zoomToPointSpring.step(n),i=f._pitchSpring.step(n),r=f._headingSpring.step(n),u=f._fieldOfViewSpring.step(n);return(t&&(f._zoomingToPoint=!1),t&&i&&r&&u)?(f._viewChanging&&f.viewChangeEndEvent!=null&&f.viewChangeEndEvent.fire(f.getView()),f._viewChanging=!1,!0):(f._viewChanging=!0,!1)}function tt(t){var i,r;f._lastGestureScale=1,h=!0,o.x=t.clientX,o.y=t.clientY,c=f._pitchSpring.getCurrent(),y=f._headingSpring.getCurrent(),f._startingPosition=[t.clientX,t.clientY],i=f._camera.getViewport(),w=f._camera.getVerticalFov()/i.getHeight(),k&&(r=Math.min(Math.abs(c),d),b=w/Math.sin(n.halfPI-r))}function it(){f._lastGestureScale=null,h=!1,a=!1,v=!1,c=null,y=null}function rt(n){var t=f._lastGestureScale/n.scale,i,r;if(t!==1){i=(f._startingPosition[0]+n.clientX)/2,r=(f._startingPosition[1]+n.clientY)/2,n.clientX=i,n.clientY=r;f.onDiscreteZoom(n,t)}else h&&(e.x=o.x+n.translationX,e.y=o.y+n.translationY,a=!0);f._lastGestureScale=n.scale}li.__super.call(this,t,i,r,u);var f=this,o=new l(0,0),e=new l(0,0),s=new l(-1,-1),h=!1,a=!1,v=!1,c=null,y=null,p=null,w=null,b=null,k=!0,d=n.degreesToRadians(70);this.control=function(n,t){for(var i,r=0;r<t.length;++r){i=t[r];switch(i.type){case"gestureEnd":it(i);break;case"gestureStart":tt(i);break;case"gestureChange":rt(i);break;case"discreteZoom":this.onDiscreteZoom(i);break;case"keydown":this.onKeyDown(i);break;case"keyup":this.onKeyUp(i)}}return this.updateCameraProperties(),this._camera},this.updateCameraProperties=function(){var u,n,t,i,r;g(),u=nt(),this._zoomingToPoint?(r=this._zoomToPointSpring.getCurrent(),n=r[0],t=r[1],i=r[2],this._pitchSpring.setCurrentAndTarget(n),this._headingSpring.setCurrentAndTarget(t),this._fieldOfViewSpring.setCurrentAndTarget(i)):(n=this.getPitch(),t=this.getHeading(),i=this.getVerticalFov()),this._look=this.calculateLookFromPitchAndHeading(n,t,this._worldLook,this._worldUp,this._worldSide,null),this._up=this.calculateLookFromPitchAndHeading(n,t,this._worldUp,this._worldUp,this._worldSide,null),this._side=this.calculateLookFromPitchAndHeading(n,t,this._worldSide,this._worldUp,this._worldSide,null);var f=this._camera.getLook(),e=this._camera.getUp(),o=this._camera.getVerticalFov();!p&&(p||u)&&f.equals(this._look)&&e.equals(this._worldUp)&&o===i||(this._camera.setLook(this._look),this._camera.setUp(this._worldUp),this._camera.setVerticalFov(i),this.viewChangeEvent!=null&&this.viewChangeEvent.fire(this.getView())),p=!u}}function dr(){var n=this;n.byId={},n.byType={},n.add=function(t){if(t.id==null)throw"expected id property on the item";if(!t.type)throw"expected type property on the item";n.byId[t.id]=t,n.byType[t.type]=n.byType[t.type]||[],n.byType[t.type].push(t)},n.remove=function(t){var i;if(typeof item=="number")i=n.byId[t],n.byType[i.type].remove(i),n.byType[i.type].length===0&&delete n.byType[i.type],delete n.byId[t];else throw"Expected a single ID";},n.update=function(t){var i;if(t.added)for(i=0;i<t.added.length;++i)n.add(t.added[i]);if(t.removed)for(i=0;i<t.removed.length;++i)n.remove(t.removed[i])}}function ai(){this.interactionController=null,this.viewElementContainers=[],this.initialCameraParams=null,this.dataSourceName=null,this.worldConfiguration=null}function vi(n,t){this.message=n,this.innerException=t}function kt(n,t){this.message=n,this.innerException=t}function lt(){lt.__super.call(this),this.tesselator=new ki(c),this.worldConfiguration=null,this.dataSourceName="panorama",this.faceNames=["front","right","back","left","top","bottom"],this.jsonWrapper="http://photosynth.net/jsonproxy.psfx?jsonUrl={0}",this.jsonpWrapperParam="&jsCallback={0}",this.outputMultiLODTiles=!1,this.scanConvertSize=20,this.prevViewTransform=null,this.prevProjectionTransform=null,this.initialCameraParams={verticalFov:n.degreesToRadians(60),position:new f(0,0,0),look:new f(0,.3,-1),up:new f(0,1,0)}}function ot(t,i,r,u){var f;if(!t)throw"urlFormat cannot be null or empty";if(!i)throw"bubbleId must be specified";ot.__super.call(this),this.tesselator=new ki(y);var e=["frontFace","rightFace","backFace","leftFace","topFace","bottomFace"],o=["01","02","03","10","11","12"],s=4;for(this.dataSourceName="streetsidePanorama",this.interactionController=null,this.worldConfiguration={id:"streetsideCube"+i,type:"streetsidePanorama",source:{dimension:2032,tileSize:254,tileOverlap:1,tileBorder:1,minimumLod:8,bounds:{left:-3.1415926535897931,right:3.1415926535897931,top:-1.5707963267948966,bottom:1.5707963267948966},startingPitch:u||0,startingHeading:r||0,projectorAspectRatio:1,projectorFocalLength:.5}},this.initialCameraParams=this.createCameraParameters(n.degreesToRadians(.07),n.degreesToRadians(-10.8),n.degreesToRadians(238.98999999999998),null),f=0;f<e.length;f++){var h=e[f],c=i+o[f],l=t.replace("{quadkey}",c+"{quadkey}"),a=f%s;this.worldConfiguration.source[h]={tileSource:new iu(l,a).getTileUrl,clip:[0,0,0,2032,2032,2032,2032,0]}}this.viewElementContainers.push(new tr(this.worldConfiguration))}function st(n,t,i,r){var u=this;u.x=t?Math.floor(t):0,u.y=i?Math.floor(i):0,u.levelOfDetail=n?Math.floor(n):0,u.faceName=r||+new Date,u.id=u.faceName.toString().concat(u.levelOfDetail.toString(),"_",u.x.toString(),"_",u.y.toString())}function gr(n,t,i,r,u,f,e){this.geometryPolygon=n,this.texturePolygon=t,this.faceTransform=i,this.textureSource=r,this.viewElementId=u,this.viewElementWidth=f||256,this.viewElementHeight=e||256}function dt(n){this._geometry=n}function nr(n){dt.apply(this,new Array(new ir(n)))}function tr(n){dt.apply(this,new Array(new rr(n)))}function gt(t){this._worldConfiguration=t,this._viewElementsByLod=[],this._minimumLod=t.source.minimumLod,this._maximumLod=t.source.maximumLod||n.ceilLog2(t.source.dimension),this._baseImageWidth=t.source.dimension,this._baseImageHeight=t.source.dimension,this._tileWidth=t.source.tileSize,this._tileHeight=t.source.tileSize,this._tileOverlap=t.source.tileOverlap,this._tileBorder=t.source.tileBorder,this._faceNames=["frontFace","rightFace","backFace","leftFace","topFace","bottomFace"]}function ir(){function f(n,t){e(r._worldConfiguration.source[t.faceName],i.cubeSideBase,t.lod,r._viewElementsByLod[t.lod],r._tileWidth,r._tileHeight,r._baseImageWidth,r._baseImageHeight,r._maximumLod,n,t)}function e(t,r,f,e,o,s,h,c,a,v,y){function hi(n,t,i){return n&&t!=i?i:t}function ci(n,t,i){for(var f=0,e=i,u,r=1,o=n.length;r<o;r++)u=n[r]-n[r-1],f==0?f=u:f!=u&&(e=Math.abs(t*u));return e}function li(n,t,i,r,u){var f,e,o;if(i==1&&!u)return[n,n+r];for(f=[n],e=1,o=0;e<=i;e++,o++)f[e]=f[o]+r;return u&&f.push(t),f}var yt=r[0].x,ai=r[0].y,it=r[0].z,rt=r[0].w,pt=Math.pow(2,a-f),ut=i._cubeSide,d=h/pt,g=c/pt,wt=[],et=t.clip,bt=et.length,kt,nt,dt,gt,w,ht,ti,ii,b,k,at,vt;if(bt%2!=0)throw"The clip region defined for the current face is invalid.";for(kt=r[1].y,nt=0;nt<bt;nt+=2)dt=et[nt],gt=et[nt+1],wt.push(new l(yt+dt*ut/h,kt-gt*ut/c));var p=Math.ceil(d/o),tt=Math.ceil(g/s),ni=0,vi=0,ot=1,st=1;p>1&&(ni=Math.floor(d-o*(p-1)),vi=Math.floor(g-s*(tt-1)),ot=ut*(o/d),st=ut*(s/g)),w=!n.isZero(ni),ht=w,!w&&p>1&&(p--,tt--),ti=p-w,ii=tt-ht,ot!=st;var ct=li(yt,r[2].x,ti,ot,w),lt=li(r[1].y,ai,ii,-st,ht),ri=0,ui=0;for(w&&(ri=ci(ct,d,o),ui=ci(lt,g,s)),b=0;b<p;b++)for(k=0;k<tt;k++){var fi=ct[b],ei=ct[b+1],oi=lt[k],si=lt[k+1],ft=[new u(fi,si,it,rt),new u(fi,oi,it,rt),new u(ei,oi,it,rt),new u(ei,si,it,rt)];i.AreIntersecting(ft,wt)&&(ft.x=b,ft.y=k,at=d,vt=g,w&&(at=hi(b==p-1,o,ri),vt=hi(k==tt-1,s,ui)),v(e,ft,i._texelCornersBase,y,at,vt))}return}gt.apply(this,arguments);var r=this;this.getViewElements=function(n,t){return this.constructor.superClass.getViewElements(r,f,n,t)},this.getViewElementById=function(n,t){if(n!=null){var i=this.constructor.superClass.getViewElements(r,f,n.levelOfDetail,t);if(i!=null)return i[n.id]}return null}}function rr(){function r(n,r){i.splitSquareRecursive(i.cubeSideBase,null,r.lod-t._minimumLod,null,t._viewElementsByLod[r.lod],!1,i._texelCornersBase,n,r,t._tileWidth,t._tileHeight)}gt.apply(this,arguments);var t=this;this.getViewElements=function(n,i){return this.constructor.superClass.getViewElements(t,r,n,i)},this.getViewElementById=function(n,i){if(n!=null){var u=this.constructor.superClass.getViewElements(t,r,n.levelOfDetail,i);if(u!=null)return u[n.id]}return null}}function iu(n,t){var i=8;this.getTileUrl=function(r,u,f){var h=f-i,o=new st(h,r,u,null),e,s;if(yi.isInBounds(o)){if(o.levelOfDetail===0)if(t!=null)e=yi.fromTileId(o,!0),s=t;else return null;else e=yi.fromTileId(o,!1),s=e.charAt(e.length-1);return n.replace("{quadkey}",e).replace("{subdomain}",s)}return null}}var d={},it,n,i,r,sr,p,ut,ft,ti,si;d.debugEnabled=!1,it={clip:function(n,t,i,r){if(t.x<n.x||t.y<n.y||t.z<n.z)throw"clip bounds should have positive volume";var u={clipBounds:{x:n.x,y:n.y,z:n.z,sizeX:t.x-n.x,sizeY:t.y-n.y,sizeZ:t.z-n.z},poly:i,polyTextureCoords:r||null,polyVertexCount:i.length,clippedPoly:new Array(i.length+6),clippedPolyTextureCoords:r===undefined||r==null?null:new Array(r.length+6),clippedPolyVertexCount:0,tempVertexBuffer:new Array(i.length+6),tempTextureCoordBuffer:r===undefined||r==null?null:new Array(r.length+6),isClipped:!1};return it.clipConvexPolygonGeneral(u),u.clippedPoly.length=u.clippedPolyVertexCount,{polygon:u.clippedPoly,polygonTexture:u.clippedPolyTextureCoords,isClipped:u.isClipped}},clipConvexPolygonGeneral:function(n){var i;if(!n.clipBounds)throw"expected clip bounds option";if(n.polyVertexCount<3||n.poly==null||n.poly.length<n.polyVertexCount||n.clippedPoly==null||n.clippedPoly.length<n.polyVertexCount+6||n.tempVertexBuffer==null||n.tempVertexBuffer.length<n.polyVertexCount+6)throw"polygon arrays must have sufficient capacity";if(n.polyTextureCoords!=null&&(n.polyTextureCoords.length<n.polyVertexCount||n.clippedPolyTextureCoords==null||n.clippedPolyTextureCoords.Length<n.polyVertexCount+6||n.tempTextureCoordBuffer==null||n.tempTextureCoordBuffer.Length<n.polyVertexCount+6))throw"polygon arrays must have sufficient capacity";i=n.tempVertexBuffer,n.tempVertexBuffer=n.clippedPoly,n.clippedPoly=i,i=null,i=n.tempTextureCoordBuffer,n.tempTextureCoordBuffer=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null;var r=n.tempVertexBuffer,e=n.tempTextureCoordBuffer,f=n.polyVertexCount,u,t,o,s;for(n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=n.poly[u].x-n.clipBounds.x*n.poly[u].w,s=n.poly[t].x-n.clipBounds.x*n.poly[t].w,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=n.poly,n.clippedPolyTextureCoordsCurrent=n.polyTextureCoords,it.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=(n.clipBounds.x+n.clipBounds.sizeX)*r[u].w-r[u].x,s=(n.clipBounds.x+n.clipBounds.sizeX)*r[t].w-r[t].x,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,it.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=r[u].y-n.clipBounds.y*r[u].w,s=r[t].y-n.clipBounds.y*r[t].w,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,it.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=(n.clipBounds.y+n.clipBounds.sizeY)*r[u].w-r[u].y,s=(n.clipBounds.y+n.clipBounds.sizeY)*r[t].w-r[t].y,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,it.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=r[u].z-n.clipBounds.z*r[u].w,s=r[t].z-n.clipBounds.z*r[t].w,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,it.genericClipAgainstPlane(n),u=t;if(n.clippedPolyVertexCount!=0){for(i=r,r=n.clippedPoly,n.clippedPoly=i,i=null,i=e,e=n.clippedPolyTextureCoords,n.clippedPolyTextureCoords=i,i=null,f=n.clippedPolyVertexCount,n.clippedPolyVertexCount=0,u=f-1,t=0;t<f;t++)o=(n.clipBounds.z+n.clipBounds.sizeZ)*r[u].w-r[u].z,s=(n.clipBounds.z+n.clipBounds.sizeZ)*r[t].w-r[t].z,n.BC0=o,n.BC1=s,n.p0Idx=u,n.p1Idx=t,n.clippedPolyCurrent=r,n.clippedPolyTextureCoordsCurrent=e,it.genericClipAgainstPlane(n),u=t;n.clippedPolyCurrent=null,n.clippedPolyTextureCurrent=null}}}}}},genericClipAgainstPlane:function(n){var t;n.BC1>=0?(n.BC0<0&&(t=n.BC0/(n.BC0-n.BC1),n.clippedPoly[n.clippedPolyVertexCount]=n.clippedPolyCurrent[n.p0Idx].lerp(n.clippedPolyCurrent[n.p1Idx],t),n.clippedPolyTextureCoords!=null&&(n.clippedPolyTextureCoords[n.clippedPolyVertexCount]=n.clippedPolyTextureCoordsCurrent[n.p0Idx].lerp(n.clippedPolyTextureCoordsCurrent[n.p1Idx],t)),n.clippedPolyVertexCount++,n.isClipped=!0),n.clippedPoly[n.clippedPolyVertexCount]=n.clippedPolyCurrent[n.p1Idx],n.clippedPolyTextureCoords!=null&&(n.clippedPolyTextureCoords[n.clippedPolyVertexCount]=n.clippedPolyTextureCoordsCurrent[n.p1Idx]),n.clippedPolyVertexCount++):n.BC0>=0&&(t=n.BC0/(n.BC0-n.BC1),n.clippedPoly[n.clippedPolyVertexCount]=n.clippedPolyCurrent[n.p0Idx].lerp(n.clippedPolyCurrent[n.p1Idx],t),n.clippedPolyTextureCoords!=null&&(n.clippedPolyTextureCoords[n.clippedPolyVertexCount]=n.clippedPolyTextureCoordsCurrent[n.p0Idx].lerp(n.clippedPolyTextureCoordsCurrent[n.p1Idx],t)),n.clippedPolyVertexCount++,n.isClipped=!0)}},n={},n.zeroTolerance=1e-12,n.halfPI=Math.PI/2,n.twoPI=2*Math.PI,n.oneEightyOverPI=180/Math.PI,n.piOverOneEighty=Math.PI/180,n.isZero=function(t){return Math.abs(t)<n.zeroTolerance},n.degreesToRadians=function(t){return t*n.piOverOneEighty},n.radiansToDegrees=function(t){return t*n.oneEightyOverPI},n.normalizeRadian=function(t){while(t<0)t+=n.twoPI;while(t>=n.twoPI)t-=n.twoPI;return t},n.pickStartHeadingToTakeShortestPath=function(t,i){return Math.abs(i-t)>Math.PI?t<i?t+n.twoPI:t-n.twoPI:t},n.invSqrt=function(n){return 1/Math.sqrt(n)},n.isFinite=function(n){return n>Number.NEGATIVE_INFINITY&&n<Number.POSITIVE_INFINITY},n.clamp=function(n,t,i){return Math.min(Math.max(n,t),i)},n.logBase=function(n,t){return Math.log(n)/Math.log(t)},n.ceilLog2=function(t){return Math.ceil(n.logBase(t,2))},n.compareTo=function(n,t){return n<t?-1:n===t?0:1},n.divPow2RoundUp=function(t,i){return n.divRoundUp(t,1<<i)},n.divRoundUp=function(n,t){return Math.ceil(n/t)},n.isPowerOfTwo=function(n){return(n&n-1)==0},n.nextHighestPowerOfTwo=function(n){--n;for(var t=1;t<32;t<<=1)n=n|n>>t;return n+1},n.distanceBetweenTwoPoints=function(n,t,i,r){return Math.sqrt((i-n)*(i-n)+(r-t)*(r-t))},ht.prototype.inverse=function(){var t=this.m00*this.m11-this.m01*this.m10,n;return t==0?null:(n=1/t,new ht(n*this.m11,n*-this.m01,n*-this.m10,n*this.m00))},ht.prototype.dotMatrix2x2=function(n){return new ht(this.m00*n.m00+this.m01*n.m10,this.m00*n.m01+this.m01*n.m11,this.m10*n.m00+this.m11*n.m10,this.m10*n.m01+this.m11*n.m11)},ht.prototype.dotVector2=function(n){return new l(n.x*this.m00+n.y*this.m10,n.x*this.m01+n.y*this.m11)},ht.Identity=function(){return new ht(1,0,0,1)},t.createCopy=function(n){return new t(n.m11,n.m12,n.m13,n.m14,n.m21,n.m22,n.m23,n.m24,n.m31,n.m32,n.m33,n.m34,n.m41,n.m42,n.m43,n.m44)},t.createIdentity=function(){return new t(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)},t.createScale=function(n,i,r){return new t(n,0,0,0,0,i,0,0,0,0,r,0,0,0,0,1)},t.createTranslation=function(n,i,r){return new t(1,0,0,n,0,1,0,i,0,0,1,r,0,0,0,1)},t.createRotationX=function(n){return new t(1,0,0,0,0,Math.cos(n),-Math.sin(n),0,0,Math.sin(n),Math.cos(n),0,0,0,0,1)},t.createRotationY=function(n){return new t(Math.cos(n),0,Math.sin(n),0,0,1,0,0,-Math.sin(n),0,Math.cos(n),0,0,0,0,1)},t.createRotationXOut=function(n,t){t.m11=1,t.m12=0,t.m13=0,t.m14=0,t.m21=0,t.m22=Math.cos(n),t.m23=-Math.sin(n),t.m24=0,t.m31=0,t.m32=Math.sin(n),t.m33=Math.cos(n),t.m34=0,t.m41=0,t.m42=0,t.m43=0,t.m44=1},t.createRotationYOut=function(n,t){t.m11=Math.cos(n),t.m12=0,t.m13=Math.sin(n),t.m14=0,t.m21=0,t.m22=1,t.m23=0,t.m24=0,t.m31=-Math.sin(n),t.m32=0,t.m33=Math.cos(n),t.m34=0,t.m41=0,t.m42=0,t.m43=0,t.m44=1},t.createRotationZ=function(n){return new t(Math.cos(n),-Math.sin(n),0,0,Math.sin(n),Math.cos(n),0,0,0,0,1,0,0,0,0,1)},t.prototype={add:function(n){return new t(this.m11+n.m11,this.m12+n.m12,this.m13+n.m13,this.m14+n.m14,this.m21+n.m21,this.m22+n.m22,this.m23+n.m23,this.m24+n.m24,this.m31+n.m31,this.m32+n.m32,this.m33+n.m33,this.m34+n.m34,this.m41+n.m41,this.m42+n.m42,this.m43+n.m43,this.m44+n.m44)},subtract:function(n){return new t(this.m11-n.m11,this.m12-n.m12,this.m13-n.m13,this.m14-n.m14,this.m21-n.m21,this.m22-n.m22,this.m23-n.m23,this.m24-n.m24,this.m31-n.m31,this.m32-n.m32,this.m33-n.m33,this.m34-n.m34,this.m41-n.m41,this.m42-n.m42,this.m43-n.m43,this.m44-n.m44)},multiply:function(n){return new t(this.m11*n.m11+this.m12*n.m21+this.m13*n.m31+this.m14*n.m41,this.m11*n.m12+this.m12*n.m22+this.m13*n.m32+this.m14*n.m42,this.m11*n.m13+this.m12*n.m23+this.m13*n.m33+this.m14*n.m43,this.m11*n.m14+this.m12*n.m24+this.m13*n.m34+this.m14*n.m44,this.m21*n.m11+this.m22*n.m21+this.m23*n.m31+this.m24*n.m41,this.m21*n.m12+this.m22*n.m22+this.m23*n.m32+this.m24*n.m42,this.m21*n.m13+this.m22*n.m23+this.m23*n.m33+this.m24*n.m43,this.m21*n.m14+this.m22*n.m24+this.m23*n.m34+this.m24*n.m44,this.m31*n.m11+this.m32*n.m21+this.m33*n.m31+this.m34*n.m41,this.m31*n.m12+this.m32*n.m22+this.m33*n.m32+this.m34*n.m42,this.m31*n.m13+this.m32*n.m23+this.m33*n.m33+this.m34*n.m43,this.m31*n.m14+this.m32*n.m24+this.m33*n.m34+this.m34*n.m44,this.m41*n.m11+this.m42*n.m21+this.m43*n.m31+this.m44*n.m41,this.m41*n.m12+this.m42*n.m22+this.m43*n.m32+this.m44*n.m42,this.m41*n.m13+this.m42*n.m23+this.m43*n.m33+this.m44*n.m43,this.m41*n.m14+this.m42*n.m24+this.m43*n.m34+this.m44*n.m44)},multiplyOut:function(n,t){t.m11=this.m11*n.m11+this.m12*n.m21+this.m13*n.m31+this.m14*n.m41,t.m12=this.m11*n.m12+this.m12*n.m22+this.m13*n.m32+this.m14*n.m42,t.m13=this.m11*n.m13+this.m12*n.m23+this.m13*n.m33+this.m14*n.m43,t.m14=this.m11*n.m14+this.m12*n.m24+this.m13*n.m34+this.m14*n.m44,t.m21=this.m21*n.m11+this.m22*n.m21+this.m23*n.m31+this.m24*n.m41,t.m22=this.m21*n.m12+this.m22*n.m22+this.m23*n.m32+this.m24*n.m42,t.m23=this.m21*n.m13+this.m22*n.m23+this.m23*n.m33+this.m24*n.m43,t.m24=this.m21*n.m14+this.m22*n.m24+this.m23*n.m34+this.m24*n.m44,t.m31=this.m31*n.m11+this.m32*n.m21+this.m33*n.m31+this.m34*n.m41,t.m32=this.m31*n.m12+this.m32*n.m22+this.m33*n.m32+this.m34*n.m42,t.m33=this.m31*n.m13+this.m32*n.m23+this.m33*n.m33+this.m34*n.m43,t.m34=this.m31*n.m14+this.m32*n.m24+this.m33*n.m34+this.m34*n.m44,t.m41=this.m41*n.m11+this.m42*n.m21+this.m43*n.m31+this.m44*n.m41,t.m42=this.m41*n.m12+this.m42*n.m22+this.m43*n.m32+this.m44*n.m42,t.m43=this.m41*n.m13+this.m42*n.m23+this.m43*n.m33+this.m44*n.m43,t.m44=this.m41*n.m14+this.m42*n.m24+this.m43*n.m34+this.m44*n.m44},multiplyScalar:function(n){return new t(this.m11*n,this.m12*n,this.m13*n,this.m14*n,this.m21*n,this.m22*n,this.m23*n,this.m24*n,this.m31*n,this.m32*n,this.m33*n,this.m34*n,this.m41*n,this.m42*n,this.m43*n,this.m44*n)},transpose:function(){return new t(this.m11,this.m21,this.m31,this.m41,this.m12,this.m22,this.m32,this.m42,this.m13,this.m23,this.m33,this.m43,this.m14,this.m24,this.m34,this.m44)},transformVector4:function(n){var t=n.x,i=n.y,r=n.z,f=n.w;return new u(this.m11*t+this.m12*i+this.m13*r+this.m14*f,this.m21*t+this.m22*i+this.m23*r+this.m24*f,this.m31*t+this.m32*i+this.m33*r+this.m34*f,this.m41*t+this.m42*i+this.m43*r+this.m44*f)},transformVector4Out:function(n,t){var i=n.x,r=n.y,u=n.z,f=n.w;t.x=this.m11*i+this.m12*r+this.m13*u+this.m14*f,t.y=this.m21*i+this.m22*r+this.m23*u+this.m24*f,t.z=this.m31*i+this.m32*r+this.m33*u+this.m34*f,t.w=this.m41*i+this.m42*r+this.m43*u+this.m44*f},transformVector3:function(n){return new f(this.m11*n.x+this.m12*n.y+this.m13*n.z,this.m21*n.x+this.m22*n.y+this.m23*n.z,this.m31*n.x+this.m32*n.y+this.m33*n.z)},transformVector3Out:function(n,t){t.x=this.m11*n.x+this.m12*n.y+this.m13*n.z,t.y=this.m21*n.x+this.m22*n.y+this.m23*n.z,t.z=this.m31*n.x+this.m32*n.y+this.m33*n.z},determinant:function(){var n,t,i,r,u,f,e,o,s,h,c,l;return n=this.m11*this.m22-this.m12*this.m21,t=this.m11*this.m23-this.m13*this.m21,i=this.m11*this.m24-this.m14*this.m21,r=this.m12*this.m23-this.m13*this.m22,u=this.m12*this.m24-this.m14*this.m22,f=this.m13*this.m24-this.m14*this.m23,e=this.m31*this.m42-this.m32*this.m41,o=this.m31*this.m43-this.m33*this.m41,s=this.m31*this.m44-this.m34*this.m41,h=this.m32*this.m43-this.m33*this.m42,c=this.m32*this.m44-this.m34*this.m42,l=this.m33*this.m44-this.m34*this.m43,n*l-t*c+i*h+r*s-u*o+f*e},inverse:function(){var r,u,f,e,o,s,h,c,l,a,v,y,p,i,w,b,k,d,g,nt,tt,it,rt,ut,ft,et,ot,st,ht,ct;return(r=this.m11*this.m22-this.m12*this.m21,u=this.m11*this.m23-this.m13*this.m21,f=this.m11*this.m24-this.m14*this.m21,e=this.m12*this.m23-this.m13*this.m22,o=this.m12*this.m24-this.m14*this.m22,s=this.m13*this.m24-this.m14*this.m23,h=this.m31*this.m42-this.m32*this.m41,c=this.m31*this.m43-this.m33*this.m41,l=this.m31*this.m44-this.m34*this.m41,a=this.m32*this.m43-this.m33*this.m42,v=this.m32*this.m44-this.m34*this.m42,y=this.m33*this.m44-this.m34*this.m43,p=r*y-u*v+f*a+e*l-o*c+s*h,Math.abs(p)<n.zeroTolerance)?t.createIdentity():(w=this.m22*y-this.m23*v+this.m24*a,b=-this.m12*y+this.m13*v-this.m14*a,k=this.m42*s-this.m43*o+this.m44*e,d=-this.m32*s+this.m33*o-this.m34*e,g=-this.m21*y+this.m23*l-this.m24*c,nt=this.m11*y-this.m13*l+this.m14*c,tt=-this.m41*s+this.m43*f-this.m44*u,it=this.m31*s-this.m33*f+this.m34*u,rt=this.m21*v-this.m22*l+this.m24*h,ut=-this.m11*v+this.m12*l-this.m14*h,ft=this.m41*o-this.m42*f+this.m44*r,et=-this.m31*o+this.m32*f-this.m34*r,ot=-this.m21*a+this.m22*c-this.m23*h,st=this.m11*a-this.m12*c+this.m13*h,ht=-this.m41*e+this.m42*u-this.m43*r,ct=this.m31*e-this.m32*u+this.m33*r,i=1/p,new t(w*i,b*i,k*i,d*i,g*i,nt*i,tt*i,it*i,rt*i,ut*i,ft*i,et*i,ot*i,st*i,ht*i,ct*i))},toString:function(){return this.m11+", "+this.m12+", "+this.m13+", "+this.m14+"\n"+this.m21+", "+this.m22+", "+this.m23+", "+this.m24+"\n"+this.m31+", "+this.m32+", "+this.m33+", "+this.m34+"\n"+this.m41+", "+this.m42+", "+this.m43+", "+this.m44+"\n"},pullToZero:function(){Math.abs(this.m11)<n.zeroTolerance&&(this.m11=0),Math.abs(this.m12)<n.zeroTolerance&&(this.m12=0),Math.abs(this.m13)<n.zeroTolerance&&(this.m13=0),Math.abs(this.m14)<n.zeroTolerance&&(this.m14=0),Math.abs(this.m21)<n.zeroTolerance&&(this.m21=0),Math.abs(this.m22)<n.zeroTolerance&&(this.m22=0),Math.abs(this.m23)<n.zeroTolerance&&(this.m23=0),Math.abs(this.m24)<n.zeroTolerance&&(this.m24=0),Math.abs(this.m31)<n.zeroTolerance&&(this.m31=0),Math.abs(this.m32)<n.zeroTolerance&&(this.m32=0),Math.abs(this.m33)<n.zeroTolerance&&(this.m33=0),Math.abs(this.m34)<n.zeroTolerance&&(this.m34=0),Math.abs(this.m41)<n.zeroTolerance&&(this.m41=0),Math.abs(this.m42)<n.zeroTolerance&&(this.m42=0),Math.abs(this.m43)<n.zeroTolerance&&(this.m43=0),Math.abs(this.m44)<n.zeroTolerance&&(this.m44=0)},flattenColumnMajor:function(){return[this.m11,this.m21,this.m31,this.m41,this.m12,this.m22,this.m32,this.m42,this.m13,this.m23,this.m33,this.m43,this.m14,this.m24,this.m34,this.m44]},flattenRowMajor:function(){return[this.m11,this.m12,this.m13,this.m14,this.m21,this.m22,this.m23,this.m24,this.m31,this.m32,this.m33,this.m34,this.m41,this.m42,this.m43,this.m44]}},vt.createFromPoints=function(n,t,i){var f=t.subtract(n),e=i.subtract(n),r=f.cross(e),u;return r=r.normalize(),u=-1*(r.x*n.x+r.y*n.y+r.z*n.z),new vt(r.x,r.y,r.z,u,null)},vt.createFromPointAndNormal=function(n,t){var i=-1*(t.x*n.x+t.y*n.y+t.z*n.z);return new vt(t.x,t.y,t.z,i,n)},vt.intersectWithRay=function(t,i){var u,r;if(i.point===null)throw"requires plane.point to not equal null";return(u=t.direction.dot(i.normal),n.isZero(u))?null:(r=i.point.subtract(t.origin).dot(i.normal)/t.direction.dot(i.normal),r<=0)?null:t.origin.add(t.direction.multiplyScalar(r))},vt.prototype={transformNormal:function(n){var i=n.inverse().transpose(),t=i.transformVector3(this.normal);return new f(t.x,t.y,t.z)},toString:function(){return"A:"+this.a+", B:"+this.b+", C:"+this.c+", D:"+this.d}},s.createIdentity=function(){return new s(1,0,0,0)},s.fromRotationMatrix=function(t){var f,r,i,u;if(i=new s(0,0,0,0),f=t.m11+t.m22+t.m33,f>n.zeroTolerance)i.w=Math.sqrt(f+1)*.5,r=1/(4*i.w),i.x=(t.m32-t.m23)*r,i.y=(t.m13-t.m31)*r,i.z=(t.m21-t.m12)*r;else{u=0,t.m22>t.m11?(u=1,t.m33>t.m22&&(u=2)):t.m33>t.m11&&(u=2);switch(u){case 0:i.x=.5*Math.sqrt(t.m11-t.m22-t.m33+1),r=1/(4*i.x),i.w=(t.m32-t.m23)*r,i.y=(t.m12+t.m21)*r,i.z=(t.m13+t.m31)*r;break;case 1:i.y=.5*Math.sqrt(t.m22-t.m11-t.m33+1),r=1/(4*i.y),i.w=(t.m13-t.m31)*r,i.x=(t.m12+t.m21)*r,i.z=(t.m23+t.m32)*r;break;case 2:i.z=.5*Math.sqrt(t.m33-t.m11-t.m22+1),r=1/(4*i.z),i.w=(t.m21-t.m12)*r,i.x=(t.m13+t.m31)*r,i.y=(t.m32+t.m23)*r}}return i},s.fromAxisAngle=function(n,t){var r,i;return r=.5*t,i=Math.sin(r),new s(Math.cos(r),n.x*i,n.y*i,n.z*i)},s.fromAxisAngleOut=function(n,t,i){var u,r;u=.5*t,r=Math.sin(u),i.w=Math.cos(u),i.x=n.x*r,i.y=n.y*r,i.z=n.z*r},s.slerp=function(t,i,r){var e,u,o,f,s,h;return t===0?i:t>=1?r:(e=i.dot(r),u=Math.acos(e),Math.abs(u)>=n.zeroTolerance)?(o=Math.sin(u),f=1/o,s=Math.sin((1-t)*u)*f,h=Math.sin(t*u)*f,i.multiplyScalar(s).add(r.multiplyScalar(h))):i},s.prototype={dot:function(n){return this.w*n.w+this.x*n.x+this.y*n.y+this.z*n.z},length:function(){return Math.sqrt(this.w*this.w+this.x*this.x+this.y*this.y+this.z*this.z)},normalize:function(){var i,t;return(i=this.length(),i<n.zeroTolerance)?new s(0,0,0,0):(t=1/i,new s(this.w*t,this.x*t,this.y*t,this.z*t))},inverse:function(){var i,t;return(i=this.w*this.w+this.x*this.x+this.y*this.y*this.z*this.z,Math.abs(i)>n.zeroTolerance)?(t=1/i,new s(this.w*t,-this.x*t,-this.y*t,-this.z*t)):new s(0,0,0,0)},conjugate:function(){return new s(this.w,-this.x,-this.y,-this.z)},transform:function(n){var i,r,t;return r=2*(this.x*n.x+this.y*n.y+this.z*n.z),t=2*this.w,i=t*this.w-1,new f(i*n.x+r*this.x+t*(this.y*n.z-this.z*n.y),i*n.y+r*this.y+t*(this.z*n.x-this.x*n.z),i*n.z+r*this.z+t*(this.x*n.y-this.y*n.x))},transformOut:function(n,t){var r,u,i;u=2*(this.x*n.x+this.y*n.y+this.z*n.z),i=2*this.w,r=i*this.w-1,t.x=r*n.x+u*this.x+i*(this.y*n.z-this.z*n.y),t.y=r*n.y+u*this.y+i*(this.z*n.x-this.x*n.z),t.z=r*n.z+u*this.z+i*(this.x*n.y-this.y*n.x)},add:function(n){return new s(this.w+n.w,this.x+n.x,this.y+n.y,this.z+n.z)},multiply:function(n){return new s(this.w*n.w-this.x*n.x-this.y*n.y-this.z*n.z,this.y*n.z-this.z*n.y+this.w*n.x+n.w*this.x,this.z*n.x-this.x*n.z+this.w*n.y+n.w*this.y,this.x*n.y-this.y*n.x+this.w*n.z+n.w*this.z)},multiplyOut:function(n,t){t.w=this.w*n.w-this.x*n.x-this.y*n.y-this.z*n.z,t.x=this.y*n.z-this.z*n.y+this.w*n.x+n.w*this.x,t.y=this.z*n.x-this.x*n.z+this.w*n.y+n.w*this.y,t.z=this.x*n.y-this.y*n.x+this.w*n.z+n.w*this.z},multiplyScalar:function(n){return new s(this.w*n,this.x*n,this.y*n,this.z*n)},toRotationMatrix:function(){var r,i,n,u,f,e,o,s,h,c,l,a;return r=2*this.x,i=2*this.y,n=2*this.z,u=r*this.w,f=i*this.w,e=n*this.w,o=r*this.x,s=i*this.x,h=n*this.x,c=i*this.y,l=n*this.y,a=n*this.z,new t(1-(c+a),s-e,h+f,0,s+e,1-(o+a),l-u,0,h-f,l+u,1-(o+c),0,0,0,0,1)},toAxisAngle:function(){var i,t;return(i=this.x*this.x+this.y*this.y+this.z*this.z,i>n.zeroTolerance)?(t=n.invSqrt(i),new u(this.x*t,this.y*t,this.z*t,2*Math.acos(this.w))):new u(1,0,0,0)},toString:function(){return"["+this.w+", "+this.x+", "+this.y+", "+this.z+"]"}},er.prototype={intersect:function(n){if(this.intersectsWith(n)){var t=Math.max(this.x,n.x),i=Math.max(this.y,n.y);this.width=Math.max(Math.min(this.x+this.width,n.x+n.width)-t,0),this.height=Math.max(Math.min(this.y+this.height,n.y+n.height)-i,0),this.x=t,this.y=i}else this.x=this.y=this.width=this.height=0},intersectsWith:function(n){return this.width<0||n.width<0?!1:n.x<=this.x+this.width&&n.x+n.width>=this.x&&n.y<=this.y+this.height&&n.y+n.height>=this.y},getLeft:function(){return this.x},getRight:function(){return this.x+this.width},getTop:function(){return this.y},getBottom:function(){return this.y+this.height}},l.clone=function(n){return new l(n.x,n.y)},l.prototype={dot:function(n){return this.x*n.x+this.y*n.y},perp:function(){return new l(this.y,-this.x)},normalize:function(){var t,i;return(t=this.length(),t<n.zeroTolerance)?new l(0,0):(i=1/t,new l(this.x*i,this.y*i))},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSquared:function(){return this.x*this.x+this.y*this.y},add:function(n){return new l(this.x+n.x,this.y+n.y)},subtract:function(n){return new l(this.x-n.x,this.y-n.y)},multiplyScalar:function(n){return new l(this.x*n,this.y*n)},equals:function(n){return this.x===n.x&&this.y===n.y},lerp:function(n,t){return new l(this.x+t*(n.x-this.x),this.y+t*(n.y-this.y))},toString:function(){return"["+this.x+", "+this.y+"]"}},f.createFromVector2=function(n,t){return new f(n.x,n.y,t)},f.clone=function(n){return new f(n.x,n.y,n.z)},f.prototype={dot:function(n){return this.x*n.x+this.y*n.y+this.z*n.z},normalize:function(){var i,t;return(i=this.length(),i<n.zeroTolerance)?new f(0,0,0):(t=1/i,new f(this.x*t,this.y*t,this.z*t))},normalizeOut:function(t){var r,i;if(r=this.length(),r<n.zeroTolerance){t.x=0,t.y=0,t.z=0;return}i=1/r,t.x=this.x*i,t.y=this.y*i,t.z=this.z*i;return},cross:function(n){return new f(this.y*n.z-this.z*n.y,this.z*n.x-this.x*n.z,this.x*n.y-this.y*n.x)},crossOut:function(n,t){t.x=this.y*n.z-this.z*n.y,t.y=this.z*n.x-this.x*n.z,t.z=this.x*n.y-this.y*n.x},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSquared:function(){return this.x*this.x+this.y*this.y+this.z*this.z},add:function(n){return new f(this.x+n.x,this.y+n.y,this.z+n.z)},subtract:function(n){return new f(this.x-n.x,this.y-n.y,this.z-n.z)},subtractOut:function(n,t){t.x=this.x-n.x,t.y=this.y-n.y,t.z=this.z-n.z},multiplyScalar:function(n){return new f(this.x*n,this.y*n,this.z*n)},multiplyScalarOut:function(n,t){t.x=this.x*n,t.y=this.y*n,t.z=this.z*n},equals:function(n){return this.x===n.x&&this.y===n.y&&this.z===n.z},lerp:function(n,t){return new f(this.x+t*(n.x-this.x),this.y+t*(n.y-this.y),this.z+t*(n.z-this.z))},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}},u.createFromVector3=function(n){return new u(n.x,n.y,n.z,1)},u.prototype={dot:function(n){return this.x*n.x+this.y*n.y+this.z*n.z+this.w*n.w},normalize:function(){var i,t;return(i=this.length(),i<n.zeroTolerance)?new u(0,0,0,0):(t=1/i,new u(this.x*t,this.y*t,this.z*t,this.w*t))},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSquared:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},add:function(n){return new u(this.x+n.x,this.y+n.y,this.z+n.z,this.w+n.w)},subtract:function(n){return new u(this.x-n.x,this.y-n.y,this.z-n.z,this.w-n.w)},multiplyScalar:function(n){return new u(this.x*n,this.y*n,this.z*n,this.w*n)},equals:function(n){return this.x===n.x&&this.y===n.y&&this.z===n.z&&this.w===n.w},lerp:function(n,t){return new u(this.x+t*(n.x-this.x),this.y+t*(n.y-this.y),this.z+t*(n.z-this.z),this.w+t*(n.w-this.w))},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}},i={},i.rotatedPos=new f(0,0,0),i.viewSide=new f(0,0,0),i.viewUp=new f(0,0,0),i.createLookAtRHOut=function(n,t,r,u){var e=i.rotatedPos,o=i.viewSide,f=i.viewUp;t.normalizeOut(t),r.normalizeOut(r),t.multiplyScalarOut(r.dot(t),f),r.subtractOut(f,f),f.normalizeOut(f),t.crossOut(f,o),u.m11=o.x,u.m12=o.y,u.m13=o.z,u.m21=f.x,u.m22=f.y,u.m23=f.z,u.m31=-t.x,u.m32=-t.y,u.m33=-t.z,u.transformVector3Out(n,e),u.m14=-e.x,u.m24=-e.y,u.m34=-e.z},i.createPerspective=function(n,i,r,u,f){var e,o;return e=1/Math.tan(n/2),o=new t(e/i,0,f.x*2,0,0,e,f.y*2,0,0,0,u/(u-r),-(r*u)/(u-r),0,0,-1,0)},i.createPerspectiveFromFrustumOut=function(n,t,i,r,u,f,e){e.m11=2*u/(t-n),e.m12=0,e.m13=(t+n)/(t-n),e.m14=0,e.m21=0,e.m22=2*u/(r-i),e.m23=(r+i)/(r-i),e.m24=0,e.m31=0,e.m32=0,e.m33=-1*(f+u)/(f-u),e.m34=-2*f*u/(f-u),e.m41=0,e.m42=0,e.m43=-1,e.m44=0},i.createPerspectiveOGLOut=function(n,t,r,u,f){var e=r*Math.tan(n/2),o=-e,s=o*t,h=e*t,c=r,l=u;i.createPerspectiveFromFrustumOut(s,h,o,e,c,l,f)},i.projectOntoPlane=function(n,i){var r=n,u=i.normal,f=i.d,e=u.dot(r),o=e+f-r.x*u.x,s=-r.x*u.y,h=-r.x*u.z,c=-r.x*f,l=-r.y*u.x,a=e+f-r.y*u.y,v=-r.y*u.z,y=-r.y*f,p=-r.z*u.x,w=-r.z*u.y,b=e+f-r.z*u.z,k=-r.z*f,d=-u.x,g=-u.y,nt=-u.z,tt=e;return new t(o,s,h,c,l,a,v,y,p,w,b,k,d,g,nt,tt)},i.createViewportToScreen=function(n,i){var r=t.createIdentity();return r.m11=n/2,r.m12=0,r.m13=0,r.m14=0,r.m21=0,r.m22=i/-2,r.m23=0,r.m24=0,r.m31=0,r.m32=0,r.m33=1,r.m34=0,r.m41=n/2,r.m42=i/2,r.m43=0,r.m44=1,r=r.transpose()},i.parseQuaternion=function(t,i,r){var u=1-(t*t+i*i+r*r);return u<n.zeroTolerance&&(u=0),new s(Math.sqrt(u),t,i,r)},i._halfCube=.5,i._halfCubeSquared=i._halfCube*i._halfCube,i._cubeSide=i._halfCube*2,i._dummyCornerBase=[new u(0,1,0,1),new u(0,0,0,1),new u(1,0,0,1),new u(1,1,0,1)],i.cubeSideBase=[new u(0,0,0,1),new u(0,i._cubeSide,0,1),new u(i._cubeSide,i._cubeSide,0,1),new u(i._cubeSide,0,0,1)],i._texelCornersBase=[new u(0,1,0,1),new u(0,0,0,1),new u(1,0,0,1),new u(1,1,0,1)],i.splitSquareRecursive=function(n,t,r,f,e,o,s,h,c,l,a){function it(n,t,r){var a=n[0],b=n[1],k=n[2],d=n[3],e=-1,v=null,y=null,p=null,w=null,f=i.splitFunction;r?(v=r[0],y=r[1],p=r[2],w=r[3]):(v=i._dummyCornerBase[0],y=i._dummyCornerBase[1],p=i._dummyCornerBase[2],w=i._dummyCornerBase[3]);var ot=a.x,st=a.y,ht=a.z,o=a.w,ct=v.x,lt=v.y,at=b.x,vt=b.y,ft=b.z,yt=y.x,pt=y.y,wt=k.x,bt=k.y,kt=k.z,dt=p.x,gt=p.y,ni=d.x,ti=d.y,et=d.z,ii=w.x,ri=w.y,g=f(t,ot,at,ct,yt),s=f(t,st,vt,lt,pt),ui=f(t,ht,ft,e,e),h=f(t,at,wt,yt,dt),nt=f(t,vt,bt,pt,gt),fi=f(t,ft,kt,e,e),tt=f(t,wt,ni,dt,ii),c=f(t,bt,ti,gt,ri),ei=f(t,kt,et,e,e),l=f(t,ot,ni,ct,ii),it=f(t,st,ti,lt,ri),oi=f(t,ht,et,e,e),si=f(t,h.xy,l.xy,h.uv,l.uv),hi=f(t,s.xy,c.xy,s.uv,c.uv),ci=f(t,ft,et,e,e),rt=new u(si.xy,hi.xy,ci.xy,o),ut=new u(si.uv,hi.uv,0,1);return{xy:[[a,new u(g.xy,s.xy,ui.xy,o),rt,new u(l.xy,it.xy,oi.xy,o)],[new u(g.xy,s.xy,ui.xy,o),b,new u(h.xy,nt.xy,fi.xy,o),rt],[rt,new u(h.xy,nt.xy,fi.xy,o),k,new u(tt.xy,c.xy,ei.xy,o)],[new u(l.xy,it.xy,oi.xy,o),rt,new u(tt.xy,c.xy,ei.xy,o),d]],uv:r?[[v,new u(g.uv,s.uv,0,1),ut,new u(l.uv,it.uv,0,1)],[new u(g.uv,s.uv,0,1),y,new u(h.uv,nt.uv,0,1),ut],[ut,new u(h.uv,nt.uv,0,1),p,new u(tt.uv,c.uv,0,1)],[new u(l.uv,it.uv,0,1),ut,new u(tt.uv,c.uv,0,1),w]]:null}}var v,y,k;if(h||(h=function(n,t,i){n.squares.push(t),n.texelSquares.push(i)}),n.length!=4)throw"Invalid square array supplied.";if(r==0){var p=n[0],w=n[2],d=o?(p.x+w.x)/2:p.x,g=o?(w.y+p.y)/2:w.y;n.x=f?Math.floor((d-f.initialX)/f.widthFr):0,n.y=f?Math.floor(f.total-(g-f.initialY)/f.heightFr):0,e&&h(e,n,t||s,c,l,a);return}var b=n[0],nt=n[1],tt=n[3];for(f=f||function(){var n=Math.pow(2,r),t=b.x,i=b.y;return{total:n,widthFr:Math.abs((tt.x-t)/n),heightFr:Math.abs((nt.y-i)/n),initialX:t,initialY:i}}(),v=it(n,o,t),r--,y=0,k=v.xy.length;y<k;y++)i.splitSquareRecursive(v.xy[y],v.uv?v.uv[y]:null,r,f,e,o,s,h,c,l,a);return},i.splitFunction=function(n,t,r,u,f){function e(n,t,i,r,u){var f=Math.sqrt(u+n*n),e=Math.sqrt(u+t*t),o=e/(f+e),s=f/(f+e);return{xy:n*o+t*s,uv:i*o+r*s}}function o(n,t,i,r){return{xy:(n+t)/2,uv:(i+r)/2}}return n?e(t,r,u,f,i._halfCubeSquared):o(t,r,u,f)},i.CalculatePolyArea=function(n,t){var i=t?[]:n,f=0,r,o,e,u;if(t)for(e=0;e<n.length;e++)r=n[e],i.push(new l(r.x*t.width,r.y*t.height));for(u=0;u<i.length-1;u++)r=i[u],o=i[u+1],f+=r.x*o.y-o.x*r.y;return f+=i[i.length-1].x*i[0].y-i[0].x*i[i.length-1].y,f/=2,Math.abs(f)},i.AreIntersecting=function(t,i){function v(n,t){for(var i=null,r,u=0;u<n.length;u++)r=n[u].x*t.x+n[u].y*t.y,i==null&&(i={min:r,max:r}),r<i.min?i.min=r:r>i.max&&(i.max=r);return i}function y(n){for(var f=[],i=n.length-1,t=0;t<n.length;t++){var r=n[t].x-n[i].x,u=n[t].y-n[i].y,e=Math.sqrt(r*r+u*u),o={x:r/e,y:-u/e};i=t,f.push(o)}return f}var p=y(t),w=y(i),r=p.concat(w),u,s,f,h,a,e,o,c,l;n:for(u=0;u<r.length;u++)for(s=r[u],f=u+1;f<r.length-1;f++)if(h=r[f],a=n.isZero(1-Math.abs(s.x*h.x+s.y*h.y)),a){delete r[u];continue n}for(e=0;e<r.length;e++)if((o=r[e],o)&&(c=v(t,o),l=v(i,o),c.max<l.min||l.max<c.min))return!1;return!0},i.applyWorldTransformation=function(n,t){for(var r=[],u=n.length,i=0;i<u;i++)r.push(t.transformVector4(n[i]));return r},i.calculateTexelToPixelRatioAtFov=function(n,t,i,r){var u=n*Math.tan(r/2);return t*u/i},i.calculateFovAtTexelToPixelRatio=function(n,t,i,r){return Math.atan(r*i/(t*n))*2};var g={debug:!1,forceIERenderPath:!0,outputMultiLODTiles:!0,scanConvertSize:40,polyInflate:.05},fu={floodFill:function(n,t,i,r){var o,s,c,u,f,h,e;if(this.cachedCrossings={},r==null){if(i.length==0)return[];r=this.calculateStartingTile(n,t,i)}for(o=[r],s=new Array(n*t),s[r.y*n+r.x]=!0,c=[];o.length>0;)for(u=o.shift(),c.push(u),f=[],(this.tileCenterInPolygon(u,i)||this.gridCrossesPolygon(u,i))&&(f.push(this.getLeftNeighbor(u)),f.push(this.getRightNeighbor(u)),f.push(this.getTopNeighbor(u)),f.push(this.getBottomNeighbor(u))),h=0;h<f.length;h++)e=f[h],this.isValidTile(e,n,t)&&!s[e.y*n+e.x]&&(o.push(e),s[e.y*n+e.x]=!0);return c},calculateStartingTile:function(n,t,i){for(var r={x:0,y:0},u=0;u<i.length;u++)r.x+=i[u].x,r.y+=i[u].y;return r.x/=i.length,r.y/=i.length,r.x=Math.floor(r.x),r.y=Math.floor(r.y),r.x=Math.max(0,r.x),r.y=Math.max(0,r.y),r.x=Math.min(n-1,r.x),r.y=Math.min(t-1,r.y),r},getLeftNeighbor:function(n){return{x:n.x-1,y:n.y}},getRightNeighbor:function(n){return{x:n.x+1,y:n.y}},getTopNeighbor:function(n){return{x:n.x,y:n.y-1}},getBottomNeighbor:function(n){return{x:n.x,y:n.y+1}},tileCenterInPolygon:function(n,t){return this.pointInPolygon({x:n.x+.5,y:n.y+.5},t)},isValidTile:function(n,t,i){return isNaN(n.x)||isNaN(n.y)||n.x<0||n.y<0||n.x>=t||n.y>=i?!1:!0},normalizeNumber:function(n){return n>=0?1:-1},gridCrossesPolygon:function(n,t){var i={x:n.x+1,y:n.y},r={x:n.x+1,y:n.y+1},u={x:n.x,y:n.y+1};return this.countCrossings(n,t,null,null)!==this.countCrossings(i,t,null,null)?!0:this.countCrossings(u,t,null,null)!==this.countCrossings(r,t,null,null)?!0:this.countCrossings(n,t,!0,null)!==this.countCrossings(u,t,!0,null)?!0:this.countCrossings(i,t,!0,null)!==this.countCrossings(r,t,!0,null)?!0:!1},pointInPolygon:function(n,t){var i=this.countCrossings(n,t,!0,null);return i%2==1},cachedCrossings:{},countCrossings:function(n,t,i,r){var f=[],u,e,o=0,s,p,w;if(!r&&(s=n.x+","+n.y+(i?",down":",right"),this.cachedCrossings[s]!=null))return this.cachedCrossings[s];if(i)for(u=0;u<t.length;u++)f.push({x:t[u].y-n.y,y:t[u].x-n.x});else for(u=0;u<t.length;u++)f.push({x:t[u].x-n.x,y:t[u].y-n.y});for(u=0;u<f.length;u++){e=u+1,e>=f.length&&(e=0);var h=f[u].y,l=f[e].y,c=f[u].x,a=f[e].x,b=this.normalizeNumber(h),k=this.normalizeNumber(l),v=this.normalizeNumber(c),y=this.normalizeNumber(a);b!=k&&(v===1&&y===1?o++:v!==y&&(p=(h-l)/(c-a),w=h-p*c,w>=0&&o++))}return this.cachedCrossings[s]=o,o}},ui=window.requestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.webkitRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)},or=window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||clearTimeout;r={deleteFromArray:function(n,t){for(var i=0,r=n.length;i<r;)t(n[i])&&n.splice(i,1),i++},log:function(n){window.console&&d.debugEnabled&&window.console.log(n)},_eventListeners:{},bind:function(n,t,i,u){for(var e=t.split(" "),f=0;f<e.length;++f)t=e[f],r._eventListeners[n]||(r._eventListeners[n]={}),r._eventListeners[n][t]||(r._eventListeners[n][t]=[]),n.addEventListener?(t=="mousewheel"&&n.addEventListener("DOMMouseScroll",i,u),n.addEventListener(t,i,u)):n.attachEvent&&(n.attachEvent("on"+t,i),u&&n.setCapture&&n.setCapture()),r._eventListeners[n][t].push([i,u])},_unbindAll:function(n){var t,u,i;if(r._eventListeners[n])for(t in r._eventListeners[n])for(i=0;i<r._eventListeners[n][t].length;++i)r.unbind(n,t,r._eventListeners[n][t][i][0],r._eventListeners[n][t][i][1])},unbind:function(n,t,i,u){if(n&&!t)r._unbindAll(n);else{for(var f,h,o,s=t.split(" "),e=0;e<s.length;++e)if(t=s[e],n.removeEventListener?(t=="mousewheel"&&n.removeEventListener("DOMMouseScroll",i,u),n.removeEventListener(t,i,u)):n.detachEvent&&(n.detachEvent("on"+t,i),u&&n.releaseCapture&&n.releaseCapture()),r._eventListeners[n]&&r._eventListeners[n][t]){for(f=0;f<r._eventListeners[n][t].length;++f)r._eventListeners[n][t][f][0]===i&&r._eventListeners[n][t][f].splice(f,1);r._eventListeners[n][t].length===0&&delete r._eventListeners[n][t]}if(o=0,r._eventListeners[n]){for(h in r._eventListeners[n])++o;o===0&&delete r._eventListeners[n]}}},setOpacity:function(){function t(n,t){n.style.opacity=t}function i(n,t){t*=100;var i;try{i=n.filters.item("DXImageTransform.Microsoft.Alpha"),t<100?(i.Opacity=t,i.enabled||(i.enabled=!0)):i.enabled=!1}catch(r){t<100&&(n.style.filter=(n.currentStyle||n.runtimeStyle).filter+" progid:DXImageTransform.Microsoft.Alpha(opacity="+t+")")}}var n=document.createElement("div");return typeof n.style.opacity!="undefined"&&t||typeof n.style.filter!="undefined"&&i||function(){}}(),css:function(n,t){var i;for(i in t)t.hasOwnProperty(i)&&(i==="opacity"?r.setOpacity(n,t[i]):n.style[i]=t[i])},getWheelDelta:function(n){return n.detail?n.detail*-1:n.wheelDelta/40},isDataUrl:function(n){return/^data:/.test(n)},isRelativeUrl:function(n){var t=/^ftp:\/\//.test(n)||/^http:\/\//.test(n)||/^https:\/\//.test(n)||/^file:\/\//.test(n);return!t},hostnameRegexp:new RegExp("^(?:f|ht)tp(?:s)?://([^/]+)","im"),filehostnameRegexp:new RegExp("^file://([^/]+)","im"),getHostname:function(n){var t=r.hostnameRegexp.exec(n);return t&&t.length===2||(t=r.filehostnameRegexp.exec(n)),t&&t.length===2?t[1].toString():""},areSameDomain:function(n,t){var i=r.getHostname(n).toLowerCase(),u=r.getHostname(t).toLowerCase();return i===u},addScriptElement:function(n){var t=document.createElement("script");t.type="text/javascript",t.language="javascript",t.src=n,document.getElementsByTagName("head")[0].appendChild(t)},partialDotNetStringFormat:function(n){var t,o,u,f,s,i,e,r;if(arguments.length===0)return"";if(arguments.length===1)return n;for(t="",o=0;o<n.length;){if(u=n.indexOf("{"),u===-1)return t+n;if(t+=n.substr(0,u),n=n.substr(u),f=n.indexOf("}"),f<2,s=n.substr(1,f-1),n=n.substr(f+1),i=s.split(":"),e=arguments[parseInt(i[0])+1],i.length===1)t+=e.toString();else if(i[1]==="X")t+=e.toString(16).toUpperCase();else{for(r=e.toString();r.length<i[1].length;)r="0"+r;t+=r}}return t}},rt.prototype.map={},rt.prototype._innerArray=[],rt.prototype._changed=!0,rt.prototype.add=function(n,t){this.map[n]=t,this._changed=!0},rt.prototype.remove=function(n){this._changed|=!!this.map[n],delete this.map[n]},rt.prototype.getArray=function(){var n=this._innerArray,t,i;if(this._changed){t=this.map,n.length=0;for(i in t)n.push(t[i]);this._changed=!1}return n},fi.prototype.GetVertex=function(n){return this._vertexCache=this._vertexCache||new Array(this.geometryPolyArr.length),this._vertexCache[n]===undefined&&(this._vertexCache[n]={g:this.screenArray[n],t:this.textureArray[n]}),this._vertexCache[n]},tt.Wrap={CLAMP_TO_EDGE:1,REPEAT:2},tt.Filter={NEAREST:0,LINEAR:1,LINEAR_MIPMAP_LINEAR:2},h(tt,Object),tt.prototype.loadImageInDOM=function(){this._image=new Image;var n=this;this._image.onload=function(){n._loadCallback&&n._loadCallback(n._url,n._loadCallbackInfo,n),n._isReady=!0,n._isDirty=!0},this._image.crossOrigin="",this._image.src=this._url},h(yt,Object),yt.prototype.apply=function(){throw"You should not have reached base Material.apply().";},h(ei,yt),h(oi,t),oi.prototype.apply=function(){throw"You should not have reached base Transform.apply().";},h(pi,Object),sr=function(){var n=+new Date;return function(){return++n,n}}(),h(v,Object),v.prototype.render=function(){throw"The renderer you are using does not implement the render() method.";},v.prototype.setViewModel=function(n){this._viewModel=n},v.prototype._checkClearColor=function(n){if(!n||n.r==null||n.g==null||n.b==null||n.a==null)throw"Color must include r,g,b,a numeric properties.";},v.prototype.setClearColor=function(){throw"setClearColor is not implemented";},v.prototype._layerIdBackground="BACKGROUND",v.prototype._error=function(n){if(g.debug)throw new Error(n);},v.prototype.setViewProjectionMatrix=function(n){this._viewProjMatrix=n},v.prototype.getType=function(){throw"Renderer must support one of the rendering techniques such as '2D', '3D' etc.";},v.prototype.InitViewElementOpacity=function(n){var t=n.texturesWithPolygons[0].texture._image;n.id.levelOfDetail!=n.worldLod&&(t.opacity=1),t.opacity===undefined&&(t.opacity=.1)},v.prototype.UpdateViewElementOpacity=function(n,t){var i=n.texturesWithPolygons[0].texture._image;i.opacity<1&&(i.opacity+=t)},v.prototype.initLayer=function(){throw"Reached Renderer.prototype.initLayer() instead of concrete implementation.";},v.prototype.finalizeLayer=function(){throw"Reached Renderer.prototype.finalizeLayer() instead of concrete implementation.";},v.prototype.updateAnimation=function(n,t){var i=t;(n.animation===undefined?n.animation=t:i=n.animation,i)&&(n.id.levelOfDetail!=n.worldLod?i.finalize(n):(i.apply(n),n.animation=i.isComplete()?null:i))},h(wi,pi),a.InitRenderableFor3D=function(n){var s=2,t=n.geometryPloygon[0],i=n.geometryPloygon[1],r=n.geometryPloygon[2],u=n.geometryPloygon[3],f;n.geometryPloygon._vertices=[t.x,t.y,t.z,i.x,i.y,i.z,r.x,r.y,r.z,u.x,u.y,u.z],f=n.texturesWithPolygons[0].polygon,t=f[0],i=f[1],r=f[2],u=f[3];var h=n.texturesWithPolygons[0].texture,e=h.dataSourceWidth+s,o=h.dataSourceHeight+s;n.geometryPloygon._texCoords=[i.x/e,i.y/o,t.x/e,t.y/o,u.x/e,u.y/o,r.x/e,r.y/o],n.geometryPloygon._indices=[0,1,2,0,2,3],n.geometryPloygon._texCoordSize=2,n.geometryPloygon._isDirty=!0},a.DrawPolyLine=function(n,t,i){n.beginPath(),i&&(r.log("===================Quad========================="),r.log("x: "+t[0].x+" y: "+t[0].y)),n.moveTo(t[0].x,t[0].y);for(var u=1;u<t.length;u++)i&&r.log("x: "+t[u].x+" y: "+t[u].y),n.lineTo(t[u].x,t[u].y);n.lineTo(t[0].x,t[0].y),i&&r.log("===================STROKE========================="),n.stroke()},a.FilterType={NORMFACTOR:8},a.FilterType.NO_FILTER=[0,0,0,0,1,0,0,0,0],a.FilterType.GAUSSIAN=[1/16,2/16,1/16,2/16,4/16,2/16,1/16,2/16,1/16],a.FilterType.LAPLACIAN=[-1/a.FilterType.NORMFACTOR,-1/a.FilterType.NORMFACTOR,-1/a.FilterType.NORMFACTOR,-1/a.FilterType.NORMFACTOR,17/a.FilterType.NORMFACTOR,-1/a.FilterType.NORMFACTOR,-1/a.FilterType.NORMFACTOR,-1/a.FilterType.NORMFACTOR,-1/a.FilterType.NORMFACTOR],p=new function(){var n=navigator.userAgent,o=navigator.vendor==="Apple Computer, Inc.",h=n.indexOf("Webkit"),u=n.indexOf("Chrome"),t=u!==-1,f=n.indexOf("Firefox"),i=f!==-1,r=t?parseInt(n.substring(u+7)):-1,e=i?parseInt(n.substring(f+8)):-1,s=n.indexOf("Trident")!==-1;this.isWebGLCORSSupported=t&&r>=13||i&&e>=8,this.failsToRenderItemsNearContainerBorder=t&&r<=19,this.isWebGLCORSRequired=i&&e>4||t&&r>=13,this.useImageDisposer=o,this.supportsPreserve3D=!s&&!i},ut={},ut.isValidBrowser=function(){var u=window.CSSMatrix||window.WebKitCSSMatrix||window.MSCSSMatrix||window.MozCSSMatrix,f,e,i,t,n,r;return u==null||p.failsToRenderItemsNearContainerBorder?(ut.isValidBrowser=function(){return!1},!1):(f=new u,!f)?(ut.isValidBrowser=function(){return!1},!1):(e=document.createElement("div"),i=e.style,i.webkitTransform===undefined&&i.msTransform===undefined&&i.mozTransform===undefined)?(ut.isValidBrowser=function(){return!1},!1):p.supportsPreserve3D?(t=document.createElement("div"),n=t.style,n.width="0px",n.height="0px",n.position="absolute",n.overflowX="hidden",n.overflowY="hidden",n.backgroundColor="rgb(0, 0, 0)",t.innerHTML='<div style="position: absolute; z-index: -10; -webkit-transform: matrix3d(772.413793, 0, 0, 0, 0, 772.413793, 0, 0, -537600, -315000, -1050.021, -1050, -772.413793, -112072.413793, 525.0085, 525); -ms-transform: matrix3d(772.413793, 0, 0, 0, 0, 772.413793, 0, 0, -537600, -315000, -1050.021, -1050, -772.413793, -112072.413793, 525.0085, 525); -moz-transform: matrix3d(772.413793, 0, 0, 0, 0, 772.413793, 0, 0, -537600, -315000, -1050.021, -1050, -772.413793, -112072.413793, 525.0085, 525); transform: matrix3d(772.413793, 0, 0, 0, 0, 772.413793, 0, 0, -537600, -315000, -1050.021, -1050, -772.413793, -112072.413793, 525.0085, 525); "><div id="_rwwviewer_cssrenderer_test_id" style="width: 256px; height: 256px;"><\/div><\/div>',document.body.appendChild(t),r=document.getElementById("_rwwviewer_cssrenderer_test_id").getClientRects()[0],document.body.removeChild(t),Math.abs(r.width-377)<=1&&Math.abs(r.height-377)<=1?(ut.isValidBrowser=function(){return!0},!0):(ut.isValidBrowser=function(){return!1},!1)):(ut.isValidBrowser=function(){return!0},!0)},ft={},ft.getWebGLContext=function(n){var i,t,r;if(n.getContext)for(i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],t=0;t<i.length;++t)try{if(r=n.getContext(i[t],{antialias:!0}),r!=null)return r}catch(u){}return null},ft.isValidBrowser=function(){var n=document.createElement("canvas"),t=ft.getWebGLContext(n);if(t){if(p.isWebGLCORSRequired&&!p.isWebGLCORSSupported)return r.log("CORS image textures are not supported in this browser"),ft.isValidBrowser=function(){return!1},!1}else return r.log("WebGL is not supported."),ft.isValidBrowser=function(){return!1},!1;return ft.isValidBrowser=function(){return!0},!0},ti=window.CSSMatrix||window.WebKitCSSMatrix||window.MSCSSMatrix||window.MozCSSMatrix,h(o,v),o.prototype.ignoreEvent=function(){return!1},o.prototype.setStyleProperties=function(n){p.supportsPreserve3D&&!g.forceIERenderPath&&(n.style.webkitTransformStyle="preserve-3d",n.style.mozTransformStyle="preserve-3d"),n.style.position="absolute"},o.prototype.clearStyleProperties=function(n){n.style.webkitTransformStyle="",n.style.msTransformStyle="",n.style.mozTransformStyle="",n.style.position=""},o.prototype.setViewportSize=function(n,t){this._width=n,this._height=t,this._rootElement.width=this._width,this._rootElement.height=this._height,this._flatten3D.style.width=this._width,this._flatten3D.style.height=this._height,this._3dViewportDiv.width=this._width,this._3dViewportDiv.height=this._height,o.prototype.viewportToScreenTransform=i.createViewportToScreen(this._width,this._height)},o.prototype.invertYAxisMatrix=t.createScale(1,-1,1),o.prototype.viewportToScreenTransform=t.createIdentity(),o.prototype.styleNotImportatnt="none !important;",o.prototype.transformOrigin="0px 0px 0",o.prototype.transformStyle="preserve-3d",si=function(n,t){n.style.webkitTransform=t,n.style.msTransform=t,n.style.mozTransform=t},o.prototype.updateTransforms=function(n,t){var u,r,i,f=[];if(i=new ti,i.m11=1,i.m12=0,i.m13=0,i.m14=0,i.m21=0,i.m22=1,i.m23=0,i.m24=0,i.m31=0,i.m32=0,i.m33=1,i.m34=0,i.m41=0,i.m42=0,i.m43=0,i.m44=1,n||(n=this._rootElement),t||(t=i),n.$$matrixTransform&&(t=t.multiply(n.$$matrixTransform)),n.childNodes.length===0||n.$$isLeaf)si(n,t);else for(si(n,i),r=0;r<n.childNodes.length;++r)this.updateTransforms(n.childNodes[r],t)},o.prototype.render=function(n){var nt=this.viewportToScreenTransform.multiply(this._viewProjMatrix.multiply(this.invertYAxisMatrix)),w,tt,d,r,a,b,u,v,c,y,l,f,s,k,h;for(this.setCSS3DViewProjection(nt),b=this._viewModel.getRenderables(n).getArray(),d=b.length,w=0;w<d;w++)if((u=b[w],v=u.id,r=null,a=u.texturesWithPolygons[0].texture,a._isReady&&(r=a._image),r)&&(v.levelOfDetail!=u.worldLod?(c=r.style,y=this.styleNotImportatnt,c.webkitTransition=y,c.mozTransition=y,c.msTransition=y,c.oTransition=y,c.opacity=1):r.style.opacity===""?this.setCSS3DOpacity(r,0,e.DefaultDurationS):r.style.opacity==="0"&&(l=o.prototype.transitionEndCallback,r.addEventListener("webkitTransitionEnd",l,!1),r.addEventListener("MSTransitionEnd",l,!1),r.addEventListener("mozTransitionEnd",l,!1),r.addEventListener("oTransitionEnd",l,!1),r.animationInProgress=!0,r.style.opacity="1",setTimeout(function(){r==null||r.animationInProgress||l.apply(r)},e.DefaultDurationMS+50)),!u.transformUpdated)){if(!a._isDirty){this.setCSS3DTransform(r.parentNode,r,u.transform,u.worldLod),u.transformUpdated=!0;continue}r._order=v.levelOfDetail,r.style.zIndex=v.levelOfDetail,r.parentNode&&this._error("Expected imageElement with no parent"),this.setStyleProperties(r),f=document.createElement("div"),s=f.style,f.id=v.id,s.position="absolute",s.zIndex=r.style.zIndex,p.supportsPreserve3D&&!g.forceIERenderPath?(s.webkitTransformOrigin=this.transformOrigin,s.webkitTransformStyle=this.transformStyle,s.mozTransformOrigin=this.transformOrigin,s.mozTransformStyle=this.transformStyle):f.$$isLeaf=!0,f.appendChild(r),this.setCSS3DTransform(f,r,u.transform,u.worldLod),this._3dViewportDiv.appendChild(f),a._isDirty=!1}if((!p.supportsPreserve3D||g.forceIERenderPath)&&this.updateTransforms(null,null),k=!1,this._frameCallbacks){for(h=0;h<this._frameCallbacks.length;h++)this._frameCallbacks[h].count>0?k=!0:this._frameCallbacks[h].count==0&&this._frameCallbacks[h].cb(),this._frameCallbacks[h].count--;k||(this._frameCallbacks=[])}},o.prototype.transitionEndCallback=function(){this.animationInProgress=!1,this.removeEventListener("webkitTransitionEnd",o.prototype.transitionEndCallback,!1),this.removeEventListener("mozTransitionEnd",o.prototype.transitionEndCallback,!1),this.removeEventListener("MSTransitionEnd",o.prototype.transitionEndCallback,!1),this.removeEventListener("oTransitionEnd",o.prototype.transitionEndCallback,!1)},o.prototype.animate=function(n,t,i,u,f,e,s){function k(){r.css(h._texture._image,w)}function d(n,t){this.cb=n,this.count=t}var a,y,b;if(n&&n._material&&n._material._texture&&n._material._texture._image){var h=n._material,p={},w={};for(a=0;a<2;a++){var l=a==0?t:i,v=a==0?p:w,c="";for(y in l)if(l.hasOwnProperty(y))switch(y){case"opacity":v.opacity=l.opacity;break;case"x":c+="translateX(-"+l.x+"px) ";break;case"y":c+="translateY("+l.y+"px) ";break;case"sx":c+="scaleX("+l.sx+") ";break;case"sy":c+="scaleY("+l.sy+") ";break;case"rotate":c+="rotate(-"+l.rotate+"deg) "}c!=""&&(v["-webkit-transform"]=c,v["-ms-transform"]=c,v["-moz-transform"]=c)}t&&(r.css(h._texture._image,{"-webkit-transition-duration":u+"ms","-webkit-transition-timing-function":f,"-ms-transition-duration":u+"ms","-ms-transition-timing-function":f,"-moz-transition-duration":u+"ms","-moz-transition-timing-function":f}),r.css(h._texture._image,p)),h._texture._image.material=h,h._texture._image.callbackInfo=s,h._texture._image.completeCallback=e,h._texture._image.addEventListener("webkitTransitionEnd",o.prototype.transitionEndCallback,!1),h._texture._image.addEventListener("MSTransitionEnd",o.prototype.transitionEndCallback,!1),h._texture._image.addEventListener("mozTransitionEnd",o.prototype.transitionEndCallback,!1),b=this,this._frameCallbacks==undefined&&(this._frameCallbacks=[]),this._frameCallbacks.push(new d(k,1)),h._animation={_ended:!1}}},o.prototype.preTransform=t.createIdentity(),o.prototype.elementTransform=t.createIdentity(),o.prototype.setCSS3DTransform=function(n,i,r){var o=Math.max(i.height||0,i.naturalHeight||0),e,f;this.invertYAxisMatrix.multiplyOut(t.createTranslation(0,-o,0),this.preTransform),r.multiplyOut(this.preTransform,this.elementTransform),e=this.invertYAxisMatrix.multiply(this.elementTransform),e=e.transpose(),f=new ti,f.m11=e.m11,f.m12=e.m12,f.m13=e.m13,f.m14=e.m14,f.m21=e.m21,f.m22=e.m22,f.m23=e.m23,f.m24=e.m24,f.m31=e.m31,f.m32=e.m32,f.m33=e.m33,f.m34=e.m34,f.m41=e.m41,f.m42=e.m42,f.m43=e.m43,f.m44=e.m44,p.supportsPreserve3D&&!g.forceIERenderPath?(n.style.webkitTransform=f,n.style.mozTransform=f,n.style.msTransform=f):n.$$matrixTransform=f},o.prototype.setCSS3DViewProjection=function(n){var i=n.transpose(),t=new ti;t.m11=i.m11,t.m12=i.m12,t.m13=i.m13,t.m14=i.m14,t.m21=i.m21,t.m22=i.m22,t.m23=i.m23,t.m24=i.m24,t.m31=i.m31,t.m32=i.m32,t.m33=i.m33,t.m34=i.m34,t.m41=i.m41,t.m42=i.m42,t.m43=i.m43,t.m44=i.m44,p.supportsPreserve3D&&!g.forceIERenderPath?(this._3dViewportDiv.style.webkitTransform=t,this._3dViewportDiv.style.mozTransform=t,this._3dViewportDiv.style.msTransform=t):this._3dViewportDiv.$$matrixTransform=t},o.prototype.setCSS3DOpacity=function(n,t,i){n.style.webkitTransition="opacity "+i+"s linear",n.style.mozTransition="opacity "+i+"s linear",n.style.msTransition="opacity "+i+"s linear",n.style.oTransition="opacity "+i+"s linear",n.style.opacity=t},o.prototype.setClearColor=function(n){this._checkClearColor(n),this._clearColor=n,this._flatten3D.style.backgroundColor="rgba("+this._clearColor.r*255+","+this._clearColor.g*255+","+this._clearColor.b*255+","+this._clearColor.a+")"},o.prototype.initLayer=function(){},o.prototype.finalizeLayer=function(){},o.prototype.getType=function(){return"3D"},o.prototype.syncRemovedRenderables=function(n){for(var e=this._viewModel.getDelta(n).removed,h=this._viewModel.getRenderables(n).map,f,s,t,i,u=0,o=e.length;u<o;u++)(f=e[u].viewElementId.id,s=h[f],s)&&(i=document.getElementById(f),i?(t=i.firstChild,t?(this.clearStyleProperties(t),t.parentNode&&t.parentNode.removeChild(t)):this._error("Expected imgElement"),i.parentNode&&i.parentNode.removeChild(i)):r.log("Cannot find and remove element"))},h(nt,v),nt.prototype.init=function(){var o="\t\t\t\t uniform mat4 u_modelViewProjMat; \t\t\t\t uniform mat4 u_localMat; \t\t\t\t \t\t\t\t /* the following can be optimized into one vec4 */ \t\t\t\t uniform vec2 u_opacityBE, u_xBE, u_yBE, u_rotateBE; \t\t\t\t uniform vec2 u_sxBE, u_syBE; \t\t\t\t uniform float u_texW, u_texH; \t\t\t\t attribute vec4 a_pos; \t\t\t\t attribute vec4 a_texCoord; \t\t\t\t varying vec2 v_texCoord; \t\t\t\t varying float v_opacity; \t\t\t\t \t\t\t\t void main() \t\t\t\t { \t\t\t\t \tfloat opacity, x, y, rotate; \t\t\t\t\tmat4 finalMat; \t\t\t\t\tfloat a; \t\t\t\t\t \t\t\t\t\tfinalMat = u_modelViewProjMat; \t\t\t\t\topacity = u_opacityBE[0]; \t\t\t\t\t \t\t\t\t\tvec4 pos = finalMat * a_pos; \t\t\t\t\tv_texCoord = a_texCoord.xy; \t\t\t\t\tv_opacity = opacity; \t\t\t\t\tgl_Position = pos; \t\t\t\t }",s="precision mediump float; \n#define KERNEL_SIZE 9 \nuniform sampler2D u_diffuseTex; \nuniform vec4 u_colorMult; \nuniform vec2 u_kernelOffsets[9]; \nuniform float u_kernel[9]; \nvarying float v_opacity; \nvarying vec2 v_texCoord; \nvoid main() { \n\tvec2 texCoord = vec2(v_texCoord.x, 1.0 - v_texCoord.y); \n\t/*vec4 color = texture2D(u_diffuseTex, texCoord); */\n\tvec4 color = vec4(0); \n\tfor(int i=0; i<9; i++ ) { \n\t\tvec4 tmp = texture2D(u_diffuseTex, texCoord.st + u_kernelOffsets[i]); \n\t\tcolor += tmp * u_kernel[i]; \n\t} \n\tgl_FragColor = color * vec4(1,1,1,v_opacity); \n}",n=this._gl,f,t,r,e,i,u;if(this._vs=bi(n,n.VERTEX_SHADER,o),this._ps=bi(n,n.FRAGMENT_SHADER,s),this._vs==null||this._ps==null)throw"Failure initializing webgl: shader";if(this._shaderProgram=n.createProgram(),n.attachShader(this._shaderProgram,this._vs),n.attachShader(this._shaderProgram,this._ps),n.linkProgram(this._shaderProgram),!n.getProgramParameter(this._shaderProgram,n.LINK_STATUS)){n.deleteProgram(this._shaderProgram),n.deleteShader(this._vs),n.deleteShader(this._ps);return}for(f=n.getProgramParameter(this._shaderProgram,n.ACTIVE_ATTRIBUTES),this._attribs=new Array(f),this._attribLocations={},t=0;t<f;t++)r=n.getActiveAttrib(this._shaderProgram,t),this._attribs[t]=r,this._attribLocations[r.name]=n.getAttribLocation(this._shaderProgram,r.name);for(e=n.getProgramParameter(this._shaderProgram,n.ACTIVE_UNIFORMS),this._uniforms=new Array(e),this._uniformLocations={},i=0;i<e;i++)u=n.getActiveUniform(this._shaderProgram,i),this._uniforms[i]=u,this._uniformLocations[u.name]=n.getUniformLocation(this._shaderProgram,u.name)},nt.prototype.setViewportSize=function(n,t){this._width=n,this._height=t,this._rootElement.width=this._width,this._rootElement.height=this._height,this._gl.viewportWidth=this._width,this._gl.viewportHeight=this._height,this._gl.viewport(0,0,this._gl.viewportWidth,this._gl.viewportHeight)},nt.prototype.render=function(t){var e,o,u=this._gl,k,p,l,w,d,f,v,y,b,s,g,nt,tt;for(u.clear(u.COLOR_BUFFER_BIT|u.DEPTH_BUFFER_BIT),u.useProgram(this._shaderProgram),k=new Float32Array(a.FilterType.NO_FILTER),p=this._viewModel.getRenderables(t).getArray(),p.sort(this.SortRenderableFucntion),l=0;l<2;l++)for(l==1?(u.enable(u.BLEND),u.blendFunc(u.SRC_ALPHA,u.ONE_MINUS_SRC_ALPHA)):u.disable(u.BLEND),w=0,d=p.length;w<d;w++)if((f=p[w],e=null,o=f.texturesWithPolygons[0].texture,o._isReady&&(e=o._image),e!=null&&f.geometryPloygon!=null)&&(f.geometryPloygon._vertices||a.InitRenderableFor3D(f),this.InitViewElementOpacity(f),l!=0||!(e.opacity<1))){if(f.geometryPloygon._isDirty&&(f.geometryPloygon.__gl_posBuffer&&u.deleteBuffer(f.geometryPloygon.__gl_posBuffer),f.geometryPloygon.__gl_posBuffer=u.createBuffer(),u.bindBuffer(u.ARRAY_BUFFER,f.geometryPloygon.__gl_posBuffer),u.bufferData(u.ARRAY_BUFFER,new Float32Array(f.geometryPloygon._vertices),u.STATIC_DRAW),f.geometryPloygon.__gl_texCoordBuffer&&u.deleteBuffer(f.geometryPloygon.__gl_texCoordBuffer),f.geometryPloygon.__gl_texCoordBuffer=u.createBuffer(),u.bindBuffer(u.ARRAY_BUFFER,f.geometryPloygon.__gl_texCoordBuffer),u.bufferData(u.ARRAY_BUFFER,new Float32Array(f.geometryPloygon._texCoords),u.STATIC_DRAW),f.geometryPloygon._indices&&(f.geometryPloygon.__gl_indexBuffer&&u.deleteBuffer(f.geometryPloygon.__gl_indexBuffer),f.geometryPloygon.__gl_indexBuffer=u.createBuffer(),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,f.geometryPloygon.__gl_indexBuffer),u.bufferData(u.ELEMENT_ARRAY_BUFFER,new Uint16Array(f.geometryPloygon._indices),u.STATIC_DRAW)),f.geometryPloygon._isDirty=!1),v=e.width,y=e.height,o._isDirty){o.__gl_texture&&u.deleteTexture(o.__gl_texture),o.__gl_texture=u.createTexture(),u.bindTexture(u.TEXTURE_2D,o.__gl_texture),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.LINEAR_MIPMAP_LINEAR),b=u.CLAMP_TO_EDGE,u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,b),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,b);try{n.isPowerOfTwo(v)&&n.isPowerOfTwo(y)?u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,e):(s=document.createElement("canvas"),s.width=n.nextHighestPowerOfTwo(v),s.height=n.nextHighestPowerOfTwo(y),g=s.getContext("2d"),g.drawImage(e,0,0,v,y,0,0,s.width,s.height),e=s,u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,s))}catch(ut){continue}u.generateMipmap(u.TEXTURE_2D),o._isDirty=!1}nt=this._viewProjMatrix.multiply(f.transform),tt=new Float32Array(nt.flattenColumnMajor()),u.uniformMatrix4fv(this._uniformLocations.u_modelViewProjMat,!1,tt);var h=1/v,c=1/y,it=[-h,-c,0,-c,h,-c,-h,0,0,0,h,0,-h,c,0,c,h,c],rt=new Float32Array(it);u.uniform2fv(this._uniformLocations["u_kernelOffsets[0]"],rt),u.uniform1fv(this._uniformLocations["u_kernel[0]"],k),u.uniform2f(this._uniformLocations.u_opacityBE,e.opacity,e.opacity),u.uniform1f(this._uniformLocations.u_t,-1),u.enableVertexAttribArray(this._attribLocations.a_pos),u.enableVertexAttribArray(this._attribLocations.a_texCoord),u.bindBuffer(u.ARRAY_BUFFER,f.geometryPloygon.__gl_posBuffer),u.vertexAttribPointer(this._attribLocations.a_pos,3,u.FLOAT,!1,0,0),u.bindBuffer(u.ARRAY_BUFFER,f.geometryPloygon.__gl_texCoordBuffer),u.vertexAttribPointer(this._attribLocations.a_texCoord,f.geometryPloygon._texCoordSize,u.FLOAT,!1,0,0),f.geometryPloygon._indices&&u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,f.geometryPloygon.__gl_indexBuffer),u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,o.__gl_texture),u.uniform1i(this._uniformLocations.u_diffuseTex,0),u.drawElements(u.TRIANGLES,f.geometryPloygon._indices.length,u.UNSIGNED_SHORT,0),this.UpdateViewElementOpacity(f,.07)}},nt.prototype.animate=function(){},nt.prototype.setClearColor=function(n){this._checkClearColor(n),this._clearColor=n,this._gl.clearColor(this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a)},nt.prototype.initLayer=function(){},nt.prototype.finalizeLayer=function(){},nt.prototype.getType=function(){return"3D"},nt.prototype.syncRemovedRenderables=function(n){for(var i=this._gl,f=this._viewModel.getDelta(n).removed,o=this._viewModel.getRenderables(n).map,u,e,t,r=0;r<f.length;r++)(e=f[r].viewElementId.id,t=o[e],t)&&(t.geometryPloygon.__gl_posBuffer&&i.deleteBuffer(t.geometryPloygon.__gl_posBuffer),t.geometryPloygon.__gl_indexBuffer&&i.deleteBuffer(t.geometryPloygon.__gl_indexBuffer),u=t.texturesWithPolygons[0].texture,u.__gl_texture&&i.deleteTexture(u.__gl_texture),t.geometryPloygon.__gl_texCoordBuffer&&i.deleteBuffer(t.geometryPloygon.__gl_texCoordBuffer))},h(w,v),w.STD_PIXEL_EXPANSION=window.chrome?.01:.5,w.prototype.setViewportSize=function(n,t){var r,i;this._width=n,this._height=t;for(r in this._layers)i=this._layers[r],i.width=n,i.height=t},w.prototype._initNewCanvas=function(n,t){var i=document.createElement("canvas"),u;return this._layers[n]=i,i.width=this._width,i.height=this._height,r.css(i,{position:"absolute",left:0,top:0,opacity:1,zIndex:t}),u=i.getContext("2d"),i.ctx=u,this._window.appendChild(i),u},w.prototype.render=function(n){function lt(n,t,i,u,f,e,o,s,h,c,l,a,v,y,p,b){var d=bt,g=d(u,f,e,o,s,h),nt=d(e,o,u,f,s,h),tt=d(s,h,e,o,u,f),k;if(u=g.x,f=g.y,e=nt.x,o=nt.y,s=tt.x,h=tt.y,n.save(),i<1?(n.globalAlpha=i,self._expansionInPixels=.25):self._expansionInPixels=w.STD_PIXEL_EXPANSION,n.beginPath(),n.moveTo(u,f),n.lineTo(e,o),n.lineTo(s,h),n.closePath(),b&&(r.strokeStyle="blue",r.stroke()),n.clip(),k=c*(p-v)-a*p+y*v+(a-y)*l,k==0)return n.restore(),!1;var it=-(l*(s-e)-v*s+p*e+(v-p)*u)/k,rt=(v*h+l*(o-h)-p*o+(p-v)*f)/k,ut=(c*(s-e)-a*s+y*e+(a-y)*u)/k,ft=-(a*h+c*(o-h)-y*o+(y-a)*f)/k,et=(c*(p*e-v*s)+l*(a*s-y*e)+(y*v-a*p)*u)/k,ot=(c*(p*o-v*h)+l*(a*h-y*o)+(y*v-a*p)*f)/k;return n.transform(it,rt,ut,ft,et,ot),!0&&n.drawImage(t,0,0),n.restore(),!0}function bt(n,t,i,r,u,f){var h=i-n,c=r-t,l=u-n,a=f-t,e=Math.sqrt(h*h+c*c),o,s,v,y,w,p;return e!=0&&(h/=e,c/=e),e=Math.sqrt(l*l+a*a),e!=0&&(l/=e,a/=e),o=h+l,s=c+a,e=Math.sqrt(o*o+s*s),e!=0&&(o/=e,s/=e),v=h-l,y=c-a,e=Math.sqrt(v*v+y*y),w=e/2,p=Math.min(2,self._expansionInPixels/w),o*=p,s*=p,{x:n-o,y:t-s}}var h,ft,et=this._viewModel.getRenderables(n).getArray(),ot,st,ht,r,y,g,at,ct,tt,vt,it,ut,k,yt;for(et.sort(this.SortRenderableFucntion),this.renderImageryB=!0,d.debugEnabled&&(ot=document.getElementById("tiles"),ot&&(this.showSquareB=ot.checked),st=document.getElementById("triangles"),st&&(this.showTrianglesB=st.checked),ht=document.getElementById("images"),ht&&(this.renderImageryB=ht.checked)),r=this._layers[n].ctx,r.clearRect(0,0,this._width,this._height),y=0,g=0,at=et.length;g<at;g++){var p=et[g],nt=p.geometryPloygon,pt=p.texturesWithPolygons[0];if(ft=pt.texture,h=ft._isReady?ft._image:null,h!=null&&nt!=null){for(this.InitViewElementOpacity(p),ct=nt.intileTesselated,tt=0,vt=ct.length;this.renderImageryB&&tt<vt;tt++)if(it=ct[tt],it){var u=it.screenArray,c=it.textureArray,l=u[0],v=c[0],f,e,o,s;if(u.length==4)f=u[1],e=c[1],o=u[2],s=c[2],lt(r,h,h.opacity,l.x,l.y,f.x,f.y,o.x,o.y,v.x,v.y,e.x,e.y,s.x,s.y,this.showTrianglesB),f=u[2],e=c[2],o=u[3],s=c[3],lt(r,h,h.opacity,l.x,l.y,f.x,f.y,o.x,o.y,v.x,v.y,e.x,e.y,s.x,s.y,this.showTrianglesB),y+=2;else for(var rt=1,b=1,wt=u.length-1;b<wt;rt=b)b=rt+1,f=u[rt],e=c[rt],o=u[b],s=c[b],lt(r,h,h.opacity,l.x,l.y,f.x,f.y,o.x,o.y,v.x,v.y,e.x,e.y,s.x,s.y,this.showTrianglesB),y++}if(this.UpdateViewElementOpacity(p,.15),d.debugEnabled){if(!this.renderImageryB&&this.showTrianglesB)for(r.strokeStyle="teal",ut=nt.intileTesselated,k=0;k<ut.length;k++)ut[k]&&a.DrawPolyLine(r,ut[k].screenArray,null);this.showSquareB&&(yt=!1,r.strokeStyle=p.isClipped?"red":"cyan",a.DrawPolyLine(r,nt.screenArray,yt),r.strokeStyle="black")}}}d.debugEnabled&&(r.font="14px Tahoma",r.strokeStyle=y>1e3?"red":"blue",r.strokeText("Rendered triangles: "+y,this._width-300,this._height-50))},w.prototype.setClearColor=function(n){var t=this._layers[this._layerIdBackground].ctx;n&&(t.fillStyle="rgba("+this._clearColor.r*255+","+this._clearColor.g*255+","+this._clearColor.b*255+","+this._clearColor.a+")",this._clearColor=n),t.fillRect(0,0,this._width,this._height)},w.prototype.initLayer=function(n,t){this._initNewCanvas(n,t)},w.prototype.finalizeLayer=function(n){this._layers[n].style.display="none"},w.prototype.getType=function(){return"2D"},w.prototype.syncRemovedRenderables=function(){},ii.prototype.Tesselate=function(){throw"interface function called instead of implementation";},ii.prototype.GetRawDensity=function(){throw"interface function called instead of implementation";},h(y,ii),y._isSpheric=!0,y.ScreenQuadSize=64,y.ScreenQuadSizeThreshold=y.ScreenQuadSize*y.ScreenQuadSize,y.setScreenQuadSize=function(n){var i,t;if(y.ScreenQuadSize=n,y.ScreenQuadSizeThreshold=n*n,d.debugEnabled)for(i=document.getElementsByName("tess"),t=0;t<i.length;t++)if(i[t].value==n){i[t].checked=!0;break}},y.prototype.Tesselate=function(n,t,r){var f,u;return t===0?{squares:[n.geometryPolygon],texelSquares:[n.texturePolygon],density:0}:(t=t||-1,t<0?(u=this.GetRawDensity(n,r),u=u>t?u:t):u=t,u=u>=1?u:1,f={squares:[],texelSquares:[],density:u},i.splitSquareRecursive(n.geometryPolygon,n.texturePolygon,u,null,f,y._isSpheric,n.texturePolygon,null,null,null,null),f.density=u,!f.density,f)},y.prototype.GetRawDensity=function(t,r){var e=r.getViewport(),a=e.getWidth(),v=e.getHeight(),b=v<=a,o=t.geometryPolygon[0].y,s=t.geometryPolygon[1].y,h=r.getVerticalFov(),p=v,c,f,u;if(b||(h=et.convertVerticalToHorizontalFieldOfView(e.getAspectRatio(),h),o=t.geometryPolygon[1].x,s=t.geometryPolygon[2].x,p=a),c=y.ScreenQuadSize,d.debugEnabled)for(f=document.getElementsByName("tess"),u=0;u<f.length;u++)if(f[u].checked==!0){c=f[u].value;break}var k=Math.sqrt((o-s)*(o-s)),g=i.calculateTexelToPixelRatioAtFov(i._cubeSide,c,p,h),w=k/g,l=Math.floor(n.logBase(w,2)),nt=Math.pow(2,l);return nt>w?l-1:l},h(c,ii),c._isSpheric=!0,c.ScreenQuadSize=64,c.setScreenQuadSize=function(n){var i,t;if(c.ScreenQuadSize=n,c.ScreenQuadSizeThreshold=n*n,d.debugEnabled)for(i=document.getElementsByName("tess"),t=0;t<i.length;t++)if(i[t].value==n){i[t].checked=!0;break}},c.prototype.Tesselate=function(n,t,r){function g(n,t,r,u,f,e){if(f!=0){var o=i.splitFunction(c._isSpheric,n,t,r,u),s=e.length;e[s]=o,g(n,o.xy,r,o.uv,f-1,e),g(o.xy,t,o.uv,u,f-1,e)}}function bt(n,t){return n.xy<t.xy?-1:n.xy>t.xy?1:0}var o,h,nt,tt,s,v,yt,y,pt,wt;if(t===0)return{squares:[n.geometryPolygon],texelSquares:[n.texturePolygon],density:0};t=t||-1,t<0?(nt=r.getViewport(),tt=r.getVerticalFov(),c.prototype._updateTesselatorQuadSize(),o=c.prototype._getNumberOfSplits(n.geometryPolygon[1].x,n.geometryPolygon[2].x,et.convertVerticalToHorizontalFieldOfView(nt.getAspectRatio(),tt),c.ScreenQuadSize,nt.getWidth()),h=this.GetRawDensity(n,r)):o=h=t,o<1&&(o=1),h<1&&(h=1);var l=n.geometryPolygon,p=n.texturePolygon,f=l[0].z,e=l[0].w,it=l[1].x,rt=l[2].x,ut=p[1].x,ft=p[2].x,ot=l[0].y,st=p[0].y,ht=l[1].y,ct=p[1].y,a=[{xy:it,uv:ut},{xy:rt,uv:ft}];g(it,rt,ut,ft,o,a),a.sort(bt),s=[{xy:ot,uv:st},{xy:ht,uv:ct}],g(ot,ht,st,ct,h,s),s.sort(bt);var lt=(a.length-1)*(s.length-1),kt=0,dt=0,at=[lt],vt=[lt];for(v=0,yt=a.length-1;v<yt;v++)for(y=0,pt=s.length-1;y<pt;y++){var w=a[v],b=s[y+1],k=a[v+1],d=s[y];at[kt++]=[new u(w.xy,b.xy,f,e),new u(w.xy,d.xy,f,e),new u(k.xy,d.xy,f,e),new u(k.xy,b.xy,f,e)],vt[dt++]=[new u(w.uv,b.uv,f,e),new u(w.uv,d.uv,f,e),new u(k.uv,d.uv,f,e),new u(k.uv,b.uv,f,e)]}return wt=o==h?o:-1,{squares:at,texelSquares:vt,density:wt}},c.prototype.GetRawDensity=function(n,t){var r=t.getViewport(),u=t.getVerticalFov(),i;return c.prototype._updateTesselatorQuadSize(),i=c.prototype._getNumberOfSplits(n.geometryPolygon[0].y,n.geometryPolygon[1].y,u,c.ScreenQuadSize,r.getHeight())},c.prototype._updateTesselatorQuadSize=function(){var t,n;if(d.debugEnabled)for(t=document.getElementsByName("tess"),n=0;n<t.length;n++)t[n].checked==!0&&(c.ScreenQuadSize=t[n].value)},c.prototype._getNumberOfSplits=function(t,r,u,f,e){var o=Math.sqrt((r-t)*(r-t)),s=i.calculateTexelToPixelRatioAtFov(i._cubeSide,f,e,u);return Math.floor(n.logBase(o/s,2))},b.TRANSITION_TYPE={IN:1,OUT:2},b.DataSourceRegistryItem=function(n,t,i,r){this.id=n.getDataSourceName(),this.dataSource=n,this.animationType=t,this.callback=i,this.transitionType=r},b.DataSourceRegistryItem.prototype.id=null,b.DataSourceRegistryItem.prototype.dataSource=null,b.DataSourceRegistryItem.prototype.animationType=null,b.DataSourceRegistryItem.prototype.callback=function(){},b.DataSourceRegistryItem.prototype.transitionType=null,b.DataSourceRegistryItem.prototype.notifyCallback=function(){this.callback&&this.callback(this.dataSource)},ct.lowerVisibleBoundary=new u(-1,-1,-1,null),ct.higherVisibleBoundary=new u(1,1,1,null),e.ActiveAnimations=new rt,e.number=0,e.DefaultDurationMs=1500,e.DefaultDurationS=e.DefaultDurationMs/1e3,e.prototype._duration=e.DefaultDurationMs,e.prototype._start=0,e.prototype._timeStamp=0,e.prototype.wasApplied=!1,e.prototype.guid=0,e.prototype.step=function(){this._timeStamp=+new Date},e.prototype.apply=function(){this.wasApplied||(this.guid=e.number++,e.ActiveAnimations.add(this.guid,this)),this.wasApplied=!0},e.prototype.finalize=function(){e.ActiveAnimations.remove(this.giud)},e.prototype.isComplete=function(){return this._start!=0&&this._timeStamp>this._start+this._duration},e.TYPE={FadeIn:1,FadeOut:2},e.createAnimation=function(n,t){switch(n){case e.TYPE.FadeIn:return new pt(t);case e.TYPE.FadeOut:return new wt(t);default:throw"unknown animation type: "+n;}},e._getOpacityObject=function(n){if(n instanceof Image)return n;if(n instanceof di)return n.texturesWithPolygons[0].texture._image;throw"could not find Image object in "+n;},h(pt,e),pt.prototype.apply=function(n){e.prototype.apply.call(this);var i=e._getOpacityObject(n),t=.1+(this._timeStamp-this._start)/this._duration;i.opacity=t>1?1:t},pt.prototype.finalize=function(n){e.prototype.finalize.call(this,n);var t=e._getOpacityObject(n);t.opacity=1},h(wt,e),wt.prototype.apply=function(n){var i=e._getOpacityObject(n),t=(this._timeStamp-this._start)/this._duration;t>1&&(t=1),i.opacity=1-t},wt.prototype.finalize=function(n){e.prototype.finalize.call(this,n);var t=e._getOpacityObject(n);t.opacity=0},et.convertHorizontalToVerticalFieldOfView=function(n,t){var i=.5/Math.tan(t*.5);return 2*Math.atan(.5*1/n/i)},et.convertVerticalToHorizontalFieldOfView=function(n,t){var i=.5*1/n/Math.tan(t*.5);return 2*Math.atan(.5/i)},et.prototype={getWidth:function(){return this._width},getHeight:function(){return this._height},getAspectRatio:function(){return this._aspectRatio},getNearDistance:function(){return this._nearDistance},getFarDistance:function(){return this._farDistance}},bt.prototype={step:function(n){function h(){return i._timeInMillis&&i._timeInMillis!=-1}function c(){return h()&&n!=i._startTime&&n-i._startTime>i._timeInMillis}function l(){return r<u&&r>-u&&t<u&&t>-u}var i,t,r,f,e,o,u,s;return this._isSettled?!0:(this._startTime==-1&&(this._startTime=n),i=this,t=0,this._t>=0&&(e=n-this._t,e>0&&(r=this._current-this._target,this._velocity+=-this._springConstant*r-this._damperConstant*this._velocity,t=this._velocity*e,(!this._allowOvershoot||e>100)&&(o=-r,Math.abs(o)<Math.abs(t)&&(t=o,this._velocity=0)),h()?(s=(n-this._startTime+1)/this._timeInMillis,this._current=this._initialValue+(this._target-this._initialValue)*s):this._current+=t)),r=this._current-this._target,u=1e-7,f=c()||l(),f?this.setCurrentToTarget():this._t=n,this._isSettled=f,f)},isSettled:function(){return this._isSettled},setTarget:function(n,t){this.target!=n&&(this._target=n,this._timeInMillis=t,t&&(this._startTime=-1,this._initialValue=this._current),this._isSettled=!1)},setCurrent:function(n){this._current=n,this._isSettled=!1},setCurrentAndTarget:function(n){this._target=n,this.setCurrentToTarget()},setCurrentToTarget:function(){this._current=this._target,this._velocity=0,this._isSettled=!0,this._t=-1,this._initialValue=-1,this._timeInMillis=-1},getTarget:function(){return this._target},getCurrent:function(){return this._current}},gi.prototype={step:function(n){var i,t,r;if(this._internalSpring._isSettled)return!0;for(i=this._internalSpring.step(n),t=0,r=this._current.length;t<r;t++)if(i)this._current[t]=this._target[t];else{var f=this._target[t],u=this._initial[t],e=(f-u)*this._internalSpring.getCurrent();this._current[t]=u+e}return i},isSettled:function(){return this._internalSpring._isSettled},setTarget:function(n){var i=!0,r=n.length,t;if(r==this._target.length)for(t=0;t<r;t++)this._target[t]!=n[t]&&(i=!1);else i=!1;i||(this._internalSpring.setTarget(this._internalSpringTargetValue,null),this._target=n,this._internalSpring._isSettled=!1)},setCurrent:function(n){this._internalSpring.setCurrent(this._internalSpringCurrentValue),this._current=n,this._initial=[];for(var t=0;t<n.length;t++)this._initial.push(n[t]);this._internalSpring._isSettled=!1},setCurrentAndTarget:function(n){this._internalSpring.setCurrentAndTarget(this._internalSpringTargetValue),this._target=n,this.setCurrentToTarget()},setCurrentToTarget:function(){for(var n=0,t=this._current.length;n<t;n++)this._current[n]=this._target[n]},getTarget:function(){return this._target},getCurrent:function(){return this._current}},hi.prototype={calculatePitchAndHeading:function(){var i=this.getPitch(),t=this.getHeading();return t<0&&(t+=n.twoPI),{pitch:i,heading:t}},setViewTarget:function(n,t,i,r,u){this._zoomingToPoint=!1;var f=!1;(n!==null||t!=null)&&(n=n!=0?n||this.getPitch():n,t=t!=0?t||this.getHeading():t,this.setPitchAndHeading(n,t,r,u),f=!0),i!==null&&(this.setVerticalFov(i,r,u),f=!0),f&&this.targetViewChangeCallback&&this.targetViewChangeCallback()},getView:function(){return this._currentView.pitch=this.getPitch(),this._currentView.heading=this.getHeading(),this._currentView.verticalFov=this.getVerticalFov(),this._currentView},getPitch:function(){return this._pitchSpring.getCurrent()},getHeading:function(){return this._headingSpring.getCurrent()},getVerticalFov:function(){return this._fieldOfViewSpring.getCurrent()},getMinVerticalFov:function(){return this._minFieldOfView},getMaxVerticalFov:function(){return this._maxFieldOfView},getBounds:function(){return{left:this._lowerHeadingLimit,right:this._upperHeadingLimit,bottom:this._lowerPitchLimit,top:this._upperPitchLimit,minFov:this._minFieldOfView,maxFov:this._maxFieldOfView}},zoomIn:function(n){this.setViewTarget(null,null,Math.max(this._minFieldOfView,this._camera.getVerticalFov()*this._discreteZoomFactor),n,null)},zoomOut:function(n){this.setViewTarget(null,null,Math.min(this._maxFieldOfView,this._camera.getVerticalFov()/this._discreteZoomFactor),n,null)},setPitchAndHeading:function(t,i,r,u){if(this._zoomingToPoint=!1,t=this.constrainPitch(t),i=this.constrainHeading(i),r){this._pitchSpring.setTarget(t,u);var f=this._headingSpring.getCurrent();f=n.pickStartHeadingToTakeShortestPath(f,i),this._headingSpring.setCurrent(f),this._headingSpring.setTarget(i,u)}else this._pitchSpring.setCurrentAndTarget(t),this._headingSpring.setCurrentAndTarget(i),this.updateCameraProperties()},setVerticalFov:function(t,i,r){this._zoomingToPoint=!1;var u=n.clamp(t,this._minFieldOfView,this._maxFieldOfView);i?this._fieldOfViewSpring.setTarget(u,r):this._fieldOfViewSpring.setCurrentAndTarget(u),this.updateCameraProperties()},tryPitchHeadingToPixel:function(n,t){var r=this.calculateLookFromPitchAndHeading(n,t,this._worldLook,this._worldUp,this._worldSide,null),i;return this._camera.getLook().dot(r)<=0?null:(i=this._camera.projectTo2D(r),new l(i.x,i.y))},tryPixelToPitchHeading:function(t){var u=this._camera.getViewport(),h=this._camera.getFocalLength(),c=u.getWidth()/2,f=u.getHeight()/2,e=h*f,l=t.x-c,a=t.y-f,v=-Math.atan2(a,e),y=Math.atan2(l,e),i=this.calculateLookFromPitchAndHeading(v,y,this._look,this._up,this._side,!0),r=i.dot(this._worldUp),p=i.dot(this._worldSide),w=i.dot(this._worldLook),o=Math.atan2(r,Math.max(0,Math.sqrt(1-r*r))),s=n.normalizeRadian(Math.atan2(p,w));return isNaN(o)||isNaN(s)?null:{pitch:o,heading:s}},calculateLookFromPitchAndHeading:function(n,t,i,r,u,f){return s.fromAxisAngleOut(u,n,this._tempPitchRotationQuaternion),s.fromAxisAngleOut(r,-t,this._tempHeadingRotationQuaternion),f?this._tempPitchRotationQuaternion.multiplyOut(this._tempHeadingRotationQuaternion,this._tempQuaternion):this._tempHeadingRotationQuaternion.multiplyOut(this._tempPitchRotationQuaternion,this._tempQuaternion),this._tempQuaternion.transform(i)},constrainPitch:function(t){return n.clamp(t,this._lowerPitchLimit,this._upperPitchLimit)},constrainHeading:function(t){if(!this._upperHeadingLimit)return t;if(t<0&&(t+=n.twoPI),this._lowerHeadingLimit<this._upperHeadingLimit)return n.clamp(t,this._lowerHeadingLimit,this._upperHeadingLimit);if(t>this._lowerHeadingLimit&&t<this._upperHeadingLimit+n.twoPI||t+n.twoPI>this._lowerHeadingLimit&&t+n.twoPI<this._upperHeadingLimit+n.twoPI)return t;var i=Math.min(Math.abs(t-this._lowerHeadingLimit),Math.abs(t+n.twoPI-this._lowerHeadingLimit)),r=Math.min(Math.abs(t-this._upperHeadingLimit-n.twoPI),Math.abs(t-this._upperHeadingLimit));return i<r?this._lowerHeadingLimit:this._upperHeadingLimit},constrainVerticalFieldOfView:function(t){return n.clamp(t,this._minFieldOfView,this._maxFieldOfView)},onDiscreteZoom:function(t,i){function p(n){var i,r=2;if(t.mouseInteractionType&&t.mouseInteractionType=="mousewheel"||t.type&&t.type=="gestureChange")if(c)if(u<n._maxFieldOfView-n._wheelZoomFudgeFactor)i=n.constrainVerticalFieldOfView(u*r);else return n._maxFieldOfView;else if(u>n._minFieldOfView+n._wheelZoomFudgeFactor)i=n.constrainVerticalFieldOfView(u/r);else return n._minFieldOfView;else i=n.constrainVerticalFieldOfView(u/2);return i}this._zoomingToPoint=!0;var o=this.calculatePitchAndHeading(),s=this.tryPixelToPitchHeading({x:t.clientX,y:t.clientY}),r=o.heading,f=s.heading;r=r-Math.floor(r/n.twoPI)*n.twoPI,Math.abs(r-f)>Math.PI&&(f<r?f+=n.twoPI:r+=n.twoPI);var c=t.direction&&t.direction<0||i>1,u=this._camera.getVerticalFov(),e=p(this),h=this._zoomToPointSpring.getTarget()[2];if((e!=this._minFieldOfView||h!=this._minFieldOfView)&&(e!=this._maxFieldOfView||h!=this._maxFieldOfView)){var l=e*((s.pitch-o.pitch)/u),a=e*((f-r)/u),v=s.pitch-l,y=f-a;this._zoomToPointSpring.setCurrent([o.pitch,r,u]),this._zoomToPointSpring.setTarget([v,y,e])}},onKeyDown:function(n){function i(n){t._scrollAccY=n,t.moveCamera()}function r(n){t._scrollAccX=n,t.moveCamera()}var t=this;n.keyCode=="37"?r(-1):n.keyCode=="38"?i(1):n.keyCode=="39"?r(1):n.keyCode=="40"?i(-1):n.keyCode=="107"||n.keyCode=="187"||n.keyCode=="61"?t.zoomIn(!0):(n.keyCode=="109"||n.keyCode=="189"||n.keyCode=="173")&&t.zoomOut(!0)},onKeyUp:function(n){function i(){t._scrollAccY=0}function r(){t._scrollAccX=0}var t=this;n.keyCode=="37"||n.keyCode=="39"?r():(n.keyCode=="38"||n.keyCode=="40")&&i()},moveCamera:function(){if(!this._motionHandle){var n=this;this._motionHandle=setInterval(function(){n._scrollSpeedX+=n._scrollAccX,n._scrollSpeedY+=n._scrollAccY,n._scrollSpeedX*=n._scrollSpeedDamper,n._scrollSpeedY*=n._scrollSpeedDamper;var t=n.getPitch(),i=n.getHeading();if(t+=n._scrollSpeedY/n._scrollSpeedAdjustmentFactor,i+=n._scrollSpeedX/n._scrollSpeedAdjustmentFactor,n.setPitchAndHeading(t,i,null,null),Math.abs(n._scrollSpeedX)<.1&&Math.abs(n._scrollSpeedY)<.1){n.stopMovingCamera();return}},33)}},stopMovingCamera:function(){this._motionHandle&&(clearInterval(this._motionHandle),this._motionHandle=0)}},h(ci,hi),h(li,hi);var ri=function(n){var i=this,f="$$",e={},u;e.assert=function(){};var o=n,s=3,r=f+"count",t=[{}];t[0][r]=0,i.get=function(n,r){for(var u,f=t.length,e=!0;f--;){if(u=t[f][n],u!==undefined)return r&&!e&&i.insert(n,u),u;e=!1}},i.insert=function(n,f){var e,c,h,l;if(e=t[t.length-1],e[n]===undefined)if(e[r]<o)e[r]++;else if(e={},e[r]=1,t.push(e),t.length>s&&(c=t.shift(),u))for(h in c)h!==r&&c.hasOwnProperty(h)&&(l=c[h],l!==i.get(h,null)&&u(l));e[n]=f},i.useDisposer=function(n){u=n},i.size=function(){for(var i,u=0,n=0;n<t.length;++n)if(t[n])for(i in t[n])t[n].hasOwnProperty(i)&&i!==r&&++u;return u}},kr=function(n,t,i){function ft(){var n,t;this[a]||(n=this[o].url,v(this,n),g.insert(n,!0),t=this[o].token,this[ut]=t,u.AllCompleted.insert(t,this),s.insert(n,this),l++,i(h,l))}function tt(){if(!this[a]){var n=this[o].url;v(this,n),p.useImageDisposer&&(this.src=y),w.insert(n,k.failed),h++,t(h,l)}}function et(){if(!this[a]){var n=this[o].url;v(this,n),p.useImageDisposer&&(this.src=y),w.insert(n,k.timedout),h++,t(h,l)}}function v(n,t){n[a]=!0,n.onload=null,n.onerror=null,n.onabort=null,window.clearTimeout(n[nt]);for(var r=n[o],i=f.length;i--;)f[i]===r&&f.splice(i,1);c--,delete e[t]}var u=this;u.useCORS=n||!1;var y="data:image/gif;base64,R0lGODlhAQABAPAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==",it=5e3,rt=6,f=[],c=0,e={},d=120,s=new ri(d),w=new ri(30),g=new ri(200),l=0,h=0;t=t||function(){},i=i||function(){},p.useImageDisposer&&s.useDisposer(function(n){n&&n.src&&(n.src=y)});var b="$$",o=b+"downloadRequest",nt=b+"timeoutid",a=b+"processed",ut="token";u.hasABlockingDownload=!1,u.blockingDownloadTargetCount=-1,u.blockingDownloadSuccessCount=0,u.blockingDownloadFailureCount=0,u.blockingDownloadProgressCallback=null,u.blockingDownloadFinishCallback=null,u.prefetchedTiles={},u.AllCompleted=new ri(d),u.hasBlockingDownload=function(){if(u.hasABlockingDownload)if(u.blockingDownloadSuccessCount+=u.AllCompleted.Size(),u.update(),u.blockingDownloadProgressCallback(u.blockingDownloadSuccessCount),u.blockingDownloadSuccessCount+u.blockingDownloadFailureCount==u.blockingDownloadTargetCount)u.blockingDownloadFinishCallback(u.blockingDownloadSuccessCount,u.blockingDownloadFailureCount),u.resetDownloadAll();else return!0;return!1},u.getState=function(n){if(s.get(n))return k.ready;if(g.get(n))return k.cacheExpired;var t=w.get(n);return t!==undefined?t:e[n]?k.downloading:k.none},u.downloadImage=function(n,t,i){u.getState(n)===k.ready?u.AllCompleted.insert(i,s.get(n)):f.push({url:n,priority:t,token:i})},u.updatePriority=function(n,t){for(var r=!1,i=0;i<f.length;++i)if(f.url===n){r=!0,f.priority=t;break}if(!r)throw"Expected item to be in queue.";},u.cancel=function(n){var t;e[n]&&v(e[n],n)},u.getCacheSize=function(){return s.size()},u.currentlyDownloading=function(){return c!=0},u.update=function(){var i,n,s;for(f.sort(function(n,t){return t.priority-n.priority}),i=0;i<f.length;i++){var h=f[i],t=h.url,l=u.getState(t);switch(l){case k.none:case k.timedout:case k.cacheExpired:c<rt&&(e[t]||(c++,n=document.createElement("img"),e[t]=n,n[o]=h,n.onload=ft,n.onerror=tt,n.onabort=tt,n[nt]=window.setTimeout(function(){var t=n;return function(){et.call(t)}}(),it),s=!1,u.useCORS&&(s=!r.isDataUrl(t)&&!r.isRelativeUrl(t)&&!r.areSameDomain(t,window.location.toString())),s&&(n.crossOrigin=""),n.src=t))}}},u.resetDownloadAll=function(){u.blockingDownloadTargetCount=0,u.blockingDownloadSuccessCount=0,u.blockingDownloadFailureCount=0,u.hasABlockingDownload=!1,u.customFailFunc=null,u.blockingDownloadProgressCallback=null,u.blockingDownloadFinishCallback=null}},k={none:0,downloading:1,ready:2,failed:3,timedout:4,cacheExpired:5};ai.prototype={animationDurationMS:250,getInitialCameraParams:function(){return this.initialCameraParams},getDataSourceName:function(){return this.dataSourceName},getWorldConfiguration:function(){return this.worldConfiguration},getViewElements:function(n,t){return this.viewElementContainers[0].getGeometry().getViewElements(n,t)},getViewElementById:function(n,t){return this.viewElementContainers[0].getGeometry().getViewElementById(n,t)},getInteractionController:function(){return this.interactionController},getMinimumLod:function(){return this.viewElementContainers[0].getGeometry().getMinimumLod()},getMaximumLod:function(){return this.viewElementContainers[0].getGeometry().getMaximumLod()},tesselate:function(n,t,i){return this.tesselator.Tesselate(n,t,i)},getElementRawTesselationDensity:function(n,t){return this.tesselator.GetRawDensity(n,t)},covertToScreenSpace:function(n,t,i,r){return this.viewElementContainers[0].getGeometry().covertToScreenSpace(n,t,i,r)},getElementTransform:function(n){return this.viewElementContainers[0].getGeometry().getElementTransform(n)},getZOrder:function(){return 1}},g.SivDataSourceExists=!0,h(lt,ai),lt.prototype.createFromJsonUri=function(n,t,i,r,u){n||t(null,new kt("The specified jsonUri cannot be null or empty",null)),window.WinJS?this.createFromFullUrl(n,t,null,!1,u):r?this.createFromFullUrl(n,t,i,r,u):this.createFromFullUrl(this.jsonWrapper.replace("{0}",encodeURIComponent(n)),t,null,r,u)},lt.prototype.createFromFullUrl=function(n,t,i,u,f){var o=this,e,s,h;if(window.WinJS)WinJS.xhr({url:n}).then(function(n){var i=null;try{i=JSON.parse(n.responseText)}catch(r){t(null,new kt("The data returned for the pano is not valid json",r));return}this.createFromJson(i,null),o.worldConfiguration==null?t(null,new kt("The data returned for the pano is valid json but is not valid panorama data",null)):t(o.worldConfiguration)},function(n){t(null,new vi("The url specified for the pano json data did not return a 200 success",n))});else if(f){if(e=new XMLHttpRequest,"withCredentials"in e)e.open("GET",n,!0);else if(window.XDomainRequest)e=new XDomainRequest,e.onprogress=function(){},e.ontimeout=function(){},e.open("GET",n);else{t(null,new Error("The browser does not support CORS"));return}e.onload=function(){try{var n=JSON.parse(e.responseText);o.createFromJson(n,i),t(o.getWorldConfiguration())}catch(r){t(null,new kt("The data returned for the pano is not valid json",r));return}},e.onerror=function(){t(null,new vi("The url specified for the pano json data did not return a 200 success",null))},setTimeout(function(){e.send()},0)}else{for(s="PhotosynthCallback",h=0;window[s+h]!=null;)h++;s=s+h,window[s]=function(n){o.createFromJson(n,i),t(o.getWorldConfiguration()),delete window[s]},u?r.addScriptElement(n):r.addScriptElement(n+o.jsonpWrapperParam.replace("{0}",s))}},lt.prototype.createFromJson=function(t,u){var y,p,w,o,e,a,c,v,rt,d,l,g,s,h,ct,nt,ut;try{if(t._json_synth&&t._json_synth>=1.01){for(v in t.l)if(t.l.hasOwnProperty(v)){c=t.l[v];break}var ft=c.x[0],et=ft.cubemaps[0],b=et.field_of_view_bounds,ot=ft.r[0],tt=ot.j,k=ot.start_relative_rotation,st=0,ht=0;if(y=c.b,p=c.attribution_url,w=c.c,k!=null){var lt=new f(0,0,1),at=i.parseQuaternion(tt[4],tt[5],tt[6]),vt=i.parseQuaternion(k[0],k[1],k[2]),yt=at.multiply(vt),it=yt.transform(lt);st=n.halfPI-Math.acos(it.y),ht=Math.atan2(it.z,it.x)}for(rt=null,c.highlight_map&&c.highlight_map.default_highlight&&(rt=c.highlight_map.default_highlight),this.worldConfiguration={id:"panorama"+v,type:"panorama",source:{attribution:{author:y,attributionUrl:p,licenseUrl:w},dimension:0,tileSize:254,tileOverlap:1,tileBorder:1,minimumLod:8,bounds:{left:n.degreesToRadians(b[0]),right:n.degreesToRadians(b[1]),top:n.degreesToRadians(b[3]),bottom:n.degreesToRadians(b[2])},startingPitch:st,startingHeading:ht,projectorAspectRatio:1,projectorFocalLength:.5,highlights:rt}},d=0;d<this.faceNames.length;d++)o=this.faceNames[d],e=et[o],e!=null&&(this.worldConfiguration.source[o+"Face"]={tileSource:new nu(e.u).getTileUrl,clip:e.clip.vertices},this.worldConfiguration.source.dimension=Math.max(this.worldConfiguration.source.dimension,e.d[0],e.d[1]))}else if(t.cubemap_json_version<2)for(h=1,t.tile_overlap_borders?h=t.tile_overlap_borders+0:t.tile_overlaps_borders&&(h=t.tile_overlaps_borders+0),h=t.tile_overlap_borders===!1?0:1,l=t.face_size,this.worldConfiguration={id:"panorama",type:"panorama",source:{dimension:l,tileSize:t.tile_size||510,tileOverlap:h,tileBorder:h,minimumLod:Math.ceil(Math.log(t.tile_size/Math.LN2)),bounds:{left:0,right:n.twoPI,top:n.halfPI,bottom:-n.halfPI},startingPitch:0,startingHeading:0,projectorAspectRatio:1,projectorFocalLength:.5}},t.field_of_view_bounds&&(this.worldConfiguration.source.bounds={left:n.degreesToRadians(t.field_of_view_bounds[0]),right:n.degreesToRadians(t.field_of_view_bounds[1]),bottom:n.degreesToRadians(t.field_of_view_bounds[2]),top:n.degreesToRadians(t.field_of_view_bounds[3])}),t.initial_look_direction&&(this.worldConfiguration.source.startingPitch=n.degreesToRadians(t.initial_look_direction[0]),this.worldConfiguration.source.startingHeading=n.degreesToRadians(t.initial_look_direction[1])),t.orientation&&(this.worldConfiguration.source.orientation={},this.worldConfiguration.source.orientation.roll=t.orientation[0],this.worldConfiguration.source.orientation.pitch=t.orientation[1],this.worldConfiguration.source.orientation.heading=t.orientation[2]||0),this.worldConfiguration.source.faceSize=l,this.worldConfiguration.source.imageContentType=t.image_content_type||"image/jpeg",this.worldConfiguration.source.imageExtension=t.image_extension||"jpg",this.worldConfiguration.source.hasAtlas=t.has_atlas===!1?!1:!0,g=0;g<this.faceNames.length;g++)o=this.faceNames[g],e=t[o],e!=null&&(e.tile_boundaries?(s=e.tile_boundaries,a=[s.left,s.top,s.left,s.bottom,s.right,s.bottom,s.right,s.top]):a=[0,0,0,l,l,l,l,0],this.worldConfiguration.source[o+"Face"]={tileSource:new ur(u,"formats/cubemap/"+o).getTileUrl,clip:a},this.worldConfiguration.source.maximumLod=Math.ceil(Math.log(this.worldConfiguration.source.faceSize)/Math.LN2),this.worldConfiguration.source.minimumLod=Math.ceil(Math.log(this.worldConfiguration.source.tileSize)/Math.LN2));else if(t.json_pano||t.panorama_json_version)for(h=t.tile_overlap_borders===!1?0:1,y=t.author,t.attribution_uri_format_string&&(p=r.partialDotNetStringFormat(t.attribution_uri_format_string,0,0)),w=null,ct=t.publisher,this.worldConfiguration={id:"panorama"+v,type:"panorama",source:{attribution:{author:y,attributionUrl:p,licenseUrl:w,publisher:ct},dimension:0,tileSize:t.tile_size,tileOverlap:h,tileBorder:h,minimumLod:Math.ceil(Math.log(t.tile_size/Math.LN2)),bounds:{left:0,right:n.twoPI,top:n.halfPI,bottom:-n.halfPI},startingPitch:0,startingHeading:0,projectorAspectRatio:1,projectorFocalLength:.5}},t.field_of_view_bounds&&(this.worldConfiguration.source.bounds={left:n.degreesToRadians(t.field_of_view_bounds[0]),right:n.degreesToRadians(t.field_of_view_bounds[1]),bottom:n.degreesToRadians(t.field_of_view_bounds[2]),top:n.degreesToRadians(t.field_of_view_bounds[3])}),t.initial_look_direction&&(this.worldConfiguration.source.startingPitch=n.degreesToRadians(t.initial_look_direction[0]),this.worldConfiguration.source.startingHeading=n.degreesToRadians(t.initial_look_direction[1])),nt=0;nt<this.faceNames.length;nt++)o=this.faceNames[nt],e=t[o],e!=null&&(a=e.clip&&e.clip.vertices?e.clip.vertices:[0,0,0,e.dimensions[1],e.dimensions[0],e.dimensions[1],e.dimensions[0],0],ut=t.panorama_json_version?new ur(u,o).getTileUrl:new tu(e.tile_image_uri_format_string,e.dimensions[0],e.dimensions[1],t.tile_size,e.finest_lod,e.number_of_lods).getTileUrl,this.worldConfiguration.source[o+"Face"]={tileSource:ut,clip:a},this.worldConfiguration.source.dimension=Math.max(this.worldConfiguration.source.dimension,e.dimensions[0],e.dimensions[1]),this.worldConfiguration.source.minimumLod=Math.ceil(Math.log(this.worldConfiguration.source.tileSize)/Math.LN2));this.viewElementContainers.push(new nr(this.worldConfiguration)),this._minimumLod=this.worldConfiguration.source.minimumLod,this._maximumLod=this.worldConfiguration.source.maximumLod||n.ceilLog2(this.worldConfiguration.source.dimension),this.baseImageWidth=this.baseImageHeight=this.worldConfiguration.source.dimension,this.tileHeight=this.tileWidth=this.worldConfiguration.source.tileSize}catch(pt){window.console&&r.log(pt)}},lt.prototype.createController=function(t,r){var f=null;return t&&(f=i.calculateFovAtTexelToPixelRatio(i._cubeSide,t.dimension,r.getViewport().getHeight(),1.1)),this.interactionController=new ci(r,null,null,null,f),t&&(t.startingPitch!=undefined&&this.interactionController.setPitchAndHeading(t.startingPitch,t.startingHeading,null),this.interactionController.setBounds(t.bounds),this.interactionController.setDimension(t.dimension),this.interactionController.setVerticalFov(n.degreesToRadians(80),null)),this.interactionController},h(ot,ai),ot.prototype.animationDurationMS=0,ot.prototype.createController=function(t,i,r){if(this.interactionController=new li(i,r,n.degreesToRadians(89.9),n.degreesToRadians(-89.9)),t){var u=t,f,e;u.startingPitch!=undefined&&(f=u.startingPitch),u.startingHeading!=undefined&&(e=u.startingHeading),this.interactionController.setViewTarget(f,e,null,!1)}return this.interactionController},ot.prototype.createCameraParameters=function(t,i,r,u){var e=this.createRotationMatrix(t,i,r);return{verticalFov:u||n.degreesToRadians(80),position:new f(0,0,0),look:e.transformVector3(new f(0,0,-1)),up:e.transformVector3(new f(0,1,0)),side:e.transformVector3(new f(1,0,0))}},ot.prototype.createRotationMatrix=function(n,i,r){var u=t.createRotationZ(n),f=t.createRotationX(-i),e=t.createRotationY(r);return u.multiply(f.multiply(e))},g.StreetsidePanoramaExists=!0,st.prototype={hasParent:function(){return this.levelOfDetail>0},getParent:function(){if(!this.hasParent())throw"0 level does not have a parent";return new st(this.levelOfDetail-1,this.x>>1,this.y>>1,this.faceName)},getChildren:function(){var n=this.x<<1,t=this.y<<1;return[new st(this.levelOfDetail+1,n,t,this.faceName),new st(this.levelOfDetail+1,n+1,t,this.faceName),new st(this.levelOfDetail+1,n,t+1,this.faceName),new st(this.levelOfDetail+1,n+1,t+1,this.faceName)]},isChildOf:function(n){if(this.levelOfDetail<n.levelOfDetail)return!1;var t=this.levelOfDetail-n.levelOfDetail;return this.x>>t===n.x&&this.y>>t===n.y},equals:function(n){return this.x===n.x&&this.y===n.y&&this.levelOfDetail===this.levelOfDetail},toString:function(){return"("+this.x+","+this.y+","+this.levelOfDetail+")"}},dt.prototype.getGeometry=function(){return this._geometry},h(nr,dt),h(tr,dt),gt.prototype={getTileSize:function(){return this._worldConfiguration.source.tileSize},getMinimumLod:function(){return this._minimumLod},getMaximumLod:function(){return this._maximumLod},getViewElements:function(n,t,i,r){function h(t,i,r,e,o,s){for(var y=n._tileOverlap,p=[],b=r.length,h,a,v,c,w,l=0;l<b;l++)h=r[l],p.push(new u(y+h.x*o,y+h.y*s,h.z,h.w));a=new st(e.lod,i.x,i.y,e.faceName),e.getFullTransforms?(v=e.datasource.getElementTransform(a),c=e.datasource.getTileSize(),i=[new u(0,c,0,1),new u(0,0,0,1),new u(c,0,0,1),new u(c,c,0,1)]):v=e.datasource.getFaceTransform(1,f),w=new gr(i,p,v,e.tileSource,a,o,s),t[a.id]=w}var e,f,o,s;if(i<n._minimumLod||i>n._maximumLod)return null;if(n._viewElementsByLod[i])return n._viewElementsByLod[i];for(n._viewElementsByLod[i]={},e=0;e<n._faceNames.length;e++)f=n._faceNames[e],o=n._worldConfiguration.source,o&&o[f]&&(s={getFullTransforms:r,datasource:n,tileSource:o[f].tileSource,lod:i,faceName:f},t(h,s));return n._viewElementsByLod[i]},getFaceTransform:function(i,r){var f=t.createTranslation(-.5,-.5,0).multiply(t.createScale(1/i,1/i,1)),e=.5,u;switch(r){case"frontFace":u=t.createTranslation(0,0,-e).multiply(f);break;case"backFace":u=t.createTranslation(0,0,e).multiply(t.createRotationY(n.degreesToRadians(180)).multiply(f));break;case"leftFace":u=t.createTranslation(-e,0,0).multiply(t.createRotationY(n.degreesToRadians(90)).multiply(f));break;case"rightFace":u=t.createTranslation(e,0,0).multiply(t.createRotationY(n.degreesToRadians(-90)).multiply(f));break;case"topFace":u=t.createTranslation(0,e,0).multiply(t.createRotationX(n.degreesToRadians(90)).multiply(f));break;case"bottomFace":u=t.createTranslation(0,-e,0).multiply(t.createRotationX(n.degreesToRadians(-90)).multiply(f));break;default:throw"unexpected cube face name";}return u},covertToScreenSpace:function(n,t,r,u){for(var h=n.length,l=t,c=new Array(h),o=i._halfCube,f,s,e=0;e<h;++e)f=n[e],s=f.w,f.x=(f.x/s*o+o)*r,f.y=u-(f.y/s*o+o)*u,f.z=f.z/s,c[e]=f;return new fi(c,l)},getElementTransform:function(n){var r=Math.pow(2,this._maximumLod-n.levelOfDetail),u=1,e=this._baseImageWidth/r,i=this._baseImageHeight/r,o=t.createScale(u,u,1),s=n.x*this._tileWidth,v=this._tileHeight,f=n.y*this._tileHeight+this._tileHeight,h=f<i?this._tileHeight:this._tileHeight-(f-i),c=i-(h+n.y*this._tileHeight),l=t.createTranslation(-this._tileOverlap,-this._tileOverlap,0),a=t.createTranslation(s,c,0);return this.getFaceTransform(e,n.faceName).multiply(o.multiply(a.multiply(l)))}},h(ir,gt),h(rr,gt);var nu=function(n){this.getTileUrl=function(t,i,r){return n+r+"/"+t+"_"+i+".jpg"}},ur=function(n,t){this.getTileUrl=function(i,r,u){return n()+t+"/"+u+"/"+i+"_"+r+".jpg"}},tu=function(n,t,i,u,f,e){var o=Math.ceil(Math.log(Math.max(t,i))/Math.LN2),h=o-f,s=Math.ceil(Math.log(u)/Math.LN2),c=t/Math.pow(2,o),l=i/Math.pow(2,o);this.getTileUrl=function(t,i,u){var o=u-h,a,v;return o>f||o<=f-e?null:(a=Math.ceil(Math.pow(2,u-s)*c),v=Math.ceil(Math.pow(2,u-s)*l),r.partialDotNetStringFormat(n,o,t,i))}};var yi={fromTileId:function(n,t){var e=1,r;t&&(e=0);var i="",u=n.x,f=n.y;for(r=0;r<n.levelOfDetail;r++)i=((u&1)+2*(f&1)).toString()+i,u>>=1,f>>=1;return i},isInBounds:function(n){if(n.x<0||n.y<0)return!1;var t=1<<n.levelOfDetail;return n.x>=t||n.y>=t?!1:!0}},ru=function(n){var u=this,t;u.lastAttribution=null;var l=['<div id="attributionControl" class="panoramaAttributionControl panoramaAttributionControlContainer" >','<a id="icon_anchor" class="panoramaAttributionControl">','<div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="by_icon"><\/div>','<div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="nc_icon"><\/div>','<div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="nd_icon"><\/div>','<div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="sa_icon"><\/div>','<div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="pd_icon"><\/div><\/a>','<div class="panoramaAttributionControl  panoramaAttributionControlIcon" id="copyright_icon"><\/div>','<a class="panoramaAttributionControl" id="authorTextAnchor" href=""><span class="panoramaAttributionControl panoramaAttributionControlText"  id="authorText"><\/span><\/a>','<span class="panoramaAttributionControl panoramaAttributionControlText"  id="authorTextNoAnchor"><\/span>','<span class="panoramaAttributionControl panoramaAttributionControlText" id="attributionDash">&ndash;<\/span>','<span id="publisherText"class="panoramaAttributionControl panoramaAttributionControlText" ><\/span>',"<\/div>"].join(" "),c="$$$$",s=document.createElement("div");n.appendChild(s),typeof MSApp=="object"&&MSApp.execUnsafeLocalFunction?MSApp.execUnsafeLocalFunction(function(){s.innerHTML=l}):s.innerHTML=l,n.removeChild(s),t=s.firstChild,n.appendChild(t);var f=function(n){if(!n[c+"displayValue"]){var t=n.style.display||window.getComputedStyle(n,null).getPropertyValue("display");n[c+"displayValue"]}r.css(n,{display:"none"})},e=function(n){var t=n[c+"displayValue"]||(n.tagName==="A"||n.tagName==="SPAN"?"inline":"inline-block");r.css(n,{display:t})},i=function(n,t){return t||(t=document),t.querySelector(n)},o=function(n,t){n.innerHTML=t};r.css(t,{display:"block"}),f(t);var a=["pd_icon","by_icon","sa_icon","nc_icon","nd_icon","copyright_icon"],h={publicDomain:{pattern:"/publicdomain/",text:"This work is identified as Public Domain.",url:"http://creativecommons.org/licenses/publicdomain/",iconsToShow:["pd_icon"]},by:{pattern:"/by/",text:"This work is licensed to the public under the Creative Commons Attribution license.",url:"http://creativecommons.org/licenses/by/3.0/",iconsToShow:["by_icon"]},bySa:{pattern:"/by-sa/",text:"This work is licensed to the public under the Creative Commons Attribution-ShareAlike license.",url:"http://creativecommons.org/licenses/by-sa/3.0/",iconsToShow:["by_icon","sa_icon"]},byNd:{pattern:"/by-nd/",text:"This work is licensed to the public under the Creative Commons Attribution-NoDerivatives license.",url:"http://creativecommons.org/licenses/by-nd/3.0/",iconsToShow:["by_icon","nd_icon"]},byNc:{pattern:"/by-nc/",text:"This work is licensed to the public under the Creative Commons Attribution-Non-commercial license.",url:"http://creativecommons.org/licenses/by-nc/3.0/",iconsToShow:["by_icon","nc_icon"]},byNcSa:{pattern:"/by-nc-sa/",text:"This work is licensed to the public under the Creative Commons Attribution-Non-commercial-ShareAlike license.",url:"http://creativecommons.org/licenses/by-nc-sa/3.0/",iconsToShow:["by_icon","nc_icon","sa_icon"]},byNcNd:{pattern:"/by-nc-nd/",text:"This work is licensed to the public under the Creative Commons Attribution-Non-commercial-NoDerivatives license.",url:"http://creativecommons.org/licenses/by-nc-nd/3.0/",iconsToShow:["by_icon","nc_icon","nd_icon"]},copyright:{pattern:"",text:"This work is copyrighted.",url:"",iconsToShow:["copyright_icon"]}},v=function(){f(t)},y=function(n){var c,u,l,r,s=h.copyright;for(f(t),r=i("#publisherText",t),f(r),o(r,""),r=i("#authorText",t),f(r),o(r,""),r=i("#authorTextAnchor",t),f(r),r.title="",r.href="",r=i("#authorTextNoAnchor",t),f(r),o(r,""),r=i("#attributionDash",t),f(r),u=0;u<a.length;++u)r=i("#"+a[u],t),f(r);r=i("#icon_anchor",t),r.href="",r.title="";for(c in h)if(h.hasOwnProperty(c)&&n&&n.licenseUrl&&n.licenseUrl.indexOf(h[c].pattern)!=-1){s=h[c];break}for(u=0;u<s.iconsToShow.length;++u)l=s.iconsToShow[u],r=i("#"+l,t),e(r);r=i("#icon_anchor",t),r.title=s.text,r.href=s.url||n.attributionUrl,!n.author&&n.publisher?(r=i("#publisherText",t),f(r),o(r,""),n.attributionUrl?(r=i("#authorText",t),e(r),o(r,n.publisher),r=i("#authorTextAnchor",t),e(r),r.href=n.attributionUrl,r.title=n.attributionUrl):(r=i("#authorTextNoAnchor",t),e(r),o(r,n.publisher))):(n.publisher?(r=i("#publisherText",t),e(r),o(r,n.publisher),r=i("#attributionDash",t),e(r)):(r=i("#publisherText",t),f(r),o(r,"")),n.author&&(n.attributionUrl?(r=i("#authorText",t),e(r),o(r,n.author),r=i("#authorTextAnchor",t),e(r),r.href=n.attributionUrl,r.title=n.attributionUrl):(r=i("#authorTextNoAnchor",t),e(r),o(r,n.author)))),e(t)};u.setAttribution=function(n){(u.lastAttribution!=null&&n.author===u.lastAttribution.author&&n.publisher===u.lastAttribution.publisher&&n.attributionUrl===u.lastAttribution.attributionUrl&&n.licenseUrl===u.lastAttribution.licenseUrl||u.lastAttribution===null)&&(y(n),u.lastAttribution=n)},u.clearAttrubution=function(){u.lastAttribution=null,v()},u.dispose=function(){t&&t.parentNode&&(t.parentNode.removeChild(t),t=null)}},uu=function(t,i){function ei(n,t){arguments.length==1&&arguments[0]&&arguments[0].width&&(t=arguments[0].height,n=arguments[0].width),r.css(c,{width:n+"px",height:t+"px"}),r.css(l,{width:n+"px",height:t+"px"}),v.setViewportSize(n,t),a.setViewport(new et(n,t,a.getViewport().getNearDistance(),a.getViewport().getFarDistance())),p.setViewChanged(!0)}function pt(){return u[s].getInteractionController().getPitch()}function wt(n,t,i){u[s].getInteractionController().setViewTarget(n,null,null,t,i)}function bt(){return u[s].getInteractionController().getHeading()}function kt(n,t,i){u[s].getInteractionController().setViewTarget(null,n,null,t,i)}function tr(){return u[s].getInteractionController().getVerticalFov()}function ir(n,t,i){u[s].getInteractionController().setViewTarget(null,null,n,t,i)}function oi(n){u[s].getInteractionController().zoomIn(n)}function si(n){u[s].getInteractionController().zoomOut(n)}function dt(){var n,e,t;if(!ri){if(n=window.stats,n!==undefined&&n.begin(),it.hasBlockingDownload()){at&&(ii=ui(dt));return}if(ht&&ht.control)e=ht.control(e,vt?ft.getQueuedEvents():[]);else return;var o=e.getPose(),h=this.prevCameraMoving?.1:1,i=ft.userCurrentlyInteracting(),s=this.prevPose!=null&&!this.prevPose.isFuzzyEqualTo(o,h),c=1e3,r=(new Date).valueOf();i?this.userInteractingTime=null:this.prevUserInteracting&&(this.userInteractingTime==null&&(this.userInteractingTime=r+c),this.userInteractingTime>r?i=!0:this.userInteractingTime=null);var u=i||s,l=u!==this.prevUseLowerFidelity,f=l||u||it.currentlyDownloading()||!this.prevPose.isFuzzyEqualTo(o,.0001),a=500;f?this.doWorkTime=null:this.prevDoWorkThisFrame&&(this.doWorkTime==null&&(this.doWorkTime=r+a),this.doWorkTime>r?f=!0:this.doWorkTime=null),this.prevPose=o,this.prevUserInteracting=i,this.prevCameraMoving=s,this.prevUseLowerFidelity=u,t=!0,(f||this.prevDoWorkThisFrame)&&(t=p.RenderFrame(u)),this.prevDoWorkThisFrame=f||!t,t&&ct!==null&&(gt.viewChangeEndEvent.fire(ct),ct=null),(at||!t)&&ui(dt),n!==undefined&&n.end()}}function rr(){for(var i=f.dataSources,r=i.length,n,t=0;t<r;t++)n=i[t],s=s||n.getDataSourceName(),u[n.getDataSourceName()]=n,u.push(n)}function ur(){var n=u[s].getInteractionController();n.viewChangeEvent.addEventListener(hi),n.viewChangeEndEvent.addEventListener(ci)}function fr(){var n=u[s].getInteractionController();n.viewChangeEvent.removeEventListener(hi),n.viewChangeEndEvent.removeEventListener(ci)}function hi(n){gt.viewChangeEvent.fire(n)}function ci(n){ct=n}function er(n,t){var i={width:n+"px",height:t+"px",position:"absolute",backgroundColor:"rgba(0,0,0,1)",direction:"ltr",overflow:"hidden",tabIndex:0,"-ms-touch-action":"none"},u={width:n+"px",height:t+"px",position:"absolute",backgroundColor:"rgba(0,0,0,0.01)",webkitTapHighlightColor:"rgba(0,0,0,1)",tabIndex:0,zIndex:1,"-ms-touch-action":"none"};f.top&&(i.top=f.top+"px",u.top=f.top+"px"),f.left&&(i.left=f.left+"px",u.left=f.left+"px"),r.css(c,i),r.css(l,u)}function sr(){var n=.26179938779914941,t=.43633231299858238;rt(wi,y,"sivZoomInButton","+",65,20,function(n){h(n),oi(!0)},1),rt(bi,y,"sivZoomOutButton","-",20,20,function(n){h(n),si(!0)},2),rt(gi,y,"sivPitchUpButton","^",42,85,function(t){h(t),wt(pt()+n,!0,null)},5),rt(ki,y,"sivHeadingLeftButton","<",65,130,function(n){h(n),kt(bt()-t,!0,null)},3),rt(di,y,"sivHeadingRightButton",">",20,130,function(n){h(n),kt(bt()+t,!0,null)},4),rt(nr,y,"sivPitchDownButton","v",42,170,function(t){h(t),wt(pt()-n,!0,null)},6),y.type="text/css",l.appendChild(y)}function rt(n,t,i,u,f,e,o,s){t.innerHTML+=" ."+i+" { width: 35px; height: 35px; position: absolute; right: "+f+"px; top: "+e+"px; z-index: 777; tabIndex: "+s+" }",n.id=i,n.innerHTML=u,n.className=i,r.bind(n,"touchend",o,null),r.bind(n,"touchstart",h,null),r.bind(n,"touchend",h,null),r.bind(n,"touchcancel",h,null),r.bind(n,"click",o,null),r.bind(n,"dblclick",h,null),l.appendChild(n)}function h(n){n.stopPropagation(),n.stopImmediatePropagation(),n.preventDefault()}function hr(){var n=f.renderer,t;n=n?n.toLowerCase():"";switch(n.toLowerCase()){case"webgl":if(!ut("webgl"))throw"WebGL is not supported";break;case"css3d":if(!ut("css3d"))throw"CSS3D is not supported";break;case"canvas2d":if(!ut("canvas2d"))throw"Canvas is not supported";break;default:if(!ut("webgl")&&!ut("css3d")&&!ut("canvas2d"))throw"Could not create webgl, css3d or canvas renderers: "+n;}t=d.debugEnabled?{r:.4,g:.4,b:.4,a:1}:f.backgroundColor,v&&t&&v.setClearColor(t)}function ut(n){try{switch(n){case"webgl":v=new nt(c,k,tt),ti=!0;break;case"css3d":v=new o(c,k,tt);break;case"canvas2d":v=new w(c,k,tt)}}catch(t){return!1}return v!=null}function lr(){var t,n;if(f.dataSources)for(t=u.length,n=0;n<t;n++)ai.add(u[n].getWorldConfiguration());else throw"expected worldConfiguration property passed in the options object";}function ar(){!f.hideAttribution&&f.worldConfiguration&&f.worldConfiguration.source&&f.worldConfiguration.source.attribution&&(st=new ru(t),st.setAttribution(f.worldConfiguration.source.attribution)),f.worldConfiguration&&f.worldConfiguration.source&&f.worldConfiguration.source.attribution&&li(f.worldConfiguration.source.attribution)}function yr(){for(var i=u.length,n,t=0;t<i;t++)n=u[t],n.createController&&(ht=n.createController(n.worldConfiguration.source,a,a.getCameraParameters()),n.outputMultiLODTiles!=null&&(g.outputMultiLODTiles=n.outputMultiLODTiles),n.scanConvertSize!=null&&(g.scanConvertSize=n.scanConvertSize))}function wr(){it.customFailFunc&&it.customFailFunc(),f.tileDownloadFailed&&f.tileDownloadFailed(),g.tileDownloadFailed&&g.tileDownloadFailed()}var ft,yt,fi,lt;if(!t)throw"expected div argument";var b="button",gt=this,f=i||{},li=f.attributionChanged||function(){},at=!0,c=document.createElement("div"),l=document.createElement("div"),ti=!1,v=null,ai=new dr,br=[],u=[],s=null,k=f.width||t.offsetWidth,tt=f.height||t.offsetHeight,st=null,ht=null,ii,vt=!0,ri=!1,vi=1e-5,yi=4,pi=new et(k,tt,vi,yi),a=null,it=null,p=null,ct=null,wi=document.createElement(b),bi=document.createElement(b),ki=document.createElement(b),di=document.createElement(b),gi=document.createElement(b),nr=document.createElement(b),y=document.createElement("style");for(rr(),er(k,tt),hr(),lr(),ar(),t.appendChild(c),t.appendChild(l),sr(),ft=new pr(l,function(){}),ft.enable(),it=new kr(ti,wr,f.tileDownloadSucceeded),yt=null,fi=u.length,lt=0;lt<fi;lt++){yt=u[lt].getInitialCameraParams();break}a=new vr(pi,yt),p=new cr(v,u,a,it),ei(k,tt),yr(),this.viewChangeEvent=new ni,this.viewChangeEndEvent=new ni,this.removeDataSource=function(n,t,i){if(!n||u[n]===undefined){r.log(n+" was not found in the list of active datasources");return}p.registerDataSourceForRemoval(n,t,function(n){r.deleteFromArray(u,function(t){return t.getDataSourceName()==n}),i(n)})},this.addDataSource=function(n,t,i,r){p.registerDataSourceForAdd(n,i,function(n){u.push(n),r(n)})},this.dispose=function(){ft.disable(),c.parentNode&&c.parentNode.removeChild(c),l.parentNode&&l.parentNode.removeChild(l),st&&st.dispose(),at=!1,ri=!0,fr(),or(ii)},this.setViewportSize=ei,this.getViewportSize=function(){return{width:a.getViewport().getWidth(),height:a.getViewport().getHeight()}},this.getView=function(){return u[s].getInteractionController().getView()},this.setView=function(n,t,i,r,f){u[s].getInteractionController().setViewTarget(n,t,i,r,f)},this.getPitch=pt,this.setPitch=wt,this.getHeading=bt,this.setHeading=kt,this.getBounds=function(){return u[s].getInteractionController().getBounds()},this.getVerticalFov=tr,this.setVerticalFov=ir,this.zoomIn=oi,this.zoomOut=si,this.getIsInteractive=function(){return vt},this.setIsInteractive=function(n){vt=n},this.setFocus=function(){document.getElementById("focusElement").focus()},this.testTransition=function(){var t=u[0].getDataSourceName(),i;p.registerDataSourceForRemoval(t,e.TYPE.FadeOut,function(){alert("faded out "+t)}),i=new ot("http://ecn.t{subdomain}.tiles.virtualearth.net/tiles/hs{quadkey}.jpg?g=753&n=z","0000013223301310",n.degreesToRadians(0),n.degreesToRadians(0)),p.registerDataSourceForAdd(i,e.TYPE.FadeOut,function(){alert("new ds is in! ")})},ur(),ui(dt)},fr=window.Microsoft||(window.Microsoft={}),at=fr.ImmersiveViewer||(fr.ImmersiveViewer={});at.SharedImmersiveViewer=uu,at.PhotosynthSivDataSource=lt,at.StreetsideSivDataSource=ot,at.JsonDownloadFailedError=vi,at.JsonMalformedError=kt,at.Utils=r,at.DebugHelper=d})()}),window.JSDownload_skydrivelanding_16=1